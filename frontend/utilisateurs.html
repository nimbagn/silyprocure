<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestion des Utilisateurs - SilyProcure</title>
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="css/animations.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" integrity="sha512-iecdLmaskl7CVkqkXNQ/ZH/XLlvWZOJyj7Yy7tcenmpD1ypASozpmT/E0iPtmFIB46ZmdtAc9eNBvH0H/ZpiBw==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <style>
        /* Styles responsive pour la page utilisateurs */
        .page-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
            padding: 1.5rem 2rem;
            background: linear-gradient(135deg, rgba(0, 56, 122, 0.05) 0%, rgba(0, 56, 122, 0.02) 100%);
            border-radius: 16px;
            border: 1px solid rgba(0, 56, 122, 0.1);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
            flex-wrap: wrap;
            gap: 1.5rem;
            position: relative;
            overflow: hidden;
        }

        .page-header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 4px;
            height: 100%;
            background: linear-gradient(180deg, var(--color-primary) 0%, var(--color-accent) 100%);
            border-radius: 0 4px 4px 0;
        }

        .page-header h1 {
            font-size: 2rem;
            font-weight: 700;
            margin: 0;
            background: linear-gradient(45deg, var(--color-primary) 0%, var(--color-accent) 100%);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            position: relative;
            z-index: 1;
        }

        .page-header h1 i {
            color: var(--color-accent);
            -webkit-text-fill-color: var(--color-accent);
            font-size: 1.75rem;
        }

        .card-actions {
            display: flex;
            gap: 1rem;
            align-items: center;
        }

        .search-input {
            padding: 0.75rem 1rem;
            border: 2px solid #E0E7FF;
            border-radius: 8px;
            font-size: 0.875rem;
            min-width: 250px;
            transition: var(--transition);
        }

        .search-input:focus {
            outline: none;
            border-color: var(--color-primary);
            box-shadow: 0 0 0 3px rgba(0, 56, 122, 0.1);
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            background: white;
        }

        .data-table thead {
            background: var(--color-primary);
            color: white;
        }

        .data-table th {
            padding: 1rem;
            text-align: left;
            font-weight: 600;
            font-size: 0.875rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .data-table td {
            padding: 1rem;
            border-bottom: 1px solid #E0E7FF;
            font-size: 0.875rem;
        }

        .data-table tr:hover {
            background: var(--color-background-light);
        }

        .data-table tr:last-child td {
            border-bottom: none;
        }

        .data-table .btn-sm {
            margin: 0 0.25rem;
        }

        /* Responsive: Table en cartes sur mobile */
        @media (max-width: 768px) {
            .page-header {
                flex-direction: column;
                align-items: stretch;
            }

            .page-header h1 {
                font-size: 1.5rem;
            }

            .card-actions {
                width: 100%;
            }

            .search-input {
                width: 100%;
                min-width: auto;
            }

            /* Cacher le thead sur mobile */
            .data-table thead {
                display: none;
            }

            /* Transformer les lignes en cartes */
            .data-table tbody tr {
                display: block;
                background: white;
                border: 1px solid #E0E7FF;
                border-radius: 8px;
                margin-bottom: 1rem;
                padding: 1rem;
                box-shadow: var(--shadow-sm);
            }

            .data-table tbody td {
                display: block;
                padding: 0.5rem 0;
                border-bottom: 1px solid #E0E7FF;
                text-align: left !important;
            }

            .data-table tbody td:before {
                content: attr(data-label) ': ';
                font-weight: 600;
                color: var(--color-primary);
                display: inline-block;
                min-width: 120px;
            }

            .data-table tbody td:last-child {
                border-bottom: none;
                padding-top: 1rem;
                display: flex;
                gap: 0.5rem;
                flex-wrap: wrap;
            }

            .data-table tbody td:last-child .btn {
                flex: 1;
                min-width: auto;
            }
        }

        @media (max-width: 600px) {
            .main-content {
                padding: 1rem;
            }

            .card {
                padding: 1rem;
            }

            .card-header {
                flex-direction: column;
                gap: 1rem;
                align-items: stretch;
            }

            .page-header .btn {
                width: 100%;
                justify-content: center;
            }
        }

        /* Tablette: Réduire padding et tailles */
        @media (min-width: 769px) and (max-width: 1024px) {
            .data-table th,
            .data-table td {
                padding: 0.75rem 0.5rem;
                font-size: 0.8125rem;
            }

            .data-table th:nth-child(n+6),
            .data-table td:nth-child(n+6) {
                display: none;
            }
        }
    </style>
</head>
<body>
    <script src="js/auth.js"></script>
    <script src="js/app.js"></script>
    <script src="js/components.js"></script>
    <script src="js/sidebar.js"></script>
    <div class="main-content">
        <div class="page-header">
            <h1><i class="fas fa-users-cog"></i> Gestion des Utilisateurs</h1>
            <button class="btn btn-primary" onclick="showCreateUserModal()">
                <i class="fas fa-plus"></i> Créer un utilisateur
            </button>
        </div>

        <div class="card">
            <div class="card-header">
                <h2 class="card-title">Liste des utilisateurs</h2>
                <div class="card-actions">
                    <input type="text" id="search-users" placeholder="Rechercher..." class="search-input" oninput="filterUsers()">
                </div>
            </div>
            <div class="card-body">
                <div id="loading-indicator" class="loading" style="display: none;">
                    <i class="fas fa-spinner fa-spin"></i> Chargement...
                </div>
                <div id="users-table-container">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Nom</th>
                                <th>Email</th>
                                <th>Téléphone</th>
                                <th>Fonction</th>
                                <th>Département</th>
                                <th>Rôle</th>
                                <th>Statut</th>
                                <th>Date création</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="users-table-body">
                            <tr>
                                <td colspan="9" class="text-center">Chargement...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script>
        let allUsers = [];
        let currentUser = null;

        // Vérifier l'authentification et le rôle admin
        document.addEventListener('DOMContentLoaded', async () => {
            if (!checkAuth()) return;

            const user = JSON.parse(localStorage.getItem('user') || '{}');
            currentUser = user;

            if (user.role !== 'admin') {
                Toast.error('Accès refusé. Seuls les administrateurs peuvent accéder à cette page.');
                setTimeout(() => {
                    window.location.href = 'dashboard.html';
                }, 2000);
                return;
            }

            await loadUsers();
        });

        async function loadUsers() {
            try {
                showLoading();
                const response = await apiCall('/api/utilisateurs');
                
                if (!response || !response.ok) {
                    throw new Error('Erreur lors du chargement des utilisateurs');
                }

                allUsers = await response.json();
                displayUsers(allUsers);
                hideLoading();
            } catch (error) {
                hideLoading();
                Toast.error('Erreur lors du chargement: ' + error.message);
                console.error('Erreur loadUsers:', error);
            }
        }

        function displayUsers(users) {
            const tbody = document.getElementById('users-table-body');
            
            if (users.length === 0) {
                tbody.innerHTML = '<tr><td colspan="9" class="text-center">Aucun utilisateur trouvé</td></tr>';
                return;
            }

            tbody.innerHTML = users.map(user => `
                <tr>
                    <td data-label="Nom"><strong>${user.prenom} ${user.nom}</strong></td>
                    <td data-label="Email">${user.email}</td>
                    <td data-label="Téléphone">${user.telephone || '-'}</td>
                    <td data-label="Fonction">${user.fonction || '-'}</td>
                    <td data-label="Département">${user.departement || '-'}</td>
                    <td data-label="Rôle"><span class="badge badge-${getRoleBadgeClass(user.role)}">${getRoleLabel(user.role)}</span></td>
                    <td data-label="Statut">
                        <span class="badge ${user.actif ? 'badge-success' : 'badge-danger'}">
                            ${user.actif ? 'Actif' : 'Inactif'}
                        </span>
                    </td>
                    <td data-label="Date création">${formatDate(user.date_creation)}</td>
                    <td data-label="Actions">
                        <button class="btn btn-sm btn-secondary" onclick="editUser(${user.id})" title="Modifier">
                            <i class="fas fa-edit"></i>
                        </button>
                        ${user.id !== currentUser.id ? `
                            <button class="btn btn-sm ${user.actif ? 'btn-warning' : 'btn-success'}" 
                                    onclick="toggleUserStatus(${user.id}, ${!user.actif})" 
                                    title="${user.actif ? 'Désactiver' : 'Activer'}">
                                <i class="fas fa-${user.actif ? 'ban' : 'check'}"></i>
                            </button>
                        ` : ''}
                    </td>
                </tr>
            `).join('');
        }

        function getRoleBadgeClass(role) {
            const classes = {
                'admin': 'danger',
                'superviseur': 'warning',
                'acheteur': 'info',
                'approbateur': 'primary',
                'comptable': 'success',
                'viewer': 'secondary'
            };
            return classes[role] || 'secondary';
        }

        function getRoleLabel(role) {
            const labels = {
                'admin': 'Administrateur',
                'superviseur': 'Superviseur',
                'acheteur': 'Acheteur',
                'approbateur': 'Approbateur',
                'comptable': 'Comptable',
                'viewer': 'Visualiseur'
            };
            return labels[role] || role;
        }

        function filterUsers() {
            const search = document.getElementById('search-users').value.toLowerCase();
            const filtered = allUsers.filter(user => 
                user.nom.toLowerCase().includes(search) ||
                user.prenom.toLowerCase().includes(search) ||
                user.email.toLowerCase().includes(search) ||
                (user.fonction && user.fonction.toLowerCase().includes(search)) ||
                (user.departement && user.departement.toLowerCase().includes(search))
            );
            displayUsers(filtered);
        }

        // Recharger l'affichage lors du redimensionnement
        let resizeTimer;
        window.addEventListener('resize', () => {
            clearTimeout(resizeTimer);
            resizeTimer = setTimeout(() => {
                displayUsers(allUsers.filter(user => {
                    const search = document.getElementById('search-users').value.toLowerCase();
                    return !search || 
                        user.nom.toLowerCase().includes(search) ||
                        user.prenom.toLowerCase().includes(search) ||
                        user.email.toLowerCase().includes(search) ||
                        (user.fonction && user.fonction.toLowerCase().includes(search)) ||
                        (user.departement && user.departement.toLowerCase().includes(search));
                }));
            }, 250);
        });

        function formatDate(dateString) {
            if (!dateString) return '-';
            const date = new Date(dateString);
            return date.toLocaleDateString('fr-FR', { 
                day: '2-digit', 
                month: '2-digit', 
                year: 'numeric' 
            });
        }

        function showCreateUserModal() {
            const content = `
                <form id="create-user-form" onsubmit="handleCreateUser(event)">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="user-nom">Nom *</label>
                            <input type="text" id="user-nom" name="nom" required>
                        </div>
                        <div class="form-group">
                            <label for="user-prenom">Prénom *</label>
                            <input type="text" id="user-prenom" name="prenom" required>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="user-email">Email *</label>
                            <input type="email" id="user-email" name="email" required>
                        </div>
                        <div class="form-group">
                            <label for="user-telephone">Téléphone</label>
                            <input type="tel" id="user-telephone" name="telephone" placeholder="+224 612 34 56 78">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="user-fonction">Fonction</label>
                            <input type="text" id="user-fonction" name="fonction" placeholder="Ex: Responsable Achats">
                        </div>
                        <div class="form-group">
                            <label for="user-departement">Département</label>
                            <input type="text" id="user-departement" name="departement" placeholder="Ex: Achats">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="user-role">Rôle *</label>
                            <select id="user-role" name="role" required>
                                <option value="">Sélectionner un rôle</option>
                                <option value="superviseur">Superviseur</option>
                                <option value="acheteur">Acheteur</option>
                                <option value="approbateur">Approbateur</option>
                                <option value="comptable">Comptable</option>
                                <option value="viewer">Visualiseur</option>
                            </select>
                            <small style="color: var(--color-neutral); font-size: 0.75rem;">
                                Note: Le rôle "Administrateur" ne peut être créé que manuellement
                            </small>
                        </div>
                        <div class="form-group">
                            <label for="user-password">Mot de passe *</label>
                            <input type="password" id="user-password" name="mot_de_passe" required minlength="6">
                            <small style="color: var(--color-neutral); font-size: 0.75rem;">
                                Minimum 6 caractères
                            </small>
                        </div>
                    </div>
                </form>
            `;

            const footer = `
                <button class="btn btn-secondary" onclick="Modal.hide('create-user')">Annuler</button>
                <button class="btn btn-primary" onclick="document.getElementById('create-user-form').requestSubmit()">Créer</button>
            `;

            const modal = new Modal('create-user', 'Créer un utilisateur', content, footer);
            modal.show();
        }

        async function handleCreateUser(event) {
            event.preventDefault();
            const form = event.target;
            const formData = new FormData(form);
            const data = Object.fromEntries(formData.entries());

            try {
                showLoading('Création de l\'utilisateur...');
                const response = await apiCall('/api/utilisateurs', {
                    method: 'POST',
                    body: JSON.stringify(data)
                });

                if (!response || !response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || 'Erreur lors de la création');
                }

                Toast.success('Utilisateur créé avec succès');
                Modal.hide('create-user');
                await loadUsers();
            } catch (error) {
                Toast.error('Erreur: ' + error.message);
            } finally {
                hideLoading();
            }
        }

        async function editUser(userId) {
            const user = allUsers.find(u => u.id === userId);
            if (!user) return;

            const content = `
                <form id="edit-user-form" onsubmit="handleUpdateUser(event, ${userId})">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="edit-user-nom">Nom *</label>
                            <input type="text" id="edit-user-nom" name="nom" value="${user.nom}" required>
                        </div>
                        <div class="form-group">
                            <label for="edit-user-prenom">Prénom *</label>
                            <input type="text" id="edit-user-prenom" name="prenom" value="${user.prenom}" required>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="edit-user-email">Email</label>
                            <input type="email" id="edit-user-email" value="${user.email}" disabled style="background: #f0f0f0;">
                            <small style="color: var(--color-neutral); font-size: 0.75rem;">L'email ne peut pas être modifié</small>
                        </div>
                        <div class="form-group">
                            <label for="edit-user-telephone">Téléphone</label>
                            <input type="tel" id="edit-user-telephone" name="telephone" value="${user.telephone || ''}" placeholder="+224 612 34 56 78">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="edit-user-fonction">Fonction</label>
                            <input type="text" id="edit-user-fonction" name="fonction" value="${user.fonction || ''}" placeholder="Ex: Responsable Achats">
                        </div>
                        <div class="form-group">
                            <label for="edit-user-departement">Département</label>
                            <input type="text" id="edit-user-departement" name="departement" value="${user.departement || ''}" placeholder="Ex: Achats">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="edit-user-role">Rôle *</label>
                            <select id="edit-user-role" name="role" required>
                                <option value="admin" ${user.role === 'admin' ? 'selected' : ''}>Administrateur</option>
                                <option value="superviseur" ${user.role === 'superviseur' ? 'selected' : ''}>Superviseur</option>
                                <option value="acheteur" ${user.role === 'acheteur' ? 'selected' : ''}>Acheteur</option>
                                <option value="approbateur" ${user.role === 'approbateur' ? 'selected' : ''}>Approbateur</option>
                                <option value="comptable" ${user.role === 'comptable' ? 'selected' : ''}>Comptable</option>
                                <option value="viewer" ${user.role === 'viewer' ? 'selected' : ''}>Visualiseur</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="edit-user-actif">Statut</label>
                            <select id="edit-user-actif" name="actif">
                                <option value="true" ${user.actif ? 'selected' : ''}>Actif</option>
                                <option value="false" ${!user.actif ? 'selected' : ''}>Inactif</option>
                            </select>
                        </div>
                    </div>
                </form>
            `;

            const footer = `
                <button class="btn btn-secondary" onclick="Modal.hide('edit-user')">Annuler</button>
                <button class="btn btn-primary" onclick="document.getElementById('edit-user-form').requestSubmit()">Enregistrer</button>
            `;

            const modal = new Modal('edit-user', 'Modifier l\'utilisateur', content, footer);
            modal.show();
        }

        async function handleUpdateUser(event, userId) {
            event.preventDefault();
            const form = event.target;
            const formData = new FormData(form);
            const data = Object.fromEntries(formData.entries());
            data.actif = data.actif === 'true';

            try {
                showLoading('Mise à jour...');
                const response = await apiCall(`/api/utilisateurs/${userId}`, {
                    method: 'PUT',
                    body: JSON.stringify(data)
                });

                if (!response || !response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || 'Erreur lors de la mise à jour');
                }

                Toast.success('Utilisateur mis à jour avec succès');
                Modal.hide('edit-user');
                await loadUsers();
            } catch (error) {
                Toast.error('Erreur: ' + error.message);
            } finally {
                hideLoading();
            }
        }

        async function toggleUserStatus(userId, newStatus) {
            const user = allUsers.find(u => u.id === userId);
            if (!user) return;

            const action = newStatus ? 'activer' : 'désactiver';
            if (!confirm(`Êtes-vous sûr de vouloir ${action} l'utilisateur ${user.prenom} ${user.nom} ?`)) {
                return;
            }

            try {
                showLoading(`${action.charAt(0).toUpperCase() + action.slice(1)}...`);
                const response = await apiCall(`/api/utilisateurs/${userId}`, {
                    method: 'PUT',
                    body: JSON.stringify({ actif: newStatus })
                });

                if (!response || !response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || 'Erreur lors de la mise à jour');
                }

                Toast.success(`Utilisateur ${action === 'activer' ? 'activé' : 'désactivé'} avec succès`);
                await loadUsers();
            } catch (error) {
                Toast.error('Erreur: ' + error.message);
            } finally {
                hideLoading();
            }
        }

        function showLoading(message = 'Chargement...') {
            const indicator = document.getElementById('loading-indicator');
            if (indicator) {
                indicator.textContent = message;
                indicator.style.display = 'flex';
            }
        }

        function hideLoading() {
            const indicator = document.getElementById('loading-indicator');
            if (indicator) {
                indicator.style.display = 'none';
            }
        }
    </script>
</body>
</html>

