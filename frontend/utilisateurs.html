<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestion des Utilisateurs - SilyProcure</title>
    
    <!-- CSS Charte Graphique Pro Confiance -->
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="css/responsive.css">
    <link rel="stylesheet" href="css/animations.css">
    
        <!-- Tailwind CSS (optimisé pour production) -->
    <link rel="stylesheet" href="css/tailwind.css">
    
    <!-- Font Awesome & Google Fonts -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Dashboard Theme CSS -->
    <link rel="stylesheet" href="css/dashboard-theme.css">
</head>
<body class="h-full flex flex-col">
        <!-- Navbar Moderne selon charte Pro Confiance -->
    <nav class="bg-white border-b-2 border-blue-100 sticky top-0 z-50 shadow-sm" role="navigation" aria-label="Navigation principale">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-16">
                <!-- Logo & Nav Links -->
                <div class="flex items-center">
                    <div class="flex-shrink-0 flex items-center cursor-pointer" onclick="window.location.href='dashboard.html'">
                        <span class="text-2xl font-bold logo-primary">Sily<span class="text-gray-900">Procure</span></span>
                    </div>
                    <nav class="hidden sm:ml-6 sm:flex sm:space-x-1 md:ml-8" aria-label="Menu de navigation">
                        <a href="dashboard.html" class="border-transparent text-neutral-500 hover:border-primary-300 hover:text-primary-700 font-medium inline-flex items-center px-3 sm:px-4 py-2 border-b-2 text-sm transition-colors min-h-[44px] whitespace-nowrap" >
                            <i class="fas fa-chart-line mr-1.5 sm:mr-2 text-xs sm:text-sm" aria-hidden="true"></i>
                            <span>Dashboard</span>
                        </a>
                        <a href="rfq.html" class="border-transparent text-neutral-500 hover:border-primary-300 hover:text-primary-700 font-medium inline-flex items-center px-3 sm:px-4 py-2 border-b-2 text-sm transition-colors min-h-[44px] whitespace-nowrap" >
                            <i class="fas fa-file-contract mr-1.5 sm:mr-2 text-xs sm:text-sm" aria-hidden="true"></i>
                            <span>RFQ</span>
                        </a>
                        <a href="devis.html" class="border-transparent text-neutral-500 hover:border-primary-300 hover:text-primary-700 font-medium inline-flex items-center px-3 sm:px-4 py-2 border-b-2 text-sm transition-colors min-h-[44px] whitespace-nowrap" >
                            <i class="fas fa-file-invoice-dollar mr-1.5 sm:mr-2 text-xs sm:text-sm" aria-hidden="true"></i>
                            <span>Devis</span>
                        </a>
                        <a href="commandes.html" class="border-transparent text-neutral-500 hover:border-primary-300 hover:text-primary-700 font-medium inline-flex items-center px-3 sm:px-4 py-2 border-b-2 text-sm transition-colors min-h-[44px] whitespace-nowrap" >
                            <i class="fas fa-shopping-cart mr-1.5 sm:mr-2 text-xs sm:text-sm" aria-hidden="true"></i>
                            <span>Commandes</span>
                        </a>
                        <a href="entreprises.html" class="border-transparent text-neutral-500 hover:border-primary-300 hover:text-primary-700 font-medium inline-flex items-center px-3 sm:px-4 py-2 border-b-2 text-sm transition-colors min-h-[44px] whitespace-nowrap" >
                            <i class="fas fa-building mr-1.5 sm:mr-2 text-xs sm:text-sm" aria-hidden="true"></i>
                            <span>Entreprises</span>
                        </a>
                    </nav>
                </div>

                <!-- Search Bar & Profile -->
                <div class="flex items-center gap-4">
                    <!-- Global Search -->
                    <div class="hidden lg:block relative text-neutral-500 focus-within:text-primary-600" role="search">
                        <label for="global-search" class="sr-only">Rechercher dans l'application</label>
                        <div class="pointer-events-none absolute inset-y-0 left-0 pl-3 flex items-center">
                            <i class="fas fa-search" aria-hidden="true"></i>
                        </div>
                        <input id="global-search" class="block w-64 bg-blue-50 py-2.5 pl-10 pr-4 border border-blue-200 rounded-full leading-5 text-neutral-700 placeholder-neutral-400 focus:outline-none focus:bg-white focus:ring-2 focus:ring-primary-500 focus:border-primary-500 sm:text-sm transition duration-150 ease-in-out min-h-[44px]" placeholder="Rechercher..." type="search" aria-label="Rechercher">
                    </div>

                    <!-- Notifications -->
                    <button class="relative p-2.5 text-neutral-500 hover:text-primary-600 transition-colors rounded-lg hover:bg-blue-50 min-w-[44px] min-h-[44px] flex items-center justify-center" aria-label="Notifications" title="Notifications">
                        <i class="far fa-bell text-xl" aria-hidden="true"></i>
                        <span class="absolute top-2 right-2 block h-2.5 w-2.5 rounded-full bg-red-500 ring-2 ring-white" aria-hidden="true"></span>
                    </button>

                    <!-- Profile Dropdown -->
                    <div class="relative flex items-center gap-3">
                        <div class="h-10 w-10 rounded-full bg-primary-100 flex items-center justify-center text-primary-700 font-bold border-2 border-primary-200 shadow-sm" aria-label="Profil utilisateur">
                            <span id="user-initials">U</span>
                        </div>
                        <span id="user-name" class="hidden md:block text-sm font-semibold text-neutral-700 min-w-[120px]">Chargement...</span>
                        <button onclick="logout()" class="ml-1 text-xs text-red-600 hover:text-red-700 border border-red-200 rounded-lg px-3 py-2 hover:bg-red-50 transition min-h-[44px] flex items-center gap-1.5" aria-label="Déconnexion" title="Déconnexion">
                            <i class="fas fa-sign-out-alt" aria-hidden="true"></i>
                            <span class="hidden lg:inline">Déconnexion</span>
                        </button>
                    </div>
                    
                    <!-- Menu mobile -->
                    <div class="sm:hidden ml-2">
                        <button id="mobile-menu-button" onclick="toggleMobileMenu()" class="inline-flex items-center justify-center p-2.5 rounded-lg text-neutral-500 hover:text-primary-600 hover:bg-blue-50 focus:outline-none focus:ring-2 focus:ring-inset focus:ring-primary-500 min-w-[44px] min-h-[44px]" aria-expanded="false" aria-label="Menu principal" aria-controls="mobile-menu">
                            <i class="fas fa-bars text-xl"></i>
                        </button>
                    </div>
                </div>
            </div>
            <!-- Menu mobile déroulant -->
            <div id="mobile-menu" class="hidden sm:hidden border-t-2 border-blue-100 bg-white shadow-lg">
                <div class="px-4 pt-3 pb-4 space-y-1">
                    <a href="dashboard.html" class="border-transparent text-neutral-700 hover:bg-blue-50 hover:text-primary-700 hover:border-l-4 hover:border-primary-300 font-medium block px-4 py-3 rounded-lg text-base transition-all min-h-[44px] flex items-center gap-3">
                        <i class="fas fa-chart-line text-neutral-500" aria-hidden="true"></i>
                        <span>Dashboard</span>
                    </a>
                    <a href="rfq.html" class="border-transparent text-neutral-700 hover:bg-blue-50 hover:text-primary-700 hover:border-l-4 hover:border-primary-300 font-medium block px-4 py-3 rounded-lg text-base transition-all min-h-[44px] flex items-center gap-3">
                        <i class="fas fa-file-contract text-neutral-500" aria-hidden="true"></i>
                        <span>RFQ</span>
                    </a>
                    <a href="devis.html" class="border-transparent text-neutral-700 hover:bg-blue-50 hover:text-primary-700 hover:border-l-4 hover:border-primary-300 font-medium block px-4 py-3 rounded-lg text-base transition-all min-h-[44px] flex items-center gap-3">
                        <i class="fas fa-file-invoice-dollar text-neutral-500" aria-hidden="true"></i>
                        <span>Devis</span>
                    </a>
                    <a href="commandes.html" class="border-transparent text-neutral-700 hover:bg-blue-50 hover:text-primary-700 hover:border-l-4 hover:border-primary-300 font-medium block px-4 py-3 rounded-lg text-base transition-all min-h-[44px] flex items-center gap-3">
                        <i class="fas fa-shopping-cart text-neutral-500" aria-hidden="true"></i>
                        <span>Commandes</span>
                    </a>
                    <a href="entreprises.html" class="border-transparent text-neutral-700 hover:bg-blue-50 hover:text-primary-700 hover:border-l-4 hover:border-primary-300 font-medium block px-4 py-3 rounded-lg text-base transition-all min-h-[44px] flex items-center gap-3">
                        <i class="fas fa-building text-neutral-500" aria-hidden="true"></i>
                        <span>Entreprises</span>
                    </a>
                </div>
            </div>
        </div>
    </nav>

    <script src="js/auth.js"></script>
    <script src="js/app.js"></script>
    <script src="js/components.js?v=20260116"></script>
    <script>window.DISABLE_SIDEBAR = true;</script>
    <script src="js/sidebar.js"></script>
    <script src="js/mobile-menu.js"></script>
    <div class="main-content">
        <div class="page-header">
            <h1><i class="fas fa-users-cog"></i> Gestion des Utilisateurs</h1>
            <button class="btn btn-primary" onclick="showCreateUserModal()">
                <i class="fas fa-plus"></i> Créer un utilisateur
            </button>
        </div>

        <div class="card">
            <div class="card-header">
                <h2 class="card-title">Liste des utilisateurs</h2>
                <div class="card-actions">
                    <input type="text" id="search-users" placeholder="Rechercher..." class="search-input" oninput="filterUsers()">
                </div>
            </div>
            <div class="card-body">
                <div id="loading-indicator" class="loading" style="display: none;">
                    <i class="fas fa-spinner fa-spin"></i> Chargement...
                </div>
                <div id="users-table-container">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Nom</th>
                                <th>Email</th>
                                <th>Téléphone</th>
                                <th>Fonction</th>
                                <th>Département</th>
                                <th>Rôle</th>
                                <th>Statut</th>
                                <th>Date création</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="users-table-body">
                            <tr>
                                <td colspan="9" class="text-center">Chargement...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script>
        let allUsers = [];
        let currentUser = null;

        // Vérifier l'authentification et le rôle admin
        document.addEventListener('DOMContentLoaded', async () => {
            if (!checkAuth()) return;

            const user = JSON.parse(localStorage.getItem('user') || '{}');
            currentUser = user;

            if (user.role !== 'admin') {
                Toast.error('Accès refusé. Seuls les administrateurs peuvent accéder à cette page.');
                setTimeout(() => {
                    window.location.href = 'dashboard.html';
                }, 2000);
                return;
            }

            await loadUsers();
        });

        async function loadUsers() {
            try {
                showLoading();
                const response = await apiCall('/api/utilisateurs');
                
                if (!response || !response.ok) {
                    throw new Error('Erreur lors du chargement des utilisateurs');
                }

                allUsers = await response.json();
                displayUsers(allUsers);
                hideLoading();
            } catch (error) {
                hideLoading();
                Toast.error('Erreur lors du chargement: ' + error.message);
                console.error('Erreur loadUsers:', error);
            }
        }

        function displayUsers(users) {
            const tbody = document.getElementById('users-table-body');
            
            if (users.length === 0) {
                tbody.innerHTML = '<tr><td colspan="9" class="text-center">Aucun utilisateur trouvé</td></tr>';
                return;
            }

            tbody.innerHTML = users.map(user => `
                <tr>
                    <td data-label="Nom"><strong>${user.prenom} ${user.nom}</strong></td>
                    <td data-label="Email">${user.email}</td>
                    <td data-label="Téléphone">${user.telephone || '-'}</td>
                    <td data-label="Fonction">${user.fonction || '-'}</td>
                    <td data-label="Département">${user.departement || '-'}</td>
                    <td data-label="Rôle"><span class="badge badge-${getRoleBadgeClass(user.role)}">${getRoleLabel(user.role)}</span></td>
                    <td data-label="Statut">
                        <span class="badge ${user.actif ? 'badge-success' : 'badge-danger'}">
                            ${user.actif ? 'Actif' : 'Inactif'}
                        </span>
                    </td>
                    <td data-label="Date création">${formatDate(user.date_creation)}</td>
                    <td data-label="Actions">
                        <button class="btn btn-sm btn-secondary" onclick="editUser(${user.id})" title="Modifier">
                            <i class="fas fa-edit"></i>
                        </button>
                        ${user.id !== currentUser.id ? `
                            <button class="btn btn-sm ${user.actif ? 'btn-warning' : 'btn-success'}" 
                                    onclick="toggleUserStatus(${user.id}, ${!user.actif})" 
                                    title="${user.actif ? 'Désactiver' : 'Activer'}">
                                <i class="fas fa-${user.actif ? 'ban' : 'check'}"></i>
                            </button>
                        ` : ''}
                    </td>
                </tr>
            `).join('');
        }

        function getRoleBadgeClass(role) {
            const classes = {
                'admin': 'danger',
                'superviseur': 'warning',
                'acheteur': 'info',
                'approbateur': 'primary',
                'comptable': 'success',
                'viewer': 'secondary'
            };
            return classes[role] || 'secondary';
        }

        function getRoleLabel(role) {
            const labels = {
                'admin': 'Administrateur',
                'superviseur': 'Superviseur',
                'acheteur': 'Acheteur',
                'approbateur': 'Approbateur',
                'comptable': 'Comptable',
                'viewer': 'Visualiseur'
            };
            return labels[role] || role;
        }

        function filterUsers() {
            const search = document.getElementById('search-users').value.toLowerCase();
            const filtered = allUsers.filter(user => 
                user.nom.toLowerCase().includes(search) ||
                user.prenom.toLowerCase().includes(search) ||
                user.email.toLowerCase().includes(search) ||
                (user.fonction && user.fonction.toLowerCase().includes(search)) ||
                (user.departement && user.departement.toLowerCase().includes(search))
            );
            displayUsers(filtered);
        }

        // Recharger l'affichage lors du redimensionnement
        let resizeTimer;
        window.addEventListener('resize', () => {
            clearTimeout(resizeTimer);
            resizeTimer = setTimeout(() => {
                displayUsers(allUsers.filter(user => {
                    const search = document.getElementById('search-users').value.toLowerCase();
                    return !search || 
                        user.nom.toLowerCase().includes(search) ||
                        user.prenom.toLowerCase().includes(search) ||
                        user.email.toLowerCase().includes(search) ||
                        (user.fonction && user.fonction.toLowerCase().includes(search)) ||
                        (user.departement && user.departement.toLowerCase().includes(search));
                }));
            }, 250);
        });

        function formatDate(dateString) {
            if (!dateString) return '-';
            const date = new Date(dateString);
            return date.toLocaleDateString('fr-FR', { 
                day: '2-digit', 
                month: '2-digit', 
                year: 'numeric' 
            });
        }

        function showCreateUserModal() {
            const content = `
                <form id="create-user-form" onsubmit="handleCreateUser(event)">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="user-nom">Nom *</label>
                            <input type="text" id="user-nom" name="nom" required>
                        </div>
                        <div class="form-group">
                            <label for="user-prenom">Prénom *</label>
                            <input type="text" id="user-prenom" name="prenom" required>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="user-email">Email *</label>
                            <input type="email" id="user-email" name="email" required>
                        </div>
                        <div class="form-group">
                            <label for="user-telephone">Téléphone</label>
                            <input type="tel" id="user-telephone" name="telephone" placeholder="+224 612 34 56 78">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="user-fonction">Fonction</label>
                            <input type="text" id="user-fonction" name="fonction" placeholder="Ex: Responsable Achats">
                        </div>
                        <div class="form-group">
                            <label for="user-departement">Département</label>
                            <input type="text" id="user-departement" name="departement" placeholder="Ex: Achats">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="user-role">Rôle *</label>
                            <select id="user-role" name="role" required>
                                <option value="">Sélectionner un rôle</option>
                                <option value="superviseur">Superviseur</option>
                                <option value="acheteur">Acheteur</option>
                                <option value="approbateur">Approbateur</option>
                                <option value="comptable">Comptable</option>
                                <option value="viewer">Visualiseur</option>
                            </select>
                            <small style="color: var(--color-neutral); font-size: 0.75rem;">
                                Note: Le rôle "Administrateur" ne peut être créé que manuellement
                            </small>
                        </div>
                        <div class="form-group">
                            <label for="user-password">Mot de passe *</label>
                            <input type="password" id="user-password" name="mot_de_passe" required minlength="6">
                            <small style="color: var(--color-neutral); font-size: 0.75rem;">
                                Minimum 6 caractères
                            </small>
                        </div>
                    </div>
                </form>
            `;

            const footer = `
                <button class="btn btn-secondary" onclick="Modal.hide('create-user')">Annuler</button>
                <button class="btn btn-primary" onclick="document.getElementById('create-user-form').requestSubmit()">Créer</button>
            `;

            const modal = new Modal('create-user', 'Créer un utilisateur', content, footer);
            modal.show();
        }

        async function handleCreateUser(event) {
            event.preventDefault();
            const form = event.target;
            const formData = new FormData(form);
            const data = Object.fromEntries(formData.entries());

            try {
                showLoading('Création de l\'utilisateur...');
                const response = await apiCall('/api/utilisateurs', {
                    method: 'POST',
                    body: JSON.stringify(data)
                });

                if (!response || !response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || 'Erreur lors de la création');
                }

                Toast.success('Utilisateur créé avec succès');
                Modal.hide('create-user');
                await loadUsers();
            } catch (error) {
                Toast.error('Erreur: ' + error.message);
            } finally {
                hideLoading();
            }
        }

        async function editUser(userId) {
            const user = allUsers.find(u => u.id === userId);
            if (!user) return;

            const content = `
                <form id="edit-user-form" onsubmit="handleUpdateUser(event, ${userId})">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="edit-user-nom">Nom *</label>
                            <input type="text" id="edit-user-nom" name="nom" value="${user.nom}" required>
                        </div>
                        <div class="form-group">
                            <label for="edit-user-prenom">Prénom *</label>
                            <input type="text" id="edit-user-prenom" name="prenom" value="${user.prenom}" required>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="edit-user-email">Email</label>
                            <input type="email" id="edit-user-email" value="${user.email}" disabled style="background: #f0f0f0;">
                            <small style="color: var(--color-neutral); font-size: 0.75rem;">L'email ne peut pas être modifié</small>
                        </div>
                        <div class="form-group">
                            <label for="edit-user-telephone">Téléphone</label>
                            <input type="tel" id="edit-user-telephone" name="telephone" value="${user.telephone || ''}" placeholder="+224 612 34 56 78">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="edit-user-fonction">Fonction</label>
                            <input type="text" id="edit-user-fonction" name="fonction" value="${user.fonction || ''}" placeholder="Ex: Responsable Achats">
                        </div>
                        <div class="form-group">
                            <label for="edit-user-departement">Département</label>
                            <input type="text" id="edit-user-departement" name="departement" value="${user.departement || ''}" placeholder="Ex: Achats">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="edit-user-role">Rôle *</label>
                            <select id="edit-user-role" name="role" required>
                                <option value="admin" ${user.role === 'admin' ? 'selected' : ''}>Administrateur</option>
                                <option value="superviseur" ${user.role === 'superviseur' ? 'selected' : ''}>Superviseur</option>
                                <option value="acheteur" ${user.role === 'acheteur' ? 'selected' : ''}>Acheteur</option>
                                <option value="approbateur" ${user.role === 'approbateur' ? 'selected' : ''}>Approbateur</option>
                                <option value="comptable" ${user.role === 'comptable' ? 'selected' : ''}>Comptable</option>
                                <option value="viewer" ${user.role === 'viewer' ? 'selected' : ''}>Visualiseur</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="edit-user-actif">Statut</label>
                            <select id="edit-user-actif" name="actif">
                                <option value="true" ${user.actif ? 'selected' : ''}>Actif</option>
                                <option value="false" ${!user.actif ? 'selected' : ''}>Inactif</option>
                            </select>
                        </div>
                    </div>
                </form>
            `;

            const footer = `
                <button class="btn btn-secondary" onclick="Modal.hide('edit-user')">Annuler</button>
                <button class="btn btn-primary" onclick="document.getElementById('edit-user-form').requestSubmit()">Enregistrer</button>
            `;

            const modal = new Modal('edit-user', 'Modifier l\'utilisateur', content, footer);
            modal.show();
        }

        async function handleUpdateUser(event, userId) {
            event.preventDefault();
            const form = event.target;
            const formData = new FormData(form);
            const data = Object.fromEntries(formData.entries());
            data.actif = data.actif === 'true';

            try {
                showLoading('Mise à jour...');
                const response = await apiCall(`/api/utilisateurs/${userId}`, {
                    method: 'PUT',
                    body: JSON.stringify(data)
                });

                if (!response || !response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || 'Erreur lors de la mise à jour');
                }

                Toast.success('Utilisateur mis à jour avec succès');
                Modal.hide('edit-user');
                await loadUsers();
            } catch (error) {
                Toast.error('Erreur: ' + error.message);
            } finally {
                hideLoading();
            }
        }

        async function toggleUserStatus(userId, newStatus) {
            const user = allUsers.find(u => u.id === userId);
            if (!user) return;

            const action = newStatus ? 'activer' : 'désactiver';
            if (!confirm(`Êtes-vous sûr de vouloir ${action} l'utilisateur ${user.prenom} ${user.nom} ?`)) {
                return;
            }

            try {
                showLoading(`${action.charAt(0).toUpperCase() + action.slice(1)}...`);
                const response = await apiCall(`/api/utilisateurs/${userId}`, {
                    method: 'PUT',
                    body: JSON.stringify({ actif: newStatus })
                });

                if (!response || !response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || 'Erreur lors de la mise à jour');
                }

                Toast.success(`Utilisateur ${action === 'activer' ? 'activé' : 'désactivé'} avec succès`);
                await loadUsers();
            } catch (error) {
                Toast.error('Erreur: ' + error.message);
            } finally {
                hideLoading();
            }
        }

        function showLoading(message = 'Chargement...') {
            const indicator = document.getElementById('loading-indicator');
            if (indicator) {
                indicator.textContent = message;
                indicator.style.display = 'flex';
            }
        }

        function hideLoading() {
            const indicator = document.getElementById('loading-indicator');
            if (indicator) {
                indicator.style.display = 'none';
            }
        }
    </script>
</body>
</html>

