<!DOCTYPE html>
<html lang="fr" class="h-full antialiased bg-gray-50">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Carte Interactive - SilyProcure</title>
    
    <!-- CSS Charte Graphique Pro Confiance -->
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="css/responsive.css">
    
        <!-- Tailwind CSS (optimisé pour production) -->
    <link rel="stylesheet" href="css/tailwind.css">

    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>

    <!-- Font Awesome & Google Fonts -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        body { font-family: 'Inter', sans-serif; }
        
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }

        /* Map styling */
        #map {
            height: 100%;
            width: 100%;
            min-height: 600px;
            z-index: 0;
            background: #f8fafc; /* Match page bg to avoid white flash */
        }
        
        /* S'assurer que le conteneur parent a une hauteur */
        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
        }

        /* Custom Marker */
        .custom-marker-icon {
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            border: 3px solid white;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            color: white;
            font-size: 14px;
            transition: transform 0.2s ease;
        }
        .custom-marker-icon:hover {
            transform: scale(1.1);
            z-index: 1000 !important;
        }

        /* Leaflet Popup Customization to match Tailwind Theme */
        .leaflet-popup-content-wrapper {
            background: white;
            border-radius: 12px;
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1), 0 8px 10px -6px rgba(0, 0, 0, 0.1);
            padding: 0;
            overflow: hidden;
        }
        .leaflet-popup-content {
            margin: 0;
            line-height: 1.5;
        }
        .leaflet-popup-tip {
            background: white;
        }
        .leaflet-container a.leaflet-popup-close-button {
            top: 10px;
            right: 10px;
            color: #94a3b8;
            padding: 4px;
            font-size: 18px;
        }
        .leaflet-container a.leaflet-popup-close-button:hover {
            color: #ef4444;
        }

        /* Toggles */
        .toggle-checkbox {
            position: absolute;
            opacity: 0;
            cursor: pointer;
            height: 0;
            width: 0;
        }
        .toggle-label {
            position: relative;
            width: 44px;
            height: 24px;
            background-color: #cbd5e1;
            border-radius: 9999px;
            transition: background-color 0.2s ease-in;
        }
        .toggle-dot {
            position: absolute;
            top: 2px;
            left: 2px;
            background-color: white;
            border-radius: 50%;
            height: 20px;
            width: 20px;
            transition: transform 0.2s ease-in;
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
        }
        .toggle-checkbox:checked + .toggle-label {
            background-color: #3b82f6;
        }
        .toggle-checkbox:checked + .toggle-label .toggle-dot {
            transform: translateX(20px);
        }
        
        nav[aria-label="Menu de navigation"] {
            align-items: center;
            flex-wrap: nowrap;
            overflow-x: auto;
            overflow-y: hidden;
            scrollbar-width: none;
            -ms-overflow-style: none;
        }
        
        nav[aria-label="Menu de navigation"]::-webkit-scrollbar {
            display: none;
        }
        
        nav[aria-label="Menu de navigation"] a {
            position: relative;
            white-space: nowrap;
            flex-shrink: 0;
        }
        
        @media (max-width: 639px) {
            nav[aria-label="Menu de navigation"] {
                display: none !important;
            }
        }
        
        /* Menu mobile amélioré */
        #mobile-menu {
            animation: slideDown 0.3s ease-out;
        }
        
        #mobile-menu.hidden {
            display: none !important;
        }
        
        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
    </style>
</head>
<body class="h-full flex flex-col overflow-hidden">

    <!-- Navbar Moderne -->
    <nav class="bg-white border-b-2 border-blue-100 sticky top-0 z-50 shadow-sm" role="navigation" aria-label="Navigation principale">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-16">
                <!-- Logo & Nav Links -->
                <div class="flex items-center">
                    <div class="flex-shrink-0 flex items-center cursor-pointer" onclick="window.location.href='dashboard.html'">
                        <span class="text-2xl font-bold text-primary-600">Sily<span class="text-gray-900">Procure</span></span>
                    </div>
                    <nav class="hidden sm:flex sm:ml-6 sm:space-x-1 md:ml-8" aria-label="Menu de navigation">
                        <a href="dashboard.html" class="border-transparent text-neutral-500 hover:border-primary-300 hover:text-primary-700 inline-flex items-center px-3 sm:px-4 py-2 border-b-2 text-sm font-medium transition-colors min-h-[44px] whitespace-nowrap">
                            <i class="fas fa-chart-line mr-1.5 sm:mr-2 text-xs sm:text-sm" aria-hidden="true"></i>
                            <span>Dashboard</span>
                        </a>
                        <a href="rfq.html" class="border-transparent text-neutral-500 hover:border-primary-300 hover:text-primary-700 inline-flex items-center px-3 sm:px-4 py-2 border-b-2 text-sm font-medium transition-colors min-h-[44px] whitespace-nowrap">
                            <i class="fas fa-file-contract mr-1.5 sm:mr-2 text-xs sm:text-sm" aria-hidden="true"></i>
                            <span>RFQ</span>
                        </a>
                        <a href="devis.html" class="border-transparent text-neutral-500 hover:border-primary-300 hover:text-primary-700 inline-flex items-center px-3 sm:px-4 py-2 border-b-2 text-sm font-medium transition-colors min-h-[44px] whitespace-nowrap">
                            <i class="fas fa-file-invoice-dollar mr-1.5 sm:mr-2 text-xs sm:text-sm" aria-hidden="true"></i>
                            <span>Devis</span>
                        </a>
                        <a href="commandes.html" class="border-transparent text-neutral-500 hover:border-primary-300 hover:text-primary-700 inline-flex items-center px-3 sm:px-4 py-2 border-b-2 text-sm font-medium transition-colors min-h-[44px] whitespace-nowrap">
                            <i class="fas fa-shopping-cart mr-1.5 sm:mr-2 text-xs sm:text-sm" aria-hidden="true"></i>
                            <span>Commandes</span>
                        </a>
                        <a href="entreprises.html" class="border-transparent text-neutral-500 hover:border-primary-300 hover:text-primary-700 inline-flex items-center px-3 sm:px-4 py-2 border-b-2 text-sm font-medium transition-colors min-h-[44px] whitespace-nowrap">
                            <i class="fas fa-building mr-1.5 sm:mr-2 text-xs sm:text-sm" aria-hidden="true"></i>
                            <span>Entreprises</span>
                        </a>
                        <a href="factures.html" class="border-transparent text-neutral-500 hover:border-primary-300 hover:text-primary-700 inline-flex items-center px-3 sm:px-4 py-2 border-b-2 text-sm font-medium transition-colors min-h-[44px] whitespace-nowrap">
                            <i class="fas fa-money-bill-wave mr-1.5 sm:mr-2 text-xs sm:text-sm" aria-hidden="true"></i>
                            <span>Factures</span>
                        </a>
                        <a href="carte.html" class="border-primary-500 text-primary-900 inline-flex items-center px-3 sm:px-4 py-2 border-b-2 text-sm font-semibold min-h-[44px] transition-colors whitespace-nowrap" aria-current="page">
                            <i class="fas fa-map-marked-alt mr-1.5 sm:mr-2 text-xs sm:text-sm" aria-hidden="true"></i>
                            <span>Carte</span>
                        </a>
                    </nav>
                </div>

                <!-- Profile & Mobile Menu -->
                <div class="flex items-center gap-4">
                    <div class="relative flex items-center gap-3">
                        <div class="h-10 w-10 rounded-full bg-primary-100 flex items-center justify-center text-primary-700 font-bold border-2 border-primary-200 shadow-sm">
                            <span id="user-initials">U</span>
                        </div>
                        <span id="user-name" class="hidden md:block text-sm font-semibold text-neutral-700 min-w-[120px]">Chargement...</span>
                        <button onclick="logout()" class="ml-1 text-xs text-red-600 hover:text-red-700 border border-red-200 rounded-lg px-3 py-2 hover:bg-red-50 transition min-h-[44px] flex items-center gap-1.5">
                            <i class="fas fa-sign-out-alt" aria-hidden="true"></i>
                            <span class="hidden lg:inline">Déconnexion</span>
                        </button>
                    </div>
                    
                    <!-- Menu mobile -->
                    <div class="sm:hidden ml-2">
                        <button id="mobile-menu-button" onclick="toggleMobileMenu()" class="inline-flex items-center justify-center p-2.5 rounded-lg text-neutral-500 hover:text-primary-600 hover:bg-blue-50 focus:outline-none focus:ring-2 focus:ring-inset focus:ring-primary-500 min-w-[44px] min-h-[44px]">
                            <i class="fas fa-bars text-xl"></i>
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Menu mobile déroulant -->
            <div id="mobile-menu" class="hidden sm:hidden border-t-2 border-blue-100 bg-white shadow-lg">
                <div class="px-4 pt-3 pb-4 space-y-1">
                    <a href="dashboard.html" class="border-transparent text-neutral-700 hover:bg-blue-50 hover:text-primary-700 hover:border-l-4 hover:border-primary-300 block px-4 py-3 rounded-lg text-base font-medium transition-all min-h-[44px] flex items-center gap-3">
                        <i class="fas fa-chart-line text-neutral-500" aria-hidden="true"></i>
                        <span>Dashboard</span>
                    </a>
                    <a href="rfq.html" class="border-transparent text-neutral-700 hover:bg-blue-50 hover:text-primary-700 hover:border-l-4 hover:border-primary-300 block px-4 py-3 rounded-lg text-base font-medium transition-all min-h-[44px] flex items-center gap-3">
                        <i class="fas fa-file-contract text-neutral-500" aria-hidden="true"></i>
                        <span>RFQ</span>
                    </a>
                    <a href="devis.html" class="border-transparent text-neutral-700 hover:bg-blue-50 hover:text-primary-700 hover:border-l-4 hover:border-primary-300 block px-4 py-3 rounded-lg text-base font-medium transition-all min-h-[44px] flex items-center gap-3">
                        <i class="fas fa-file-invoice-dollar text-neutral-500" aria-hidden="true"></i>
                        <span>Devis</span>
                    </a>
                    <a href="commandes.html" class="border-transparent text-neutral-700 hover:bg-blue-50 hover:text-primary-700 hover:border-l-4 hover:border-primary-300 block px-4 py-3 rounded-lg text-base font-medium transition-all min-h-[44px] flex items-center gap-3">
                        <i class="fas fa-shopping-cart text-neutral-500" aria-hidden="true"></i>
                        <span>Commandes</span>
                    </a>
                    <a href="entreprises.html" class="border-transparent text-neutral-700 hover:bg-blue-50 hover:text-primary-700 hover:border-l-4 hover:border-primary-300 block px-4 py-3 rounded-lg text-base font-medium transition-all min-h-[44px] flex items-center gap-3">
                        <i class="fas fa-building text-neutral-500" aria-hidden="true"></i>
                        <span>Entreprises</span>
                    </a>
                    <a href="factures.html" class="border-transparent text-neutral-700 hover:bg-blue-50 hover:text-primary-700 hover:border-l-4 hover:border-primary-300 block px-4 py-3 rounded-lg text-base font-medium transition-all min-h-[44px] flex items-center gap-3">
                        <i class="fas fa-money-bill-wave text-neutral-500" aria-hidden="true"></i>
                        <span>Factures</span>
                    </a>
                    <a href="carte.html" class="bg-gradient-to-r from-blue-50 to-primary-50 border-l-4 border-primary-500 text-primary-700 block px-4 py-3 rounded-lg text-base font-semibold min-h-[44px] flex items-center gap-3 transition-all">
                        <i class="fas fa-map-marked-alt text-primary-600" aria-hidden="true"></i>
                        <span>Carte</span>
                    </a>
                </div>
            </div>
        </div>
    </nav>
        </div>
    </nav>

    <!-- Main Content Area (Full height minus navbar) -->
    <div class="flex-1 flex overflow-hidden relative" style="height: calc(100vh - 64px);">
        
        <!-- Sidebar Control Panel (Floating) -->
        <div class="absolute top-4 left-4 bottom-4 w-80 z-[1000] flex flex-col gap-4 pointer-events-none">
            
            <!-- Header Card -->
            <div class="bg-white/95 backdrop-blur-sm shadow-float rounded-xl p-5 border border-white/50 pointer-events-auto">
                <h1 class="text-lg font-bold text-gray-900 flex items-center gap-2">
                    <i class="fas fa-map-marked-alt text-primary-600"></i> Carte des Tiers
                </h1>
                <p class="text-xs text-gray-500 mt-1">Gérez la logistique et visualisez vos partenaires.</p>
                
                <div class="mt-4 grid grid-cols-2 gap-2">
                    <button onclick="centerOnUser()" class="flex items-center justify-center gap-2 px-3 py-2 bg-gray-50 hover:bg-gray-100 text-gray-700 text-xs font-medium rounded-lg border border-gray-200 transition-colors">
                        <i class="fas fa-crosshairs"></i> Ma position
                    </button>
                    <button onclick="refreshMap()" class="flex items-center justify-center gap-2 px-3 py-2 bg-primary-50 hover:bg-primary-100 text-primary-700 text-xs font-medium rounded-lg border border-primary-200 transition-colors">
                        <i class="fas fa-sync-alt"></i> Actualiser
                    </button>
                </div>
            </div>

            <!-- Filters Card -->
            <div class="bg-white/95 backdrop-blur-sm shadow-float rounded-xl p-5 border border-white/50 flex-1 overflow-y-auto pointer-events-auto">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-sm font-semibold text-gray-900">Filtres</h3>
                    <span class="text-xs bg-gray-100 text-gray-600 px-2 py-0.5 rounded-full" id="marker-count">0 affichés</span>
                </div>

                <div class="space-y-4">
                    <!-- Toggle Item -->
                    <label class="flex items-center justify-between cursor-pointer group">
                        <div class="flex items-center gap-3">
                            <span class="flex h-8 w-8 items-center justify-center rounded-lg bg-blue-50 text-blue-600 group-hover:bg-blue-100 transition-colors">
                                <i class="fas fa-industry text-sm"></i>
                            </span>
                            <span class="text-sm font-medium text-gray-700">Fournisseurs</span>
                        </div>
                        <div class="relative">
                            <input type="checkbox" id="filter-fournisseur" class="toggle-checkbox" checked onchange="updateMap()">
                            <div class="toggle-label"><div class="toggle-dot"></div></div>
                        </div>
                    </label>

                    <!-- Toggle Item -->
                    <label class="flex items-center justify-between cursor-pointer group">
                        <div class="flex items-center gap-3">
                            <span class="flex h-8 w-8 items-center justify-center rounded-lg bg-emerald-50 text-emerald-600 group-hover:bg-emerald-100 transition-colors">
                                <i class="fas fa-building text-sm"></i>
                            </span>
                            <span class="text-sm font-medium text-gray-700">Clients</span>
                        </div>
                        <div class="relative">
                            <input type="checkbox" id="filter-client" class="toggle-checkbox" checked onchange="updateMap()">
                            <div class="toggle-label"><div class="toggle-dot"></div></div>
                        </div>
                    </label>

                    <!-- Toggle Item -->
                    <label class="flex items-center justify-between cursor-pointer group">
                        <div class="flex items-center gap-3">
                            <span class="flex h-8 w-8 items-center justify-center rounded-lg bg-amber-50 text-amber-600 group-hover:bg-amber-100 transition-colors">
                                <i class="fas fa-shopping-cart text-sm"></i>
                            </span>
                            <span class="text-sm font-medium text-gray-700">Acheteurs</span>
                        </div>
                        <div class="relative">
                            <input type="checkbox" id="filter-acheteur" class="toggle-checkbox" checked onchange="updateMap()">
                            <div class="toggle-label"><div class="toggle-dot"></div></div>
                        </div>
                    </label>

                    <!-- Toggle Item -->
                    <label class="flex items-center justify-between cursor-pointer group">
                        <div class="flex items-center gap-3">
                            <span class="flex h-8 w-8 items-center justify-center rounded-lg bg-red-50 text-red-600 group-hover:bg-red-100 transition-colors">
                                <i class="fas fa-truck text-sm"></i>
                            </span>
                            <span class="text-sm font-medium text-gray-700">Transporteurs</span>
                        </div>
                        <div class="relative">
                            <input type="checkbox" id="filter-transporteur" class="toggle-checkbox" checked onchange="updateMap()">
                            <div class="toggle-label"><div class="toggle-dot"></div></div>
                        </div>
                    </label>
                </div>

                <div class="mt-6 pt-4 border-t border-gray-100">
                     <div class="rounded-lg bg-blue-50 p-3 border border-blue-100">
                        <div class="flex gap-3">
                            <i class="fas fa-lightbulb text-blue-500 mt-0.5"></i>
                            <div class="text-xs text-blue-800 leading-relaxed">
                                Cliquez sur un marqueur pour voir les détails ou lancer la navigation GPS.
                            </div>
                        </div>
                    </div>
                </div>
            </div>

        </div>

        <!-- Map Container -->
        <div id="map" class="h-full w-full outline-none"></div>

        <!-- Loading Overlay (Initial) -->
        <div id="map-loading" class="absolute inset-0 bg-white/80 backdrop-blur-sm flex flex-col items-center justify-center z-[2000]">
            <div class="animate-spin rounded-full h-12 w-12 border-4 border-primary-100 border-t-primary-600 mb-4"></div>
            <span class="text-sm font-medium text-gray-600">Chargement de la cartographie...</span>
        </div>

    </div>

    <!-- Leaflet JS -->
    <script src="https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

    <!-- Scripts de l'application (si disponibles) -->
    <script>
        // Vérifier si les scripts d'auth existent, sinon utiliser des fonctions mock
        let authScriptsLoaded = false;
        try {
            // Essayer de charger les scripts existants
            if (typeof checkAuth === 'undefined') {
                // Charger les scripts si disponibles
                const authScript = document.createElement('script');
                authScript.src = 'js/auth.js';
                authScript.onerror = () => { authScriptsLoaded = false; };
                document.head.appendChild(authScript);
            } else {
                authScriptsLoaded = true;
            }
        } catch(e) {
            authScriptsLoaded = false;
        }
    </script>
    <script src="js/app.js"></script>
    <script src="js/components.js?v=20260116"></script>
    <script>window.DISABLE_SIDEBAR = true;</script>
    <script src="js/sidebar.js"></script>

    <script>
        // ==========================================
        // CONFIGURATION & UTILS
        // ==========================================
        
        // Fonctions d'authentification (utiliser les vraies si disponibles, sinon mock)
        function checkAuth() {
            if (typeof window.checkAuth === 'function') {
                window.checkAuth();
            } else {
                const user = localStorage.getItem('user');
                if (!user) {
                    // Rediriger vers la page de connexion si pas d'utilisateur
                    window.location.href = 'index.html';
                }
            }
        }
        
        function logout() {
            if (typeof window.logout === 'function') {
                window.logout();
            } else {
                if(confirm('Déconnexion ?')) { 
                    localStorage.removeItem('user'); 
                    localStorage.removeItem('token');
                    window.location.href = 'index.html';
                }
            }
        }

        // Toast est déjà défini dans components.js (chargé avant ce script)
        // On utilise window.Toast directement pour éviter les conflits de déclaration
        // Si Toast n'est pas disponible, créer un fallback
        if (typeof window.Toast === 'undefined') {
            window.Toast = {
                success: (m) => {
                    console.log('✅ ' + m);
                    if (typeof alert !== 'undefined') alert('✅ ' + m);
                },
                error: (m) => {
                    console.error('❌ ' + m);
                    if (typeof alert !== 'undefined') alert('❌ ' + m);
                },
                info: (m) => {
                    console.info('ℹ️ ' + m);
                },
                warning: (m) => {
                    console.warn('⚠️ ' + m);
                }
            };
        }
        // Créer un alias local pour simplifier l'utilisation, mais sans const/let pour éviter les conflits
        // Utiliser window.Toast directement dans le code

        // Utiliser apiCall si disponible, sinon créer une fonction de fallback
        let apiCall;
        if (typeof window.apiCall === 'function') {
            apiCall = window.apiCall;
        } else {
            // Fallback: utiliser fetch avec token
            apiCall = async function(url) {
                const token = localStorage.getItem('token');
                const headers = {
                    'Content-Type': 'application/json'
                };
                if (token) {
                    headers['Authorization'] = `Bearer ${token}`;
                }
                
                // Détecter l'URL de base
                let baseUrl = '';
                if (url.startsWith('http')) {
                    baseUrl = '';
                } else if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {
                    baseUrl = 'http://localhost:3000';
                } else {
                    baseUrl = window.location.origin;
                }
                
                const fullUrl = url.startsWith('http') ? url : `${baseUrl}${url}`;
                
                try {
                    const response = await fetch(fullUrl, {
                        method: 'GET',
                        headers: headers
                    });
                    
                    if (!response.ok && response.status === 401) {
                        // Token expiré ou invalide
                        localStorage.removeItem('token');
                        localStorage.removeItem('user');
                        window.location.href = 'index.html';
                        return { ok: false };
                    }
                    
                    return response;
                } catch (error) {
                    console.error('Erreur API:', error);
                    return { ok: false, json: async () => ({ error: error.message }) };
                }
            };
        }

        // ==========================================
        // INITIALISATION
        // ==========================================
        
        checkAuth();
        
        const user = JSON.parse(localStorage.getItem('user') || '{}');
        const userNameEl = document.getElementById('user-name');
        if (userNameEl) {
            userNameEl.textContent = `${user.prenom || ''} ${user.nom || ''}`.trim() || user.email || 'Utilisateur';
        }

        // ==========================================
        // MAP LOGIC
        // ==========================================

        let map;
        let markers = [];
        let allLocations = [];

        // Configuration visuelle des types
        const typeConfig = {
            'fournisseur': { color: '#3b82f6', bg: 'bg-blue-500', icon: '<i class="fas fa-industry"></i>', label: 'Fournisseur' },
            'client': { color: '#10b981', bg: 'bg-emerald-500', icon: '<i class="fas fa-building"></i>', label: 'Client' },
            'acheteur': { color: '#f59e0b', bg: 'bg-amber-500', icon: '<i class="fas fa-shopping-cart"></i>', label: 'Acheteur' },
            'transporteur': { color: '#ef4444', bg: 'bg-red-500', icon: '<i class="fas fa-truck"></i>', label: 'Transporteur' }
        };

        async function initMap() {
            // Vérifier que Leaflet est chargé
            if (typeof L === 'undefined') {
                console.error('Leaflet n\'est pas chargé');
                window.Toast.error('Erreur: Bibliothèque de carte non chargée');
                return;
            }
            
            // Vérifier que le conteneur existe
            const mapContainer = document.getElementById('map');
            if (!mapContainer) {
                console.error('Conteneur de carte introuvable');
                window.Toast.error('Erreur: Conteneur de carte introuvable');
                return;
            }
            
            try {
                map = L.map('map', { zoomControl: false }).setView([9.6412, -13.5784], 13);

                // Add standard zoom control to bottom right
                L.control.zoom({ position: 'bottomright' }).addTo(map);

                // Tuiles modernes et claires (CartoDB Positron pour un look pro)
                // Fallback vers OpenStreetMap si CartoDB ne fonctionne pas
                const cartoTileLayer = L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
                    attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors &copy; <a href="https://carto.com/attributions">CARTO</a>',
                    subdomains: 'abcd',
                    maxZoom: 20
                });
                
                // Essayer d'ajouter CartoDB, avec fallback vers OSM
                cartoTileLayer.addTo(map);
                cartoTileLayer.on('tileerror', function() {
                    // Si erreur, utiliser OpenStreetMap
                    map.removeLayer(cartoTileLayer);
                    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
                        maxZoom: 19
                    }).addTo(map);
                });

                // Forcer le redimensionnement de la carte après un court délai
                setTimeout(() => {
                    if (map) {
                        map.invalidateSize();
                    }
                }, 100);

                await loadLocations();
            } catch (error) {
                console.error('Erreur initialisation carte:', error);
                window.Toast.error('Erreur lors de l\'initialisation de la carte: ' + error.message);
            }
        }

        async function loadLocations() {
            const loading = document.getElementById('map-loading');
            if (loading) loading.style.display = 'flex';

            try {
                const res = await apiCall('/api/entreprises');
                if (!res || !res.ok) {
                    throw new Error('Erreur lors du chargement des entreprises');
                }

                const data = await res.json();
                const entreprises = data.entreprises || data || [];
                
                allLocations = [];
                
                // Fetch details en parallèle
                const promises = entreprises.map(async (ent) => {
                    try {
                        const detailRes = await apiCall(`/api/entreprises/${ent.id}`);
                        if (detailRes && detailRes.ok) {
                            const details = await detailRes.json();
                            const addr = details.adresses?.find(a => a.latitude && a.longitude) || details.adresses?.[0];
                            if (addr && addr.latitude && addr.longitude) {
                                return { entreprise: ent, adresse: addr, type: ent.type_entreprise };
                            }
                        }
                    } catch (err) {
                        console.warn(`Erreur pour entreprise ${ent.id}:`, err);
                    }
                    return null;
                });

                const results = await Promise.all(promises);
                allLocations = results.filter(l => l !== null);
                
                updateMap();

            } catch (e) {
                console.error('Erreur chargement locations:', e);
                window.Toast.error('Erreur lors du chargement des données de la carte');
            } finally {
                if (loading) loading.style.display = 'none';
            }
        }

        function updateMap() {
            markers.forEach(m => map.removeLayer(m));
            markers = [];

            const filters = {
                fournisseur: document.getElementById('filter-fournisseur').checked,
                client: document.getElementById('filter-client').checked,
                acheteur: document.getElementById('filter-acheteur').checked,
                transporteur: document.getElementById('filter-transporteur').checked
            };

            const filtered = allLocations.filter(loc => filters[loc.type]);
            const countEl = document.getElementById('marker-count');
            if (countEl) {
                countEl.textContent = `${filtered.length} affichés`;
            }

            filtered.forEach(loc => {
                const config = typeConfig[loc.type] || typeConfig['client'];
                
                const customIcon = L.divIcon({
                    className: 'bg-transparent',
                    html: `<div class="custom-marker-icon ${config.bg}" style="width: 36px; height: 36px;">${config.icon}</div>`,
                    iconSize: [36, 36],
                    iconAnchor: [18, 36],
                    popupAnchor: [0, -36]
                });

                const popupContent = `
                    <div class="w-64 font-sans">
                        <div class="flex items-center gap-3 mb-3 border-b border-gray-100 pb-2">
                            <div class="w-8 h-8 rounded-lg ${config.bg} bg-opacity-10 flex items-center justify-center text-${config.bg.replace('bg-', '')}">
                                ${config.icon}
                            </div>
                            <div>
                                <h3 class="font-bold text-gray-900 text-sm leading-tight">${loc.entreprise.nom || 'Entreprise'}</h3>
                                <p class="text-xs text-gray-500">${config.label}</p>
                            </div>
                        </div>
                        <div class="space-y-2 mb-3">
                            <div class="flex items-start gap-2 text-xs text-gray-600">
                                <i class="fas fa-map-marker-alt mt-0.5 text-gray-400"></i>
                                <span>${loc.adresse.adresse_ligne1 || ''}, ${loc.adresse.ville || ''}</span>
                            </div>
                            ${loc.entreprise.description ? `
                            <div class="flex items-start gap-2 text-xs text-gray-600">
                                <i class="fas fa-info-circle mt-0.5 text-gray-400"></i>
                                <span>${loc.entreprise.description}</span>
                            </div>
                            ` : ''}
                        </div>
                        <div class="grid grid-cols-2 gap-2">
                            <button onclick="viewEntreprise(${loc.entreprise.id})" 
                                class="flex items-center justify-center px-3 py-1.5 bg-gray-50 hover:bg-gray-100 text-gray-700 text-xs font-medium rounded-md border border-gray-200 transition-colors">
                                Détails
                            </button>
                            <button onclick="window.open('https://www.google.com/maps/dir/?api=1&destination=${loc.adresse.latitude},${loc.adresse.longitude}', '_blank')" 
                                class="flex items-center justify-center px-3 py-1.5 bg-primary-50 hover:bg-primary-100 text-primary-700 text-xs font-medium rounded-md border border-primary-200 transition-colors">
                                <i class="fas fa-location-arrow mr-1.5"></i> Y aller
                            </button>
                        </div>
                    </div>
                `;

                const marker = L.marker([loc.adresse.latitude, loc.adresse.longitude], { icon: customIcon })
                    .bindPopup(popupContent);
                
                marker.addTo(map);
                markers.push(marker);
            });

            if (markers.length > 0) {
                const group = new L.featureGroup(markers);
                map.fitBounds(group.getBounds().pad(0.2));
            }
        }

        function viewEntreprise(id) {
            window.location.href = `entreprises-detail.html?id=${id}`;
        }

        function centerOnUser() {
            if ("geolocation" in navigator) {
                navigator.geolocation.getCurrentPosition(position => {
                    const { latitude, longitude } = position.coords;
                    const userIcon = L.divIcon({
                        className: 'bg-transparent',
                        html: '<div class="w-4 h-4 bg-blue-600 rounded-full border-2 border-white shadow-lg relative"><div class="absolute -inset-1 bg-blue-500 rounded-full opacity-30 animate-ping"></div></div>',
                        iconSize: [16, 16]
                    });
                    
                    L.marker([latitude, longitude], { icon: userIcon, zIndexOffset: 1000 })
                        .addTo(map)
                        .bindPopup('<div class="text-center font-medium text-sm p-1">Vous êtes ici</div>')
                        .openPopup();
                    
                    map.flyTo([latitude, longitude], 15, { duration: 1.5 });
                }, () => {
                    window.Toast.error("Position indisponible");
                });
            } else {
                window.Toast.error("Géolocalisation non supportée");
            }
        }

        function refreshMap() {
            loadLocations();
        }

        function toggleMobileMenu() {
            const menu = document.getElementById('mobile-menu');
            const button = document.getElementById('mobile-menu-button');
            if (menu && button) {
                menu.classList.toggle('hidden');
                const isExpanded = !menu.classList.contains('hidden');
                button.setAttribute('aria-expanded', isExpanded);
            }
        }

        // Initialiser la carte une fois que tout est chargé
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', () => {
                // Attendre que Leaflet soit chargé
                if (typeof L !== 'undefined') {
                    initMap();
                } else {
                    // Attendre un peu plus si Leaflet n'est pas encore chargé
                    setTimeout(() => {
                        if (typeof L !== 'undefined') {
                            initMap();
                        } else {
                            console.error('Leaflet n\'a pas pu être chargé');
                            window.Toast.error('Erreur: Impossible de charger la bibliothèque de carte');
                        }
                    }, 500);
                }
            });
        } else {
            // DOM déjà chargé
            if (typeof L !== 'undefined') {
                initMap();
            } else {
                setTimeout(() => {
                    if (typeof L !== 'undefined') {
                        initMap();
                    } else {
                        console.error('Leaflet n\'a pas pu être chargé');
                        window.Toast.error('Erreur: Impossible de charger la bibliothèque de carte');
                    }
                }, 500);
            }
        }
    </script>
</body>
</html>
