<!DOCTYPE html>
<html lang="fr" class="h-full bg-gray-50">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Détails RFQ - SilyProcure</title>
    
    <!-- CSS Charte Graphique Pro Confiance -->
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="css/responsive.css">
    <link rel="stylesheet" href="css/animations.css">
    
        <!-- Tailwind CSS (optimisé pour production) -->
    <link rel="stylesheet" href="css/tailwind.css">
    
    <!-- Font Awesome & Google Fonts -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Dashboard Theme CSS -->
    <link rel="stylesheet" href="css/dashboard-theme.css">
    <!-- Modern Theme (inspiré de home.html) -->
    <link rel="stylesheet" href="css/modern-theme.css">

    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        /* Override pour utiliser le style moderne de home.html */
        body {
            font-family: "Plus Jakarta Sans", sans-serif !important;
            background: #f8fafc !important;
        }
        
        /* Utiliser brand-600 au lieu de primary-500 */
        .text-primary-600, .text-primary-500 { color: #2563eb !important; }
        .bg-primary-600, .bg-primary-500 { background-color: #2563eb !important; }
        .border-primary-500 { border-color: #2563eb !important; }
        
        /* Améliorer les cartes */
        .card, .stat-card, .facture-card, .filters-card, .kpi-card {
            border-radius: 1.5rem !important;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1) !important;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1) !important;
        }
        
        .card:hover, .facture-card:hover {
            transform: translateY(-4px) !important;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 8px 10px -6px rgba(0, 0, 0, 0.1) !important;
        }
    </style>
</head>
<body class="h-full flex flex-col">
    <script src="js/auth.js"></script>
    <script src="js/app.js"></script>
    <script src="js/components.js?v=20260116"></script>
    <script>window.DISABLE_SIDEBAR = true;</script>
    <script src="js/sidebar.js"></script>
    <script src="js/modern-menu.js"></script>

    <!-- Navbar Moderne selon charte Pro Confiance -->
    <nav class="bg-white border-b-2 border-blue-100 sticky top-0 z-50 shadow-sm" role="navigation" aria-label="Navigation principale">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-16">
                <!-- Logo & Nav Links -->
                <div class="flex items-center">
                    <div class="flex-shrink-0 flex items-center cursor-pointer" onclick="window.location.href='dashboard.html'">
                        <span class="text-2xl font-bold logo-primary">Sily<span class="text-gray-900">Procure</span></span>
                    </div>
                    <nav class="hidden sm:ml-6 sm:flex sm:space-x-1 md:ml-8" aria-label="Menu de navigation">
                        <a href="dashboard.html" class="border-transparent text-neutral-500 hover:border-primary-300 hover:text-primary-700 inline-flex items-center px-3 sm:px-4 py-2 border-b-2 text-sm font-medium transition-colors min-h-[44px] whitespace-nowrap">
                            <i class="fas fa-chart-line mr-1.5 sm:mr-2 text-xs sm:text-sm" aria-hidden="true"></i>
                            <span>Dashboard</span>
                        </a>
                        <a href="rfq.html" class="border-primary-500 text-primary-900 inline-flex items-center px-3 sm:px-4 py-2 border-b-2 text-sm font-semibold min-h-[44px] transition-colors whitespace-nowrap" aria-current="page">
                            <i class="fas fa-file-contract mr-1.5 sm:mr-2 text-xs sm:text-sm" aria-hidden="true"></i>
                            <span>RFQ</span>
                        </a>
                        <a href="devis.html" class="border-transparent text-neutral-500 hover:border-primary-300 hover:text-primary-700 inline-flex items-center px-3 sm:px-4 py-2 border-b-2 text-sm font-medium transition-colors min-h-[44px] whitespace-nowrap">
                            <i class="fas fa-file-invoice-dollar mr-1.5 sm:mr-2 text-xs sm:text-sm" aria-hidden="true"></i>
                            <span>Devis</span>
                        </a>
                        <a href="commandes.html" class="border-transparent text-neutral-500 hover:border-primary-300 hover:text-primary-700 inline-flex items-center px-3 sm:px-4 py-2 border-b-2 text-sm font-medium transition-colors min-h-[44px] whitespace-nowrap">
                            <i class="fas fa-shopping-cart mr-1.5 sm:mr-2 text-xs sm:text-sm" aria-hidden="true"></i>
                            <span>Commandes</span>
                        </a>
                        <a href="entreprises.html" class="border-transparent text-neutral-500 hover:border-primary-300 hover:text-primary-700 inline-flex items-center px-3 sm:px-4 py-2 border-b-2 text-sm font-medium transition-colors min-h-[44px] whitespace-nowrap">
                            <i class="fas fa-building mr-1.5 sm:mr-2 text-xs sm:text-sm" aria-hidden="true"></i>
                            <span>Entreprises</span>
                        </a>
                    </nav>
                </div>

                <!-- Search Bar & Profile -->
                <div class="flex items-center gap-4">
                    <!-- Global Search -->
                    <div class="hidden lg:block relative text-neutral-500 focus-within:text-primary-600" role="search">
                        <label for="global-search" class="sr-only">Rechercher dans l'application</label>
                        <div class="pointer-events-none absolute inset-y-0 left-0 pl-3 flex items-center">
                            <i class="fas fa-search" aria-hidden="true"></i>
                        </div>
                        <input id="global-search" class="block w-64 bg-blue-50 py-2.5 pl-10 pr-4 border border-blue-200 rounded-full leading-5 text-neutral-700 placeholder-neutral-400 focus:outline-none focus:bg-white focus:ring-2 focus:ring-primary-500 focus:border-primary-500 sm:text-sm transition duration-150 ease-in-out min-h-[44px]" placeholder="Rechercher..." type="search" aria-label="Rechercher">
                    </div>

                    <!-- Notifications -->
                    <button class="relative p-2.5 text-neutral-500 hover:text-primary-600 transition-colors rounded-lg hover:bg-blue-50 min-w-[44px] min-h-[44px] flex items-center justify-center" aria-label="Notifications" title="Notifications">
                        <i class="far fa-bell text-xl" aria-hidden="true"></i>
                        <span class="absolute top-2 right-2 block h-2.5 w-2.5 rounded-full bg-red-500 ring-2 ring-white" aria-hidden="true"></span>
                    </button>

                    <!-- Profile Dropdown -->
                    <div class="relative flex items-center gap-3">
                        <div class="h-10 w-10 rounded-full bg-primary-100 flex items-center justify-center text-primary-700 font-bold border-2 border-primary-200 shadow-sm" aria-label="Profil utilisateur">
                            <span id="user-initials">U</span>
                        </div>
                        <span id="user-name" class="hidden md:block text-sm font-semibold text-neutral-700 min-w-[120px]">Chargement...</span>
                        <button onclick="logout()" class="ml-1 text-xs text-red-600 hover:text-red-700 border border-red-200 rounded-lg px-3 py-2 hover:bg-red-50 transition min-h-[44px] flex items-center gap-1.5" aria-label="Déconnexion" title="Déconnexion">
                            <i class="fas fa-sign-out-alt" aria-hidden="true"></i>
                            <span class="hidden lg:inline">Déconnexion</span>
                        </button>
                    </div>
                    
                    <!-- Menu mobile -->
                    <div class="sm:hidden ml-2">
                        <button id="mobile-menu-button" onclick="toggleMobileMenu()" class="inline-flex items-center justify-center p-2.5 rounded-lg text-neutral-500 hover:text-primary-600 hover:bg-blue-50 focus:outline-none focus:ring-2 focus:ring-inset focus:ring-primary-500 min-w-[44px] min-h-[44px]" aria-expanded="false" aria-label="Menu principal" aria-controls="mobile-menu">
                            <i class="fas fa-bars text-xl"></i>
                        </button>
                    </div>
                </div>
            </div>
            <!-- Menu mobile déroulant -->
            <div id="mobile-menu" class="hidden sm:hidden border-t-2 border-blue-100 bg-white shadow-lg">
                <div class="px-4 pt-3 pb-4 space-y-1">
                    <a href="dashboard.html" class="border-transparent text-neutral-700 hover:bg-blue-50 hover:text-primary-700 hover:border-l-4 hover:border-primary-300 block px-4 py-3 rounded-lg text-base font-medium transition-all min-h-[44px] flex items-center gap-3">
                        <i class="fas fa-chart-line text-neutral-500" aria-hidden="true"></i>
                        <span>Dashboard</span>
                    </a>
                    <a href="rfq.html" class="bg-gradient-to-r from-blue-50 to-primary-50 border-l-4 border-primary-500 text-primary-700 block px-4 py-3 rounded-lg text-base font-semibold min-h-[44px] flex items-center gap-3 transition-all">
                        <i class="fas fa-file-contract text-primary-600" aria-hidden="true"></i>
                        <span>RFQ</span>
                    </a>
                    <a href="devis.html" class="border-transparent text-neutral-700 hover:bg-blue-50 hover:text-primary-700 hover:border-l-4 hover:border-primary-300 block px-4 py-3 rounded-lg text-base font-medium transition-all min-h-[44px] flex items-center gap-3">
                        <i class="fas fa-file-invoice-dollar text-neutral-500" aria-hidden="true"></i>
                        <span>Devis</span>
                    </a>
                    <a href="commandes.html" class="border-transparent text-neutral-700 hover:bg-blue-50 hover:text-primary-700 hover:border-l-4 hover:border-primary-300 block px-4 py-3 rounded-lg text-base font-medium transition-all min-h-[44px] flex items-center gap-3">
                        <i class="fas fa-shopping-cart text-neutral-500" aria-hidden="true"></i>
                        <span>Commandes</span>
                    </a>
                    <a href="entreprises.html" class="border-transparent text-neutral-700 hover:bg-blue-50 hover:text-primary-700 hover:border-l-4 hover:border-primary-300 block px-4 py-3 rounded-lg text-base font-medium transition-all min-h-[44px] flex items-center gap-3">
                        <i class="fas fa-building text-neutral-500" aria-hidden="true"></i>
                        <span>Entreprises</span>
                    </a>
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="flex-1 max-w-7xl w-full mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <div class="container">
        <!-- Hero Section -->
        <div class="hero-section" style="text-align: left; padding: 2rem;">
            <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 1rem;">
                <div>
                    <button class="btn btn-secondary" onclick="window.location.href='rfq.html'" style="margin-bottom: 1rem;">
                        ← Retour à la liste
                    </button>
                    <h1 class="hero-title" style="font-size: 2rem; margin: 0;"><i class="fas fa-clipboard-list"></i> Détails de la RFQ</h1>
                    <p class="hero-description" style="text-align: left; margin: 0.5rem 0 0 0; max-width: 100%;">
                        Consultez les détails de la demande de devis et les réponses reçues
                    </p>
                </div>
            </div>
        </div>

        <div id="rfq-details">
            <div class="loading"><div class="loading-spinner"></div> Chargement...</div>
        </div>

        <!-- Section Devis reçus -->
        <div class="card" id="devis-section" style="margin-top: 1.5rem;">
            <div class="card-header">
                <h2 class="card-title"><i class="fas fa-briefcase"></i> Devis reçus</h2>
                <span class="badge badge-info" id="devis-count">0 devis</span>
            </div>
            <div id="devis-list">
                <div class="loading">Chargement des devis...</div>
            </div>
        </div>
    </div>
    </main>

    <script src="js/fileUpload.js"></script>
    <script src="js/forms.js"></script>
<script>
        checkAuth();

        const user = JSON.parse(localStorage.getItem('user') || '{}');
        // Initialisation du nom d'utilisateur et des initiales
        const userNameEl = document.getElementById('user-name');
        const userInitialsEl = document.getElementById('user-initials');
        if (userNameEl) {
            userNameEl.textContent = `${user.prenom || ''} ${user.nom || ''}`.trim() || user.email || 'Utilisateur';
        }
        if (userInitialsEl && user.prenom) {
            userInitialsEl.textContent = (user.prenom.charAt(0) + (user.nom ? user.nom.charAt(0) : '')).toUpperCase();
        }
        document.getElementById('user-name').textContent = `${user.prenom || ''} ${user.nom || ''}`.trim() || user.email;

        const urlParams = new URLSearchParams(window.location.search);
        const rfqId = urlParams.get('id');

        // Fonction pour télécharger le PDF d'une RFQ avec authentification
        async function downloadPDFRFQ(rfqId) {
            try {
                const token = localStorage.getItem('token');
                if (!token) {
                    Toast.error('Vous devez être connecté pour télécharger le PDF');
                    return;
                }
                
                showLoading('Génération du PDF...');
                
                // Détecter l'URL de base
                let baseUrl = '';
                if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {
                    baseUrl = 'http://localhost:3000';
                } else {
                    baseUrl = window.location.origin;
                }
                
                const url = `${baseUrl}/api/pdf/rfq/${rfqId}`;
                
                const response = await fetch(url, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                hideLoading();
                
                if (!response.ok) {
                    if (response.status === 401) {
                        Toast.error('Session expirée. Veuillez vous reconnecter.');
                        window.location.href = 'index.html';
                        return;
                    }
                    const errorData = await response.json().catch(() => ({ error: 'Erreur inconnue' }));
                    Toast.error(errorData.error || 'Erreur lors du téléchargement du PDF');
                    return;
                }
                
                // Récupérer le blob
                const blob = await response.blob();
                
                // Créer un lien de téléchargement
                const downloadUrl = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = downloadUrl;
                a.download = `RFQ-${rfqId}-${Date.now()}.pdf`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                window.URL.revokeObjectURL(downloadUrl);
                
                Toast.success('PDF téléchargé avec succès');
            } catch (error) {
                hideLoading();
                console.error('Erreur téléchargement PDF:', error);
                Toast.error('Erreur lors du téléchargement du PDF: ' + error.message);
            }
        }
        window.downloadPDFRFQ = downloadPDFRFQ;

        async function loadRFQDetails() {
            if (!rfqId) {
                Toast.error('RFQ non spécifiée');
                window.location.href = 'rfq.html';
                return;
            }

            try {
                showLoading('Chargement...');
                const response = await apiCall(`/api/rfq/${rfqId}`);
                if (!response) {
                    hideLoading();
                    return;
                }

                const rfq = await response.json();
                hideLoading();
                displayRFQDetails(rfq);
                
                // Charger les RFQ liées (autres fournisseurs ayant reçu la même demande)
                loadRelatedRFQs(rfq.id, rfq.date_emission, rfq.emetteur_id, rfq.description).then(relatedRFQs => {
                    if (relatedRFQs.length > 0) {
                        displayRelatedRFQs(relatedRFQs, rfq.id);
                    }
                });
                
                loadDevis(rfqId);
            } catch (error) {
                hideLoading();
                Toast.error('Erreur lors du chargement');
                console.error('Erreur:', error);
            }
        }

        async function loadRelatedRFQs(rfqId, rfqDate, emetteurId, description) {
            try {
                // Charger toutes les RFQ créées le même jour par le même émetteur
                const response = await apiCall(`/api/rfq?emetteur_id=${emetteurId}`);
                if (!response.ok) return [];
                
                const allRFQs = await response.json();
                const rfqDateStr = rfqDate ? new Date(rfqDate).toISOString().split('T')[0] : null;
                
                // Filtrer les RFQ créées le même jour avec une description similaire
                const relatedRFQs = allRFQs.filter(r => {
                    if (r.id === rfqId) return false; // Exclure la RFQ actuelle
                    if (!rfqDateStr) return false;
                    const rDateStr = r.date_emission ? new Date(r.date_emission).toISOString().split('T')[0] : null;
                    if (rDateStr !== rfqDateStr) return false;
                    if (r.emetteur_id !== emetteurId) return false;
                    // Vérifier si la description est similaire (commence par la même phrase)
                    if (description && r.description) {
                        const desc1 = description.substring(0, 50).toLowerCase();
                        const desc2 = r.description.substring(0, 50).toLowerCase();
                        return desc1 === desc2;
                    }
                    return true;
                });
                
                return relatedRFQs;
            } catch (error) {
                console.error('Erreur chargement RFQ liées:', error);
                return [];
            }
        }

        function displayRelatedRFQs(relatedRFQs, currentRfqId) {
            const section = document.getElementById('related-rfqs-section');
            if (!section || relatedRFQs.length === 0) return;
            
            // Inclure aussi la RFQ actuelle dans la liste
            const allRFQs = [...relatedRFQs];
            
            section.innerHTML = `
                <div class="card" style="border-left: 4px solid #10b981; background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%);">
                    <div class="card-header" style="background: transparent; border-bottom: 2px solid #86efac;">
                        <h2 class="card-title" style="color: #059669;">
                            <i class="fas fa-users"></i> Tous les fournisseurs ayant reçu cette demande
                            <span class="badge badge-success" style="margin-left: 0.5rem; background: #10b981; color: white;">
                                ${allRFQs.length + 1} fournisseur(s)
                            </span>
                        </h2>
                    </div>
                    <div style="padding: 1.5rem;">
                        <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 1rem;">
                            ${allRFQs.map(rfq => `
                                <div style="padding: 1rem; background: white; border-radius: 8px; border: 2px solid ${rfq.id === currentRfqId ? '#2563eb' : '#e5e7eb'}; box-shadow: 0 2px 4px rgba(0,0,0,0.1); transition: all 0.3s;">
                                    <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 0.75rem;">
                                        <div>
                                            <div style="font-weight: 700; color: #1e293b; font-size: 1rem; margin-bottom: 0.25rem;">
                                                <i class="fas fa-building" style="color: #2563eb; margin-right: 0.5rem;"></i>
                                                ${rfq.destinataire_nom || 'Non spécifié'}
                                            </div>
                                            <div style="font-size: 0.875rem; color: #64748b; margin-top: 0.25rem;">
                                                <i class="fas fa-hashtag" style="color: #94a3b8;"></i> ${rfq.numero || 'RFQ-' + rfq.id}
                                            </div>
                                        </div>
                                        ${rfq.id === currentRfqId ? `
                                            <span class="badge" style="background: #2563eb; color: white; padding: 0.25rem 0.75rem; border-radius: 12px; font-size: 0.75rem;">
                                                <i class="fas fa-check-circle"></i> Actuelle
                                            </span>
                                        ` : ''}
                                    </div>
                                    ${rfq.destinataire_email ? `
                                        <div style="font-size: 0.875rem; color: #475569; margin-top: 0.5rem; display: flex; align-items: center; gap: 0.5rem;">
                                            <i class="fas fa-envelope" style="color: #2563eb;"></i> 
                                            <a href="mailto:${rfq.destinataire_email}" style="color: #2563eb; text-decoration: none;">${rfq.destinataire_email}</a>
                                        </div>
                                    ` : ''}
                                    <div style="margin-top: 0.75rem; padding-top: 0.75rem; border-top: 1px solid #e5e7eb;">
                                        <button class="btn btn-sm btn-primary" onclick="window.location.href='rfq-detail.html?id=${rfq.id}'" style="width: 100%; font-size: 0.875rem; padding: 0.5rem;">
                                            <i class="fas fa-eye"></i> Voir cette RFQ
                                        </button>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                </div>
            `;
        }

        // Stocker les RFQ liées globalement pour les utiliser dans les fonctions
        let currentRFQ = null;
        let relatedRFQsList = [];

        function displayRFQDetails(rfq) {
            currentRFQ = rfq;
            const container = document.getElementById('rfq-details');
            
            // Charger les RFQ liées en arrière-plan
            loadRelatedRFQs(rfq.id, rfq.date_emission, rfq.emetteur_id, rfq.description).then(relatedRFQs => {
                relatedRFQsList = relatedRFQs;
                if (relatedRFQs.length > 0) {
                    displayRelatedRFQs(relatedRFQs, rfq.id);
                }
            });
            
            container.innerHTML = `
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">${rfq.numero || 'RFQ-' + rfq.id}</h2>
                        <div>
                            <button class="btn btn-secondary" onclick="downloadPDFRFQ(${rfq.id})" style="margin-right: 0.5rem;">
                                <i class="fas fa-file-pdf"></i> PDF
                            </button>
                            <span class="badge ${getStatusBadge(rfq.statut)}">${getStatusLabel(rfq.statut)}</span>
                            ${rfq.statut === 'brouillon' ? `
                                <button class="btn btn-primary" onclick="if(typeof editRFQForm==='function'){editRFQForm(${rfq.id});}else{alert('Fonction non disponible');}" style="margin-left: 0.5rem;">
                                    <i class="fas fa-edit"></i> Modifier
                                </button>
                                <button class="btn btn-success" onclick="envoyerRFQ(${rfq.id})" style="margin-left: 0.5rem;">
                                    <i class="fas fa-upload"></i> Envoyer aux fournisseurs
                                </button>
                            ` : ''}
                        </div>
                    </div>

                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 2rem;">
                        <div>
                            <h3 style="margin-bottom: 1rem; color: var(--color-primary);"><i class="fas fa-clipboard-list"></i> Informations</h3>
                            <div class="form-group">
                                <label>Date d'émission</label>
                                <div style="padding: 0.75rem; background: var(--color-background-light); border-radius: 6px;">
                                    ${formatDate(rfq.date_emission)}
                                </div>
                            </div>
                            <div class="form-group">
                                <label>Date limite de réponse</label>
                                <div style="padding: 0.75rem; background: var(--color-background-light); border-radius: 6px;">
                                    ${formatDate(rfq.date_limite_reponse)}
                                </div>
                            </div>
                            <div class="form-group">
                                <label><i class="fas fa-building"></i> Fournisseur Destinataire</label>
                                <div style="padding: 1rem; background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%); border-radius: 8px; border-left: 4px solid var(--color-primary);">
                                    <div style="font-weight: 700; color: var(--color-primary); font-size: 1.1rem; margin-bottom: 0.75rem;">
                                        <i class="fas fa-building" style="margin-right: 0.5rem;"></i>
                                        ${rfq.destinataire_nom || 'Non spécifié'}
                                    </div>
                                    ${rfq.destinataire_email ? `
                                        <div style="font-size: 0.9rem; color: #475569; margin-top: 0.5rem; display: flex; align-items: center; gap: 0.5rem;">
                                            <i class="fas fa-envelope" style="color: var(--color-primary);"></i> 
                                            <a href="mailto:${rfq.destinataire_email}" style="color: var(--color-primary); text-decoration: none; font-weight: 500;">${rfq.destinataire_email}</a>
                                        </div>
                                    ` : ''}
                                    ${rfq.destinataire_telephone ? `
                                        <div style="font-size: 0.9rem; color: #475569; margin-top: 0.5rem; display: flex; align-items: center; gap: 0.5rem;">
                                            <i class="fas fa-phone" style="color: var(--color-primary);"></i> 
                                            <a href="tel:${rfq.destinataire_telephone}" style="color: var(--color-primary); text-decoration: none; font-weight: 500;">${rfq.destinataire_telephone}</a>
                                        </div>
                                    ` : ''}
                                    ${rfq.destinataire_secteur ? `
                                        <div style="font-size: 0.85rem; color: #64748b; margin-top: 0.5rem; display: flex; align-items: center; gap: 0.5rem;">
                                            <i class="fas fa-industry" style="color: #94a3b8;"></i> 
                                            <span>${rfq.destinataire_secteur}</span>
                                        </div>
                                    ` : ''}
                                    ${rfq.destinataire_id ? `
                                        <div style="margin-top: 0.75rem; padding-top: 0.75rem; border-top: 1px solid #cbd5e1;">
                                            <button class="btn btn-sm btn-secondary" onclick="window.location.href='entreprises.html?id=${rfq.destinataire_id}'" style="font-size: 0.875rem; padding: 0.5rem 1rem;">
                                                <i class="fas fa-info-circle"></i> Voir les détails du fournisseur
                                            </button>
                                        </div>
                                    ` : ''}
                                </div>
                            </div>
                        </div>

                        <div>
                            <h3 style="margin-bottom: 1rem; color: var(--color-primary);"><i class="fas fa-edit"></i> Description</h3>
                            <div style="padding: 0.75rem; background: var(--color-background-light); border-radius: 6px; min-height: 100px;">
                                ${rfq.description || '-'}
                            </div>
                        </div>
                    </div>

                    ${rfq.lignes && rfq.lignes.length > 0 ? `
                        <h3 style="margin: 1.5rem 0 1rem 0; color: var(--color-primary); font-size: 1.125rem; font-weight: 600;"><i class="fas fa-box"></i> Produits/Services demandés</h3>
                        <div class="table-container" style="background: white; border: 2px solid var(--color-background-light); border-radius: 8px; box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05); overflow: visible;">
                            <table class="table" style="width: 100%; border-collapse: collapse; background: white;">
                                <thead>
                                    <tr style="background: #00387A !important; background-color: #00387A !important;">
                                        <th style="padding: 1rem; color: #ffffff !important; font-weight: 600; font-size: 0.875rem; text-transform: uppercase; letter-spacing: 0.05em; border-bottom: 2px solid #002855; background: #00387A !important; background-color: #00387A !important;">Description</th>
                                        <th style="padding: 1rem; color: #ffffff !important; font-weight: 600; font-size: 0.875rem; text-transform: uppercase; letter-spacing: 0.05em; border-bottom: 2px solid #002855; text-align: center; background: #00387A !important; background-color: #00387A !important;">Quantité</th>
                                        <th style="padding: 1rem; color: #ffffff !important; font-weight: 600; font-size: 0.875rem; text-transform: uppercase; letter-spacing: 0.05em; border-bottom: 2px solid #002855; text-align: center; background: #00387A !important; background-color: #00387A !important;">Unité</th>
                                        <th style="padding: 1rem; color: #ffffff !important; font-weight: 600; font-size: 0.875rem; text-transform: uppercase; letter-spacing: 0.05em; border-bottom: 2px solid #002855; background: #00387A !important; background-color: #00387A !important;">Spécifications</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${rfq.lignes.map((ligne, index) => `
                                        <tr style="border-bottom: 1px solid #e5e7eb; transition: background-color 0.2s ease; ${index % 2 === 0 ? 'background: #ffffff !important;' : 'background: #f9fafb !important;'}">
                                            <td style="padding: 1rem; color: #1f2937 !important; font-size: 0.9375rem; font-weight: 500; border-right: 1px solid #e5e7eb; background: inherit;">${ligne.description || '-'}</td>
                                            <td style="padding: 1rem; color: #111827 !important; font-size: 0.9375rem; font-weight: 600; text-align: center; border-right: 1px solid #e5e7eb; background: inherit;">${ligne.quantite || '-'}</td>
                                            <td style="padding: 1rem; color: #374151 !important; font-size: 0.9375rem; font-weight: 500; text-align: center; border-right: 1px solid #e5e7eb; background: inherit;">${ligne.unite || '-'}</td>
                                            <td style="padding: 1rem; color: #6b7280 !important; font-size: 0.9375rem; font-weight: 400; background: inherit;">${ligne.specifications || '-'}</td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    ` : ''}
                </div>
                
                <div id="related-rfqs-section" style="margin-top: 1.5rem;"></div>
                
                ${(user.role === 'admin' || user.role === 'superviseur') ? `
                    <div class="card" style="margin-top: 1.5rem; border-left: 4px solid var(--color-primary);">
                        <div class="card-header">
                            <h2 class="card-title"><i class="fas fa-external-link-alt"></i> Gestion fournisseur externe</h2>
                        </div>
                        <div style="padding: 1rem;">
                            <p style="margin-bottom: 1rem; color: #666;">
                                Si le fournisseur n'a pas de compte sur la plateforme, vous pouvez :
                            </p>
                            <div style="display: flex; gap: 1rem; flex-wrap: wrap; margin-bottom: 1.5rem;">
                                <button class="btn btn-primary" onclick="showGenerateLinkModal(${rfq.id}, ${rfq.destinataire_id})">
                                    <i class="fas fa-link"></i> Générer un lien de remplissage
                                </button>
                                <button class="btn btn-primary" onclick="showGenerateLinksForAllModal(${rfq.id})" style="background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%);">
                                    <i class="fas fa-link"></i> Générer des liens pour tous les fournisseurs
                                </button>
                                <button class="btn btn-success" onclick="exportRFQToExcel(${rfq.id})">
                                    <i class="fas fa-file-excel"></i> Exporter en Excel
                                </button>
                                <button class="btn btn-info" onclick="showImportDevisModal(${rfq.id})">
                                    <i class="fas fa-upload"></i> Importer un devis depuis Excel
                                </button>
                            </div>
                            <div id="external-links-section" style="margin-top: 1rem;">
                                <!-- Les liens générés apparaîtront ici -->
                            </div>
                        </div>
                    </div>
                ` : ''}
            `;
            
            // Ajouter la section fichiers joints
            container.innerHTML += '<div id="fichiers-joints-container"></div>';
            
            // Initialiser le gestionnaire de fichiers
            if (rfqId) {
                initFileUpload('rfq', rfqId, 'fichiers-joints-container');
            }
        }

        async function loadDevis(rfqId) {
            try {
                const response = await apiCall(`/api/devis?rfq_id=${rfqId}`);
                if (!response || !response.ok) {
                    console.error('Erreur chargement devis: réponse invalide');
                    displayDevis([]);
                    return;
                }

                const devis = await response.json();
                // S'assurer que devis est un tableau
                const devisArray = Array.isArray(devis) ? devis : [];
                displayDevis(devisArray);
            } catch (error) {
                console.error('Erreur chargement devis:', error);
                displayDevis([]);
            }
        }

        function displayDevis(devis) {
            const container = document.getElementById('devis-list');
            // S'assurer que devis est un tableau
            const devisArray = Array.isArray(devis) ? devis : [];
            document.getElementById('devis-count').textContent = `${devisArray.length} devis`;

            if (devisArray.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon"><i class="fas fa-briefcase"></i></div>
                        <div class="empty-state-title">Aucun devis reçu</div>
                        <div class="empty-state-text">Les devis des fournisseurs apparaîtront ici</div>
                    </div>
                `;
                return;
            }

            container.innerHTML = `
                <div style="display: grid; gap: 1rem;">
                    ${devisArray.map(d => `
                        <div class="card" style="border-left: 4px solid ${getDevisColor(d.statut)};">
                            <div style="display: flex; justify-content: space-between; align-items: start;">
                                <div style="flex: 1;">
                                    <h3 style="margin: 0 0 0.5rem 0;">
                                        ${d.numero || 'Devis-' + d.id} - ${d.fournisseur_nom || '-'}
                                    </h3>
                                    <div style="margin-bottom: 0.5rem;">
                                        <strong>Date:</strong> ${formatDate(d.date_emission)}<br>
                                        <strong>Validité:</strong> ${formatDate(d.date_validite) || 'Non spécifiée'}<br>
                                        <strong>Délai livraison:</strong> ${d.delai_livraison ? d.delai_livraison + ' jours' : '-'}
                                    </div>
                                    <div style="font-size: 1.25rem; font-weight: bold; color: var(--color-primary);">
                                        Total TTC: ${formatCurrency(d.total_ttc)}
                                    </div>
                                </div>
                                <div style="text-align: right;">
                                    <span class="badge ${getStatusBadge(d.statut)}">${getStatusLabel(d.statut)}</span>
                                    <div style="margin-top: 0.5rem; display: flex; gap: 0.5rem; flex-direction: column;">
                                        <button class="btn btn-secondary btn-sm" onclick="viewDevis(${d.id})"><i class="fas fa-eye"></i> Voir</button>
                                        <button class="btn btn-success btn-sm" onclick="accepterDevis(${d.id})"><i class="fas fa-check"></i> Accepter</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `).join('')}
                </div>
                <div style="margin-top: 1.5rem;">
                    <button class="btn btn-primary" onclick="compareDevis([${devisArray.map(d => d.id).join(',')}])">
                        <i class="fas fa-chart-bar"></i> Comparer les devis
                    </button>
                </div>
            `;
        }

        function getDevisColor(statut) {
            const colors = {
                'accepte': '#10B981',
                'envoye': '#3B82F6',
                'refuse': '#EF4444',
                'brouillon': '#64748B'
            };
            return colors[statut] || '#64748B';
        }

        function viewDevis(id) {
            window.location.href = `devis-detail.html?id=${id}`;
        }

        async function accepterDevis(devisId) {
            confirmAction(
                'Voulez-vous accepter ce devis et créer une commande ?',
                async () => {
                    try {
                        showLoading('Création de la commande...');
                        const devisResponse = await apiCall(`/api/devis/${devisId}`);
                        if (!devisResponse) {
                            hideLoading();
                            return;
                        }

                        const devis = await devisResponse.json();
                        
                        // Créer la commande depuis le devis
                        const commandeData = {
                            numero: `BC-${new Date().getFullYear()}-${Date.now()}`,
                            type_commande: 'BC',
                            date_commande: new Date().toISOString().split('T')[0],
                            devis_id: devisId,
                            rfq_id: devis.rfq_id,
                            lignes: devis.lignes.map(l => ({
                                produit_id: l.produit_id,
                                reference: l.reference,
                                description: l.description,
                                quantite: l.quantite,
                                unite: l.unite,
                                prix_unitaire_ht: l.prix_unitaire_ht,
                                remise: l.remise,
                                tva_taux: l.tva_taux
                            }))
                        };

                        const commandeResponse = await apiCall('/api/commandes', {
                            method: 'POST',
                            body: JSON.stringify(commandeData)
                        });

                        if (commandeResponse && commandeResponse.ok) {
                            // Mettre à jour le statut du devis
                            await apiCall(`/api/devis/${devisId}`, {
                                method: 'PATCH',
                                body: JSON.stringify({ statut: 'accepte' })
                            });

                            Toast.success('Commande créée avec succès');
                            setTimeout(() => {
                                window.location.href = 'commandes.html';
                            }, 1500);
                        } else {
                            const error = await commandeResponse.json();
                            Toast.error(error.error || 'Erreur lors de la création');
                        }
                    } catch (error) {
                        Toast.error('Erreur de connexion');
                    } finally {
                        hideLoading();
                    }
                }
            );
        }

        function compareDevis(devisIds) {
            window.location.href = `devis-compare.html?ids=${devisIds.join(',')}`;
        }

        async function envoyerRFQ(id) {
            confirmAction(
                'Envoyer cette RFQ aux fournisseurs ?',
                async () => {
                    try {
                        showLoading('Envoi...');
                        const response = await apiCall(`/api/rfq/${id}/statut`, {
                            method: 'PATCH',
                            body: JSON.stringify({ statut: 'envoye' })
                        });

                        if (response && response.ok) {
                            Toast.success('RFQ envoyée aux fournisseurs');
                            loadRFQDetails();
                        } else {
                            Toast.error('Erreur lors de l\'envoi');
                        }
                    } catch (error) {
                        Toast.error('Erreur de connexion');
                    } finally {
                        hideLoading();
                    }
                }
            );
        }

        // Fonctions pour la gestion des fournisseurs externes
        function showGenerateLinkModal(rfqId, fournisseurId) {
            const content = `
                <form id="generate-link-form" onsubmit="handleGenerateLink(event, ${rfqId}, ${fournisseurId})">
                    <div class="form-group">
                        <label>Email du fournisseur (optionnel)</label>
                        <input type="email" name="email" placeholder="fournisseur@example.com">
                        <small style="color: #666; font-size: 0.85rem;">
                            L'email sera utilisé pour envoyer le lien au fournisseur
                        </small>
                    </div>
                    <div class="form-group">
                        <label>Durée de validité du lien (en jours)</label>
                        <input type="number" name="jours" min="1" max="365" value="30" required>
                        <small style="color: #666; font-size: 0.85rem;">
                            Le lien expirera après le nombre de jours spécifié
                        </small>
                    </div>
                </form>
            `;

            const footer = `
                <button class="btn btn-secondary" onclick="Modal.hide('generate-link')">Annuler</button>
                <button class="btn btn-primary" onclick="document.getElementById('generate-link-form').requestSubmit()">
                    <i class="fas fa-link"></i> Générer le lien
                </button>
            `;

            // Utiliser la classe Modal correctement (méthode d'instance, pas statique)
            if (typeof Modal !== 'undefined') {
                const modal = new Modal('generate-link', 'Générer un lien externe', content, footer);
                modal.show();
            } else {
                console.error('Modal class not available');
                if (window.Toast) {
                    Toast.error('Erreur: système de modales non disponible');
                } else {
                    alert('Erreur: système de modales non disponible');
                }
            }
        }

        async function handleGenerateLink(event, rfqId, fournisseurId) {
            event.preventDefault();
            const formData = new FormData(event.target);
            const email = formData.get('email') || null;
            const jours = parseInt(formData.get('jours')) || 30;
            
            try {
                Modal.hide('generate-link');
                showLoading('Génération du lien...');
                const response = await apiCall(`/api/liens-externes/rfq/${rfqId}/generate-link`, {
                    method: 'POST',
                    body: JSON.stringify({
                        fournisseur_id: fournisseurId,
                        email_envoye: email,
                        date_expiration_jours: jours
                    })
                });

                if (response && response.ok) {
                    const data = await response.json();
                    hideLoading();
                    
                    // Afficher le lien
                    const linkSection = document.getElementById('external-links-section');
                    linkSection.innerHTML = `
                        <div class="card" style="background: #f0f9ff; border: 1px solid #3B82F6;">
                            <h4 style="margin-bottom: 0.5rem;"><i class="fas fa-check-circle" style="color: #10B981;"></i> Lien généré avec succès</h4>
                            <div style="margin: 1rem 0;">
                                <label style="font-weight: bold;">Lien de remplissage :</label>
                                <div style="display: flex; gap: 0.5rem; margin-top: 0.5rem;">
                                    <input type="text" id="generated-link" value="${data.link}" readonly 
                                           style="flex: 1; padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px;">
                                    <button class="btn btn-secondary" onclick="copyLink()">
                                        <i class="fas fa-copy"></i> Copier
                                    </button>
                                </div>
                            </div>
                            <p style="font-size: 0.9rem; color: #666; margin-top: 0.5rem;">
                                <i class="fas fa-info-circle"></i> Expire le : ${new Date(data.expiration).toLocaleDateString('fr-FR')}
                            </p>
                        </div>
                    `;
                    
                    Toast.success('Lien généré avec succès');
                    // Recharger les liens externes
                    loadExternalLinks(rfqId);
                } else {
                    const error = await response.json();
                    hideLoading();
                    Toast.error(error.error || 'Erreur lors de la génération du lien');
                }
            } catch (error) {
                hideLoading();
                Toast.error('Erreur de connexion');
                console.error('Erreur:', error);
            }
        }

        function copyLink() {
            const linkInput = document.getElementById('generated-link');
            linkInput.select();
            document.execCommand('copy');
            Toast.success('Lien copié dans le presse-papiers');
        }

        // Fonction pour générer des liens pour tous les fournisseurs
        async function showGenerateLinksForAllModal(rfqId) {
            // Récupérer toutes les RFQ liées (incluant la RFQ actuelle)
            const allRFQs = [currentRFQ, ...relatedRFQsList].filter(r => r && r.id);
            
            if (allRFQs.length === 0) {
                Toast.error('Aucun fournisseur trouvé pour cette demande');
                return;
            }

            const content = `
                <form id="generate-links-all-form" onsubmit="handleGenerateLinksForAll(event, ${rfqId})">
                    <div class="form-group">
                        <label>Durée de validité du lien (en jours)</label>
                        <input type="number" name="jours" min="1" max="365" value="30" required>
                        <small style="color: #666; font-size: 0.85rem;">
                            Le lien expirera après le nombre de jours spécifié pour tous les fournisseurs
                        </small>
                    </div>
                    <div class="form-group">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.75rem;">
                            <label style="font-weight: 600; margin: 0;">
                                <i class="fas fa-users"></i> Fournisseurs (<span id="selected-count-${rfqId}">${allRFQs.length}</span> sélectionné(s) sur ${allRFQs.length})
                            </label>
                            <div style="display: flex; gap: 0.5rem;">
                                <button type="button" onclick="selectAllFournisseurs${rfqId}()" 
                                        style="padding: 0.375rem 0.75rem; font-size: 0.875rem; background: #2563eb; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 500;">
                                    <i class="fas fa-check-double"></i> Tout sélectionner
                                </button>
                                <button type="button" onclick="deselectAllFournisseurs${rfqId}()" 
                                        style="padding: 0.375rem 0.75rem; font-size: 0.875rem; background: #64748b; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 500;">
                                    <i class="fas fa-times"></i> Tout désélectionner
                                </button>
                            </div>
                        </div>
                        <div id="fournisseurs-list-${rfqId}" style="max-height: 300px; overflow-y: auto; border: 1px solid #e5e7eb; border-radius: 8px; padding: 0.75rem; background: #f9fafb;">
                            ${allRFQs.map(rfq => `
                                <label class="fournisseur-item-${rfqId}" 
                                       style="display: flex; align-items: center; gap: 0.75rem; padding: 0.75rem; background: white; border-radius: 6px; margin-bottom: 0.5rem; border: 2px solid #2563eb; cursor: pointer; transition: all 0.2s;"
                                       onmouseover="this.style.background='#eff6ff'" 
                                       onmouseout="updateFournisseurItemStyle${rfqId}(this)">
                                    <input type="checkbox" name="rfq_ids" value="${rfq.id}" checked 
                                           class="rfq-checkbox-${rfqId}"
                                           onchange="updateSelectedCount${rfqId}(); updateFournisseurItemStyle${rfqId}(this.closest('label'))"
                                           style="width: 20px; height: 20px; cursor: pointer; accent-color: #2563eb; flex-shrink: 0;">
                                    <div style="flex: 1; min-width: 0;">
                                        <div style="font-weight: 600; color: #1e293b;">
                                            <i class="fas fa-building" style="color: #2563eb; margin-right: 0.5rem;"></i>
                                            ${rfq.destinataire_nom || 'Non spécifié'}
                                        </div>
                                        <div style="font-size: 0.875rem; color: #64748b; margin-top: 0.25rem;">
                                            <i class="fas fa-hashtag" style="color: #94a3b8;"></i> ${rfq.numero || 'RFQ-' + rfq.id}
                                        </div>
                                        ${rfq.destinataire_email ? `
                                            <div style="font-size: 0.875rem; color: #475569; margin-top: 0.25rem;">
                                                <i class="fas fa-envelope" style="color: #2563eb;"></i> ${rfq.destinataire_email}
                                            </div>
                                        ` : ''}
                                    </div>
                                    <div class="check-icon-${rfqId}" style="width: 24px; height: 24px; background: #2563eb; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-size: 0.75rem; flex-shrink: 0;">
                                        <i class="fas fa-check"></i>
                                    </div>
                                </label>
                            `).join('')}
                        </div>
                    </div>
                </form>
            `;
            
            // Ajouter le script après la création de la modal
            const scriptContent = `
                // Fonctions pour gérer la sélection multiple
                function selectAllFournisseurs${rfqId}() {
                    const checkboxes = document.querySelectorAll('.rfq-checkbox-${rfqId}');
                    checkboxes.forEach(cb => {
                        cb.checked = true;
                        updateFournisseurItemStyle${rfqId}(cb.closest('label'));
                    });
                    updateSelectedCount${rfqId}();
                }
                
                function deselectAllFournisseurs${rfqId}() {
                    const checkboxes = document.querySelectorAll('.rfq-checkbox-${rfqId}');
                    checkboxes.forEach(cb => {
                        cb.checked = false;
                        updateFournisseurItemStyle${rfqId}(cb.closest('label'));
                    });
                    updateSelectedCount${rfqId}();
                }
                
                function updateSelectedCount${rfqId}() {
                    const checkboxes = document.querySelectorAll('.rfq-checkbox-${rfqId}:checked');
                    const count = checkboxes.length;
                    const countEl = document.getElementById('selected-count-${rfqId}');
                    if (countEl) countEl.textContent = count;
                    
                    // Mettre à jour le bouton de génération
                    const submitBtn = document.querySelector('#modal-generate-links-all .btn-primary');
                    if (submitBtn) {
                        submitBtn.innerHTML = '<i class="fas fa-link"></i> Générer les liens (' + count + ')';
                    }
                }
                
                function updateFournisseurItemStyle${rfqId}(labelEl) {
                    if (!labelEl) return;
                    const checkbox = labelEl.querySelector('.rfq-checkbox-${rfqId}');
                    const checkIcon = labelEl.querySelector('.check-icon-${rfqId}');
                    
                    if (checkbox && checkbox.checked) {
                        labelEl.style.borderColor = '#2563eb';
                        labelEl.style.background = '#eff6ff';
                        labelEl.style.borderWidth = '2px';
                        if (checkIcon) checkIcon.style.display = 'flex';
                    } else {
                        labelEl.style.borderColor = '#e5e7eb';
                        labelEl.style.background = 'white';
                        labelEl.style.borderWidth = '2px';
                        if (checkIcon) checkIcon.style.display = 'none';
                    }
                }
                
                // Exposer les fonctions globalement
                window.selectAllFournisseurs${rfqId} = selectAllFournisseurs${rfqId};
                window.deselectAllFournisseurs${rfqId} = deselectAllFournisseurs${rfqId};
                window.updateSelectedCount${rfqId} = updateSelectedCount${rfqId};
                window.updateFournisseurItemStyle${rfqId} = updateFournisseurItemStyle${rfqId};
                
                // Initialiser les styles après le chargement de la modal
                setTimeout(() => {
                    document.querySelectorAll('.fournisseur-item-${rfqId}').forEach(label => {
                        updateFournisseurItemStyle${rfqId}(label);
                    });
                }, 100);
            `;

            const footer = `
                <button class="btn btn-secondary" onclick="Modal.hide('generate-links-all')">Annuler</button>
                <button class="btn btn-primary" onclick="document.getElementById('generate-links-all-form').requestSubmit()">
                    <i class="fas fa-link"></i> Générer les liens (${allRFQs.length})
                </button>
            `;

            if (typeof Modal !== 'undefined') {
                const modal = new Modal('generate-links-all', 'Générer des liens pour tous les fournisseurs', content, footer);
                modal.show();
                
                // Injecter le script après l'affichage de la modal
                setTimeout(() => {
                    const script = document.createElement('script');
                    script.textContent = scriptContent;
                    document.body.appendChild(script);
                }, 100);
            } else {
                console.error('Modal class not available');
                if (window.Toast) {
                    Toast.error('Erreur: système de modales non disponible');
                } else {
                    alert('Erreur: système de modales non disponible');
                }
            }
        }

        async function handleGenerateLinksForAll(event, currentRfqId) {
            event.preventDefault();
            const formData = new FormData(event.target);
            const jours = parseInt(formData.get('jours')) || 30;
            const selectedRfqIds = formData.getAll('rfq_ids').map(id => parseInt(id));
            
            if (selectedRfqIds.length === 0) {
                Toast.error('Veuillez sélectionner au moins un fournisseur');
                return;
            }

            try {
                Modal.hide('generate-links-all');
                showLoading(`Génération de ${selectedRfqIds.length} lien(s)...`);
                
                const results = [];
                const errors = [];
                
                // Générer un lien pour chaque RFQ sélectionnée
                for (const rfqId of selectedRfqIds) {
                    try {
                        // Récupérer les infos de la RFQ pour obtenir le fournisseur_id
                        const rfqResponse = await apiCall(`/api/rfq/${rfqId}`);
                        if (!rfqResponse || !rfqResponse.ok) {
                            errors.push({ rfqId, error: 'RFQ non trouvée' });
                            continue;
                        }
                        
                        const rfq = await rfqResponse.json();
                        if (!rfq.destinataire_id) {
                            errors.push({ rfqId, error: 'Fournisseur non trouvé' });
                            continue;
                        }
                        
                        // Générer le lien
                        const linkResponse = await apiCall(`/api/liens-externes/rfq/${rfqId}/generate-link`, {
                            method: 'POST',
                            body: JSON.stringify({
                                fournisseur_id: rfq.destinataire_id,
                                email_envoye: rfq.destinataire_email || null,
                                date_expiration_jours: jours
                            })
                        });
                        
                        if (linkResponse && linkResponse.ok) {
                            const linkData = await linkResponse.json();
                            results.push({
                                rfqId,
                                rfqNumero: rfq.numero,
                                fournisseurNom: rfq.destinataire_nom,
                                link: linkData.link,
                                expiration: linkData.expiration
                            });
                        } else {
                            const errorData = await linkResponse.json();
                            errors.push({ rfqId, error: errorData.error || 'Erreur inconnue' });
                        }
                    } catch (error) {
                        errors.push({ rfqId, error: error.message });
                    }
                }
                
                hideLoading();
                
                // Afficher les résultats
                const linkSection = document.getElementById('external-links-section');
                let html = '<div style="margin-top: 1rem;">';
                
                if (results.length > 0) {
                    html += `
                        <div class="card" style="background: #f0f9ff; border: 1px solid #3B82F6; margin-bottom: 1rem;">
                            <h4 style="margin-bottom: 1rem;">
                                <i class="fas fa-check-circle" style="color: #10B981;"></i> 
                                ${results.length} lien(s) généré(s) avec succès
                            </h4>
                            <div style="display: grid; gap: 1rem;">
                                ${results.map(r => `
                                    <div style="padding: 1rem; background: white; border-radius: 6px; border: 1px solid #cbd5e1;">
                                        <div style="font-weight: 600; color: #1e293b; margin-bottom: 0.5rem;">
                                            <i class="fas fa-building" style="color: #2563eb;"></i> ${r.fournisseurNom} (${r.rfqNumero})
                                        </div>
                                        <div style="display: flex; gap: 0.5rem; margin-top: 0.5rem;">
                                            <input type="text" value="${r.link}" readonly 
                                                   style="flex: 1; padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px; font-size: 0.875rem;">
                                            <button class="btn btn-sm btn-secondary" onclick="navigator.clipboard.writeText('${r.link}').then(() => { if(window.Toast) Toast.success('Lien copié'); })">
                                                <i class="fas fa-copy"></i>
                                            </button>
                                        </div>
                                        <div style="font-size: 0.8rem; color: #64748b; margin-top: 0.5rem;">
                                            Expire le : ${new Date(r.expiration).toLocaleDateString('fr-FR')}
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    `;
                }
                
                if (errors.length > 0) {
                    html += `
                        <div class="card" style="background: #fef2f2; border: 1px solid #ef4444; margin-bottom: 1rem;">
                            <h4 style="margin-bottom: 1rem; color: #dc2626;">
                                <i class="fas fa-exclamation-triangle"></i> 
                                ${errors.length} erreur(s)
                            </h4>
                            <ul style="list-style: none; padding: 0;">
                                ${errors.map(e => `<li style="padding: 0.5rem; color: #991b1b;">RFQ ${e.rfqId}: ${e.error}</li>`).join('')}
                            </ul>
                        </div>
                    `;
                }
                
                html += '</div>';
                linkSection.innerHTML = html;
                
                if (results.length > 0) {
                    Toast.success(`${results.length} lien(s) généré(s) avec succès`);
                }
                if (errors.length > 0) {
                    Toast.error(`${errors.length} erreur(s) lors de la génération`);
                }
                
                // Recharger les liens externes
                loadExternalLinks(currentRfqId);
            } catch (error) {
                hideLoading();
                Toast.error('Erreur de connexion');
                console.error('Erreur:', error);
            }
        }

        window.showGenerateLinksForAllModal = showGenerateLinksForAllModal;
        window.handleGenerateLinksForAll = handleGenerateLinksForAll;

        function exportRFQToExcel(rfqId) {
            window.open(`/api/excel/rfq/${rfqId}`, '_blank');
            Toast.success('Export Excel en cours...');
        }

        function showImportDevisModal(rfqId) {
            const content = `
                <form id="import-devis-form" onsubmit="handleImportDevis(event, ${rfqId})">
                    <div class="form-group">
                        <label>Fichier Excel retourné par le fournisseur *</label>
                        <input type="file" id="excel-file" name="file" accept=".xlsx,.xls" required>
                        <small style="color: #666; font-size: 0.85rem;">
                            Le fichier doit contenir les colonnes : Référence, Description, Quantité, Prix unitaire HT, Remise %, TVA %
                        </small>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Numéro de devis *</label>
                            <input type="text" name="numero" required placeholder="DEV-2024-001">
                        </div>
                        <div class="form-group">
                            <label>Date d'émission *</label>
                            <input type="date" name="date_emission" required>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Date de validité</label>
                            <input type="date" name="date_validite">
                        </div>
                        <div class="form-group">
                            <label>Délai de livraison (jours)</label>
                            <input type="number" name="delai_livraison" min="1" placeholder="30">
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Remise globale (%)</label>
                        <input type="number" name="remise_globale" min="0" max="100" step="0.01" value="0">
                    </div>
                    <div class="form-group">
                        <label>Conditions de paiement</label>
                        <textarea name="conditions_paiement" rows="2"></textarea>
                    </div>
                    <div class="form-group">
                        <label>Garanties</label>
                        <textarea name="garanties" rows="2"></textarea>
                    </div>
                    <div class="form-group">
                        <label>Notes</label>
                        <textarea name="notes" rows="2"></textarea>
                    </div>
                </form>
            `;

            const footer = `
                <button class="btn btn-secondary" onclick="Modal.hide('import-devis')">Annuler</button>
                <button class="btn btn-primary" onclick="document.getElementById('import-devis-form').requestSubmit()">
                    <i class="fas fa-upload"></i> Importer
                </button>
            `;

            // Utiliser la classe Modal correctement
            if (typeof Modal !== 'undefined') {
                const modal = new Modal('import-devis', 'Importer un devis depuis Excel', content, footer);
                modal.show();
            } else {
                console.error('Modal class not available');
                alert('Erreur: système de modales non disponible');
            }
            
            // Initialiser la date d'émission
            const dateInput = document.querySelector('#import-devis-form input[name="date_emission"]');
            if (dateInput) {
                dateInput.valueAsDate = new Date();
            }
        }

        async function handleImportDevis(event, rfqId) {
            event.preventDefault();
            const formData = new FormData(event.target);
            const fileInput = document.getElementById('excel-file');
            
            if (!fileInput.files || fileInput.files.length === 0) {
                Toast.error('Veuillez sélectionner un fichier Excel');
                return;
            }

            const file = fileInput.files[0];
            const uploadFormData = new FormData();
            uploadFormData.append('file', file);
            
            // Ajouter les autres champs
            for (const [key, value] of formData.entries()) {
                if (key !== 'file') {
                    uploadFormData.append(key, value);
                }
            }

            try {
                showLoading('Import du devis...');
                
                const token = localStorage.getItem('token');
                const response = await fetch(`/api/excel/import-devis/${rfqId}`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    },
                    body: uploadFormData
                });

                hideLoading();

                if (!response.ok) {
                    const error = await response.json();
                    Toast.error(error.error || 'Erreur lors de l\'import');
                    if (error.details_erreurs && error.details_erreurs.length > 0) {
                        console.error('Détails des erreurs:', error.details_erreurs);
                    }
                    return;
                }

                const result = await response.json();
                Modal.hide('import-devis');
                Toast.success(`Devis importé avec succès ! ${result.lignes_importees} lignes importées`);
                
                // Recharger les devis
                loadDevis(rfqId);
            } catch (error) {
                hideLoading();
                Toast.error('Erreur de connexion');
                console.error('Erreur:', error);
            }
        }

        // Charger les liens externes existants
        async function loadExternalLinks(rfqId) {
            try {
                const response = await apiCall(`/api/liens-externes/rfq/${rfqId}/links`);
                if (response && response.ok) {
                    const links = await response.json();
                    if (links.length > 0) {
                        const linkSection = document.getElementById('external-links-section');
                        linkSection.innerHTML = `
                            <h4 style="margin-bottom: 1rem;"><i class="fas fa-link"></i> Liens générés</h4>
                            <div style="display: grid; gap: 0.5rem;">
                                ${links.map(link => `
                                    <div class="card" style="padding: 0.75rem; background: ${link.utilise ? '#f5f5f5' : '#f0f9ff'};">
                                        <div style="display: flex; justify-content: space-between; align-items: center;">
                                            <div>
                                                <strong>${link.fournisseur_nom || 'Fournisseur'}</strong>
                                                ${link.utilise ? '<span class="badge badge-success" style="margin-left: 0.5rem;">Utilisé</span>' : '<span class="badge badge-warning" style="margin-left: 0.5rem;">En attente</span>'}
                                                <div style="font-size: 0.85rem; color: #666; margin-top: 0.25rem;">
                                                    ${link.email_envoye ? `Envoyé à: ${link.email_envoye}` : ''}
                                                    ${link.date_utilisation ? ` | Utilisé le: ${new Date(link.date_utilisation).toLocaleDateString('fr-FR')}` : ''}
                                                </div>
                                            </div>
                                            ${!link.utilise ? `
                                                <a href="${window.location.origin}/devis-externe.html?token=${link.token}" 
                                                   target="_blank" class="btn btn-sm btn-primary">
                                                    <i class="fas fa-external-link-alt"></i> Voir le lien
                                                </a>
                                            ` : ''}
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        `;
                    }
                }
            } catch (error) {
                console.error('Erreur chargement liens externes:', error);
            }
        }

        // Modifier la fonction loadRFQDetails pour charger les liens externes
        const originalLoadRFQDetails = loadRFQDetails;
        async function loadRFQDetailsWithLinks() {
            await originalLoadRFQDetails();
            if (user.role === 'admin' || user.role === 'superviseur') {
                loadExternalLinks(rfqId);
            }
        }

        // Remplacer l'appel original
        loadRFQDetailsWithLinks();
        
        // Menu mobile
        function toggleMobileMenu() {
            const menu = document.getElementById('mobile-menu');
            const button = document.getElementById('mobile-menu-button');
            if (menu && button) {
                const isHidden = menu.classList.contains('hidden');
                menu.classList.toggle('hidden');
                button.setAttribute('aria-expanded', isHidden ? 'true' : 'false');
                const icon = button.querySelector('i');
                if (icon) {
                    if (isHidden) {
                        icon.classList.remove('fa-bars');
                        icon.classList.add('fa-times');
                    } else {
                        icon.classList.remove('fa-times');
                        icon.classList.add('fa-bars');
                    }
                }
            }
        }
        window.toggleMobileMenu = toggleMobileMenu;
    </script>
</body>
</html>

