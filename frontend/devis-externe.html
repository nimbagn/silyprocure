<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Répondre à une demande de devis - SilyProcure</title>
    
    <!-- CSS Charte Graphique Pro Confiance -->
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="css/responsive.css">
    <link rel="stylesheet" href="css/animations.css">
    
        <!-- Tailwind CSS (optimisé pour production) -->
    <link rel="stylesheet" href="css/tailwind.css">
    
    <!-- Font Awesome & Google Fonts -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Dashboard Theme CSS -->
    <link rel="stylesheet" href="css/dashboard-theme.css">
    <!-- Modern Theme (inspiré de home.html) -->
    <link rel="stylesheet" href="css/modern-theme.css">

    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        /* Override pour utiliser le style moderne de home.html */
        body {
            font-family: "Plus Jakarta Sans", sans-serif !important;
            background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 50%, #f8fafc 100%) !important;
            min-height: 100vh;
        }
        
        /* Utiliser brand-600 au lieu de primary-500 */
        .text-primary-600, .text-primary-500 { color: #2563eb !important; }
        .bg-primary-600, .bg-primary-500 { background-color: #2563eb !important; }
        .border-primary-500 { border-color: #2563eb !important; }
        
        /* Améliorer les cartes */
        .card, .stat-card, .facture-card, .filters-card, .kpi-card {
            border-radius: 1.5rem !important;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1) !important;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1) !important;
            background: white !important;
        }
        
        .card:hover, .facture-card:hover {
            transform: translateY(-4px) !important;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 8px 10px -6px rgba(0, 0, 0, 0.1) !important;
        }
        
        /* Header moderne */
        .public-header {
            background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%);
            color: white;
            padding: 2rem 1rem;
            text-align: center;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            margin-bottom: 2rem;
        }
        
        .public-header .logo {
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
            letter-spacing: -0.5px;
        }
        
        .public-header .subtitle {
            font-size: 1.1rem;
            opacity: 0.95;
            font-weight: 500;
        }
        
        /* Amélioration des sections RFQ */
        #rfq-info {
            background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
            border-left: 4px solid #2563eb;
        }
        
        #rfq-info h2 {
            color: #1e293b;
            font-size: 1.5rem;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }
        
        #rfq-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1rem;
            margin-top: 1rem;
        }
        
        #rfq-details p {
            padding: 0.75rem;
            background: white;
            border-radius: 8px;
            margin: 0;
            border-left: 3px solid #2563eb;
        }
        
        #rfq-details strong {
            color: #1e293b;
            display: block;
            margin-bottom: 0.25rem;
            font-size: 0.875rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: #64748b;
        }
        
        /* Amélioration des lignes de devis */
        #devis-lignes .card {
            border-left: 4px solid #10b981;
            transition: all 0.3s ease;
        }
        
        #devis-lignes .card:hover {
            border-left-color: #059669;
            box-shadow: 0 8px 16px -4px rgba(16, 185, 129, 0.2);
        }
        
        /* Section totaux améliorée */
        .totals-section {
            background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%);
            border: 2px solid #10b981;
            border-radius: 12px;
            padding: 1.5rem;
            margin-top: 2rem;
        }
        
        .total-line {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem 0;
            font-size: 1rem;
        }
        
        .total-line.total-ttc {
            border-top: 2px solid #10b981;
            margin-top: 1rem;
            padding-top: 1rem;
            font-size: 1.5rem;
            font-weight: 700;
            color: #059669;
        }
        
        /* Amélioration des inputs */
        input[type="text"],
        input[type="number"],
        input[type="date"],
        textarea,
        select {
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            padding: 0.75rem;
            transition: all 0.2s ease;
        }
        
        input[type="text"]:focus,
        input[type="number"]:focus,
        input[type="date"]:focus,
        textarea:focus,
        select:focus {
            border-color: #2563eb;
            outline: none;
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }
        
        /* Bouton amélioré */
        .btn-success {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            border: none;
            padding: 1rem 2rem;
            font-size: 1.1rem;
            font-weight: 600;
            box-shadow: 0 4px 6px -1px rgba(16, 185, 129, 0.3);
            transition: all 0.3s ease;
        }
        
        .btn-success:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 12px -2px rgba(16, 185, 129, 0.4);
        }
        
        /* Messages d'état */
        .error-message, .success-message {
            text-align: center;
            padding: 3rem 2rem;
            border-radius: 1rem;
            max-width: 600px;
            margin: 2rem auto;
        }
        
        .error-message {
            background: linear-gradient(135deg, #fef2f2 0%, #fee2e2 100%);
            border: 2px solid #ef4444;
            color: #991b1b;
        }
        
        .success-message {
            background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%);
            border: 2px solid #10b981;
            color: #059669;
        }
        
        .error-message i, .success-message i {
            font-size: 4rem;
            margin-bottom: 1rem;
        }
        
        /* Responsive */
        @media (max-width: 768px) {
            .public-header {
                padding: 1.5rem 1rem;
            }
            
            .public-header .logo {
                font-size: 1.5rem;
            }
            
            #rfq-details {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body class="h-full flex flex-col">
    <div class="public-header">
        <div class="logo">
            <i class="fas fa-file-contract" style="margin-right: 0.5rem;"></i>
            SilyProcure
        </div>
        <div class="subtitle">
            <i class="fas fa-handshake" style="margin-right: 0.5rem;"></i>
            Répondre à une demande de devis
        </div>
    </div>

    <div class="container" id="main-container">
        <div id="loading-state" class="card" style="text-align: center; padding: 3rem;">
            <div class="loading"><div class="loading-spinner"></div> Chargement de la demande de devis...</div>
        </div>

        <div id="error-state" style="display: none;">
            <div class="error-message">
                <i class="fas fa-exclamation-triangle"></i>
                <h2>Lien invalide</h2>
                <p id="error-text"></p>
            </div>
        </div>

        <div id="success-state" style="display: none;">
            <div class="success-message">
                <i class="fas fa-check-circle"></i>
                <h2>Devis soumis avec succès !</h2>
                <p>Votre devis a été reçu et sera traité dans les plus brefs délais.</p>
                <p style="margin-top: 1rem; font-size: 0.9rem; opacity: 0.8;">
                    Vous pouvez fermer cette page.
                </p>
            </div>
        </div>

        <div id="form-state" style="display: none;">
            <div id="rfq-info" class="card" style="margin-bottom: 1.5rem;">
                <h2><i class="fas fa-file-alt"></i> Demande de devis</h2>
                <div id="rfq-details"></div>
            </div>

            <div class="card">
                <div class="card-header">
                    <h2 class="card-title"><i class="fas fa-edit"></i> Formulaire de devis</h2>
                </div>

                <form id="devis-form" onsubmit="handleSubmitDevis(event)">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="devis-numero">Numéro de devis *</label>
                            <input type="text" id="devis-numero" name="numero" required placeholder="DEV-2024-001">
                        </div>
                        <div class="form-group">
                            <label for="devis-date">Date d'émission *</label>
                            <input type="date" id="devis-date" name="date_emission" required>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="devis-date-validite">Date de validité</label>
                            <input type="date" id="devis-date-validite" name="date_validite">
                        </div>
                        <div class="form-group">
                            <label for="devis-delai-livraison">Délai de livraison (jours)</label>
                            <input type="number" id="devis-delai-livraison" name="delai_livraison" min="1" placeholder="30">
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="devis-remise-globale">Remise globale (%)</label>
                        <input type="number" id="devis-remise-globale" name="remise_globale" min="0" max="100" step="0.01" value="0" onchange="calculateTotals()">
                    </div>

                    <div style="margin: 2rem 0 1.5rem 0; padding: 1rem; background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%); border-radius: 12px; border-left: 4px solid #2563eb;">
                        <h3 style="margin: 0; color: #1e293b; font-size: 1.25rem; display: flex; align-items: center; gap: 0.75rem;">
                            <i class="fas fa-box" style="color: #2563eb;"></i> 
                            Lignes de devis
                            <span style="font-size: 0.9rem; font-weight: 500; color: #64748b; margin-left: auto;" id="lignes-count">0 article(s)</span>
                        </h3>
                        <p style="margin: 0.5rem 0 0 0; color: #64748b; font-size: 0.9rem;">
                            Remplissez les prix pour chaque article demandé. Les totaux se calculent automatiquement.
                        </p>
                    </div>
                    <div id="devis-lignes">
                        <!-- Les lignes seront générées depuis la RFQ -->
                    </div>

                    <div class="totals-section">
                        <h3 style="margin: 0 0 1rem 0; color: #059669; font-size: 1.25rem; display: flex; align-items: center; gap: 0.5rem;">
                            <i class="fas fa-calculator"></i> Récapitulatif financier
                        </h3>
                        <div class="total-line">
                            <span style="color: #475569; font-weight: 600;">
                                <i class="fas fa-receipt" style="color: #64748b; margin-right: 0.5rem;"></i>
                                Total HT
                            </span>
                            <strong id="total-ht" style="color: #1e293b; font-size: 1.1rem;">0 GNF</strong>
                        </div>
                        <div class="total-line">
                            <span style="color: #475569; font-weight: 600;">
                                <i class="fas fa-percent" style="color: #64748b; margin-right: 0.5rem;"></i>
                                TVA
                            </span>
                            <strong id="total-tva" style="color: #1e293b; font-size: 1.1rem;">0 GNF</strong>
                        </div>
                        <div class="total-line total-ttc">
                            <span style="display: flex; align-items: center; gap: 0.5rem;">
                                <i class="fas fa-money-bill-wave"></i>
                                Total TTC
                            </span>
                            <strong id="total-ttc" style="color: #059669;">0 GNF</strong>
                        </div>
                    </div>

                    <div style="padding: 1rem; background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%); border-radius: 12px; margin-top: 2rem; border: 1px solid #e2e8f0;">
                        <h3 style="margin: 0 0 1rem 0; color: #1e293b; font-size: 1.1rem; display: flex; align-items: center; gap: 0.5rem;">
                            <i class="fas fa-file-contract" style="color: #2563eb;"></i>
                            Informations complémentaires
                        </h3>
                        <div class="form-group">
                            <label for="devis-conditions-paiement" style="display: flex; align-items: center; gap: 0.5rem;">
                                <i class="fas fa-credit-card" style="color: #64748b;"></i>
                                Conditions de paiement
                            </label>
                            <textarea id="devis-conditions-paiement" name="conditions_paiement" rows="2" 
                                      placeholder="Ex: 30% à la commande, 70% à la livraison"></textarea>
                        </div>

                        <div class="form-group">
                            <label for="devis-garanties" style="display: flex; align-items: center; gap: 0.5rem;">
                                <i class="fas fa-shield-alt" style="color: #64748b;"></i>
                                Garanties
                            </label>
                            <textarea id="devis-garanties" name="garanties" rows="2" 
                                      placeholder="Garanties offertes..."></textarea>
                        </div>

                        <div class="form-group">
                            <label for="devis-certifications" style="display: flex; align-items: center; gap: 0.5rem;">
                                <i class="fas fa-certificate" style="color: #64748b;"></i>
                                Certifications
                            </label>
                            <textarea id="devis-certifications" name="certifications" rows="2" 
                                      placeholder="Certifications disponibles..."></textarea>
                        </div>

                        <div class="form-group">
                            <label for="devis-notes" style="display: flex; align-items: center; gap: 0.5rem;">
                                <i class="fas fa-sticky-note" style="color: #64748b;"></i>
                                Notes
                            </label>
                            <textarea id="devis-notes" name="notes" rows="3" 
                                      placeholder="Informations complémentaires..."></textarea>
                        </div>
                    </div>

                    <div style="margin-top: 1.5rem; display: flex; gap: 1rem;">
                        <button type="submit" class="btn btn-success" style="flex: 1;">
                            <i class="fas fa-paper-plane"></i> Envoyer le devis
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script src="js/components.js?v=20260116"></script>
    <script>
        const urlParams = new URLSearchParams(window.location.search);
        const token = urlParams.get('token');
        let rfqData = null;

        // Initialiser la date
        const today = new Date();
        document.getElementById('devis-date').valueAsDate = today;
        const dateValidite = new Date();
        dateValidite.setDate(dateValidite.getDate() + 30);
        document.getElementById('devis-date-validite').valueAsDate = dateValidite;

        function showError(message) {
            document.getElementById('loading-state').style.display = 'none';
            document.getElementById('form-state').style.display = 'none';
            document.getElementById('error-state').style.display = 'block';
            document.getElementById('error-text').textContent = message;
        }

        function displayRFQ(data) {
            const rfq = data.rfq;
            const fournisseur = data.fournisseur;

            const details = `
                <div style="margin-top: 1rem;">
                    <p>
                        <strong><i class="fas fa-hashtag" style="color: #2563eb; margin-right: 0.5rem;"></i> Numéro RFQ</strong>
                        <span style="color: #1e293b; font-weight: 600; font-size: 1.1rem;">${rfq.numero || 'N/A'}</span>
                    </p>
                    <p>
                        <strong><i class="fas fa-calendar-alt" style="color: #2563eb; margin-right: 0.5rem;"></i> Date d'émission</strong>
                        <span style="color: #1e293b;">${rfq.date_emission ? new Date(rfq.date_emission).toLocaleDateString('fr-FR', { day: 'numeric', month: 'long', year: 'numeric' }) : 'N/A'}</span>
                    </p>
                    <p>
                        <strong><i class="fas fa-clock" style="color: #f59e0b; margin-right: 0.5rem;"></i> Date limite de réponse</strong>
                        <span style="color: #1e293b; font-weight: 600;">${rfq.date_limite_reponse ? new Date(rfq.date_limite_reponse).toLocaleDateString('fr-FR', { day: 'numeric', month: 'long', year: 'numeric' }) : 'Non spécifiée'}</span>
                    </p>
                    ${rfq.emetteur ? `
                        <p>
                            <strong><i class="fas fa-user" style="color: #2563eb; margin-right: 0.5rem;"></i> Émetteur</strong>
                            <span style="color: #1e293b;">${rfq.emetteur.nom || rfq.emetteur.prenom ? `${rfq.emetteur.prenom || ''} ${rfq.emetteur.nom || ''}`.trim() : rfq.emetteur.email || 'N/A'}</span>
                        </p>
                    ` : ''}
                    ${rfq.description ? `
                        <p style="grid-column: 1 / -1;">
                            <strong><i class="fas fa-align-left" style="color: #2563eb; margin-right: 0.5rem;"></i> Description</strong>
                            <div style="color: #475569; margin-top: 0.5rem; line-height: 1.6;">${rfq.description}</div>
                        </p>
                    ` : ''}
                </div>
            `;

            document.getElementById('rfq-details').innerHTML = details;
            document.getElementById('loading-state').style.display = 'none';
            document.getElementById('form-state').style.display = 'block';
        }

        function displayLignes(lignes) {
            const container = document.getElementById('devis-lignes');
            container.innerHTML = '';

            lignes.forEach((ligne, index) => {
                const ligneDiv = document.createElement('div');
                ligneDiv.className = 'card';
                ligneDiv.style.marginBottom = '1rem';
                ligneDiv.style.padding = '1rem';
                ligneDiv.innerHTML = `
                    <div style="display: flex; align-items: center; gap: 0.75rem; margin-bottom: 1rem; padding-bottom: 1rem; border-bottom: 2px solid #e5e7eb;">
                        <div style="width: 40px; height: 40px; background: linear-gradient(135deg, #10b981 0%, #059669 100%); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-weight: 700; font-size: 1.1rem; flex-shrink: 0;">
                            ${index + 1}
                        </div>
                        <div style="flex: 1;">
                            <h4 style="margin: 0 0 0.25rem 0; color: #1e293b; font-size: 1.1rem; font-weight: 700;">
                                ${ligne.reference ? `<span style="color: #64748b; font-size: 0.9rem; font-weight: 500;">Réf: ${ligne.reference}</span>` : 'Article sans référence'}
                            </h4>
                            <p style="margin: 0; color: #475569; line-height: 1.5;">
                                ${ligne.description || 'Aucune description'}
                            </p>
                        </div>
                    </div>
                    <div class="form-row" style="margin-bottom: 1rem;">
                        <div class="form-group">
                            <label style="display: flex; align-items: center; gap: 0.5rem;">
                                <i class="fas fa-box" style="color: #64748b;"></i>
                                Quantité demandée
                            </label>
                            <input type="number" value="${ligne.quantite || 1}" disabled style="background: #f1f5f9; border: 2px solid #e2e8f0; color: #64748b; font-weight: 600;">
                        </div>
                        <div class="form-group">
                            <label style="display: flex; align-items: center; gap: 0.5rem;">
                                <i class="fas fa-ruler" style="color: #64748b;"></i>
                                Unité
                            </label>
                            <input type="text" value="${ligne.unite || 'unité'}" disabled style="background: #f1f5f9; border: 2px solid #e2e8f0; color: #64748b; font-weight: 600;">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label style="display: flex; align-items: center; gap: 0.5rem; color: #1e293b; font-weight: 600;">
                                <i class="fas fa-money-bill-wave" style="color: #10b981;"></i>
                                Prix unitaire HT (GNF) *
                            </label>
                            <input type="number" name="ligne-prix[]" min="0" step="0.01" required 
                                   onchange="calculateTotals()" placeholder="0.00"
                                   style="font-size: 1.1rem; font-weight: 600;">
                            <small style="color: #64748b; font-size: 0.85rem; margin-top: 0.25rem; display: block;">
                                Prix hors taxes pour une unité
                            </small>
                        </div>
                        <div class="form-group">
                            <label style="display: flex; align-items: center; gap: 0.5rem; color: #1e293b; font-weight: 600;">
                                <i class="fas fa-percent" style="color: #f59e0b;"></i>
                                Remise (%)
                            </label>
                            <input type="number" name="ligne-remise[]" min="0" max="100" step="0.01" value="0" 
                                   onchange="calculateTotals()" placeholder="0">
                            <small style="color: #64748b; font-size: 0.85rem; margin-top: 0.25rem; display: block;">
                                Remise sur cette ligne
                            </small>
                        </div>
                        <div class="form-group">
                            <label style="display: flex; align-items: center; gap: 0.5rem; color: #1e293b; font-weight: 600;">
                                <i class="fas fa-receipt" style="color: #2563eb;"></i>
                                TVA (%)
                            </label>
                            <input type="number" name="ligne-tva[]" min="0" max="100" step="0.01" value="20" 
                                   onchange="calculateTotals()">
                            <small style="color: #64748b; font-size: 0.85rem; margin-top: 0.25rem; display: block;">
                                Taux de TVA applicable
                            </small>
                        </div>
                    </div>
                    <input type="hidden" name="ligne-rfq-id[]" value="${ligne.id}">
                    <input type="hidden" name="ligne-quantite[]" value="${ligne.quantite || 1}">
                    <input type="hidden" name="ligne-unite[]" value="${ligne.unite || 'unité'}">
                    <input type="hidden" name="ligne-description[]" value="${ligne.description || ''}">
                    <input type="hidden" name="ligne-reference[]" value="${ligne.reference || ''}">
                `;
                container.appendChild(ligneDiv);
            });
        }

        function calculateTotals() {
            const prixInputs = document.querySelectorAll('input[name="ligne-prix[]"]');
            const remiseInputs = document.querySelectorAll('input[name="ligne-remise[]"]');
            const tvaInputs = document.querySelectorAll('input[name="ligne-tva[]"]');
            const quantiteInputs = document.querySelectorAll('input[name="ligne-quantite[]"]');
            const remiseGlobale = parseFloat(document.getElementById('devis-remise-globale').value) || 0;

            let totalHT = 0;
            let totalTVA = 0;

            prixInputs.forEach((prixInput, index) => {
                const prix = parseFloat(prixInput.value) || 0;
                const quantite = parseFloat(quantiteInputs[index].value) || 1;
                const remise = parseFloat(remiseInputs[index].value) || 0;
                const tva = parseFloat(tvaInputs[index].value) || 20;

                const prixHTLigne = prix * quantite;
                const remiseLigne = prixHTLigne * (remise / 100);
                const ligneHT = prixHTLigne - remiseLigne;
                const ligneTVA = ligneHT * (tva / 100);

                totalHT += ligneHT;
                totalTVA += ligneTVA;
            });

            // Appliquer la remise globale
            totalHT = totalHT * (1 - remiseGlobale / 100);
            totalTVA = totalTVA * (1 - remiseGlobale / 100);
            const totalTTC = totalHT + totalTVA;

            document.getElementById('total-ht').textContent = formatCurrency(totalHT);
            document.getElementById('total-tva').textContent = formatCurrency(totalTVA);
            document.getElementById('total-ttc').textContent = formatCurrency(totalTTC);
        }

        function formatCurrency(amount) {
            return new Intl.NumberFormat('fr-FR', {
                minimumFractionDigits: 0,
                maximumFractionDigits: 0
            }).format(amount) + ' GNF';
        }

        async function handleSubmitDevis(event) {
            event.preventDefault();
            const formData = new FormData(event.target);

            const prix = formData.getAll('ligne-prix[]');
            const remises = formData.getAll('ligne-remise[]');
            const tvas = formData.getAll('ligne-tva[]');
            const quantites = formData.getAll('ligne-quantite[]');
            const descriptions = formData.getAll('ligne-description[]');
            const unites = formData.getAll('ligne-unite[]');
            const rfqLigneIds = formData.getAll('ligne-rfq-id[]');
            const references = formData.getAll('ligne-reference[]');

            const lignes = [];
            for (let i = 0; i < prix.length; i++) {
                if (prix[i] && parseFloat(prix[i]) > 0) {
                    lignes.push({
                        rfq_ligne_id: parseInt(rfqLigneIds[i]),
                        quantite: parseFloat(quantites[i]) || 1,
                        unite: unites[i] || 'unité',
                        prix_unitaire_ht: parseFloat(prix[i]),
                        remise: parseFloat(remises[i]) || 0,
                        tva_taux: parseFloat(tvas[i]) || 20,
                        description: descriptions[i] || '',
                        reference: references[i] || '',
                        ordre: i
                    });
                }
            }

            if (lignes.length === 0) {
                if (typeof Toast !== 'undefined') {
                    Toast.error('Veuillez remplir au moins une ligne avec un prix');
                } else {
                    alert('Veuillez remplir au moins une ligne avec un prix');
                }
                return;
            }

            const devisData = {
                numero: formData.get('numero'),
                date_emission: formData.get('date_emission'),
                date_validite: formData.get('date_validite') || null,
                delai_livraison: formData.get('delai_livraison') ? parseInt(formData.get('delai_livraison')) : null,
                remise_globale: parseFloat(formData.get('remise_globale')) || 0,
                conditions_paiement: formData.get('conditions_paiement') || null,
                garanties: formData.get('garanties') || null,
                certifications: formData.get('certifications') || null,
                notes: formData.get('notes') || null,
                lignes: lignes
            };

            try {
                showLoading('Envoi du devis...');

                const response = await fetch('/api/liens-externes/submit-devis-externe', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        token: token,
                        devis_data: devisData
                    })
                });

                hideLoading();

                if (!response.ok) {
                    const error = await response.json();
                    if (typeof Toast !== 'undefined') {
                        Toast.error(error.error || 'Erreur lors de l\'envoi du devis');
                    } else {
                        alert(error.error || 'Erreur lors de l\'envoi du devis');
                    }
                    return;
                }

                // Afficher le message de succès
                document.getElementById('form-state').style.display = 'none';
                document.getElementById('success-state').style.display = 'block';
            } catch (error) {
                hideLoading();
                console.error('Erreur soumission devis:', error);
                if (typeof Toast !== 'undefined') {
                    Toast.error('Erreur de connexion');
                } else {
                    alert('Erreur de connexion');
                }
            }
        }

        function showLoading(message) {
            // Simple loading indicator
            const btn = document.querySelector('button[type="submit"]');
            if (btn) {
                btn.disabled = true;
                btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Envoi en cours...';
            }
        }

        function hideLoading() {
            const btn = document.querySelector('button[type="submit"]');
            if (btn) {
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-paper-plane"></i> Envoyer le devis';
            }
        }

        // Fonction pour charger la RFQ
        async function loadRFQ() {
            try {
                const response = await fetch(`/api/liens-externes/rfq-by-token/${token}`);
                
                if (!response.ok) {
                    const error = await response.json();
                    showError(error.error || 'Erreur lors du chargement de la demande de devis');
                    return;
                }

                const data = await response.json();
                rfqData = data;
                displayRFQ(data);
                displayLignes(data.rfq.lignes);
                
                // Mettre à jour le compteur de lignes
                const countEl = document.getElementById('lignes-count');
                if (countEl) {
                    countEl.textContent = `${data.rfq.lignes.length} article(s)`;
                }
            } catch (error) {
                console.error('Erreur chargement RFQ:', error);
                showError('Erreur de connexion au serveur');
            }
        }

        // Charger la RFQ au chargement de la page si le token est présent
        if (!token) {
            showError('Token manquant dans l\'URL');
        } else {
            loadRFQ();
        }
    </script>
</body>
</html>

