<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>D√©tails Devis - SilyProcure</title>
    
    <!-- CSS Charte Graphique Pro Confiance -->
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="css/responsive.css">
    <link rel="stylesheet" href="css/animations.css">
    
        <!-- Tailwind CSS (optimis√© pour production) -->
    <link rel="stylesheet" href="css/tailwind.css">
    
    <!-- Font Awesome & Google Fonts -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Dashboard Theme CSS -->
    <link rel="stylesheet" href="css/dashboard-theme.css">
    <!-- Modern Theme (inspir√© de home.html) -->
    <link rel="stylesheet" href="css/modern-theme.css">

    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        /* Override pour utiliser le style moderne de home.html */
        body {
            font-family: "Plus Jakarta Sans", sans-serif !important;
            background: #f8fafc !important;
        }
        
        /* Utiliser brand-600 au lieu de primary-500 */
        .text-primary-600, .text-primary-500 { color: #2563eb !important; }
        .bg-primary-600, .bg-primary-500 { background-color: #2563eb !important; }
        .border-primary-500 { border-color: #2563eb !important; }
        
        /* Am√©liorer les cartes */
        .card, .stat-card, .facture-card, .filters-card, .kpi-card {
            border-radius: 1.5rem !important;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1) !important;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1) !important;
        }
        
        .card:hover, .facture-card:hover {
            transform: translateY(-4px) !important;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 8px 10px -6px rgba(0, 0, 0, 0.1) !important;
        }
    </style>
</head>
<body class="h-full flex flex-col">
        <!-- Navbar Moderne selon charte Pro Confiance -->
    <nav class="bg-white border-b-2 border-blue-100 sticky top-0 z-50 shadow-sm" role="navigation" aria-label="Navigation principale">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-16">
                <!-- Logo & Nav Links -->
                <div class="flex items-center">
                    <div class="flex-shrink-0 flex items-center cursor-pointer" onclick="window.location.href='dashboard.html'">
                        <span class="text-2xl font-bold logo-primary">Sily<span class="text-gray-900">Procure</span></span>
                    </div>
                    <nav class="hidden sm:ml-6 sm:flex sm:space-x-1 md:ml-8" aria-label="Menu de navigation">
                        <a href="dashboard.html" class="border-transparent text-neutral-500 hover:border-primary-300 hover:text-primary-700 font-medium inline-flex items-center px-3 sm:px-4 py-2 border-b-2 text-sm transition-colors min-h-[44px] whitespace-nowrap" >
                            <i class="fas fa-chart-line mr-1.5 sm:mr-2 text-xs sm:text-sm" aria-hidden="true"></i>
                            <span>Dashboard</span>
                        </a>
                        <a href="rfq.html" class="border-transparent text-neutral-500 hover:border-primary-300 hover:text-primary-700 font-medium inline-flex items-center px-3 sm:px-4 py-2 border-b-2 text-sm transition-colors min-h-[44px] whitespace-nowrap" >
                            <i class="fas fa-file-contract mr-1.5 sm:mr-2 text-xs sm:text-sm" aria-hidden="true"></i>
                            <span>RFQ</span>
                        </a>
                        <a href="devis.html" class="border-primary-500 text-primary-900 font-semibold inline-flex items-center px-3 sm:px-4 py-2 border-b-2 text-sm transition-colors min-h-[44px] whitespace-nowrap" aria-current="page">
                            <i class="fas fa-file-invoice-dollar mr-1.5 sm:mr-2 text-xs sm:text-sm" aria-hidden="true"></i>
                            <span>Devis</span>
                        </a>
                        <a href="commandes.html" class="border-transparent text-neutral-500 hover:border-primary-300 hover:text-primary-700 font-medium inline-flex items-center px-3 sm:px-4 py-2 border-b-2 text-sm transition-colors min-h-[44px] whitespace-nowrap" >
                            <i class="fas fa-shopping-cart mr-1.5 sm:mr-2 text-xs sm:text-sm" aria-hidden="true"></i>
                            <span>Commandes</span>
                        </a>
                        <a href="entreprises.html" class="border-transparent text-neutral-500 hover:border-primary-300 hover:text-primary-700 font-medium inline-flex items-center px-3 sm:px-4 py-2 border-b-2 text-sm transition-colors min-h-[44px] whitespace-nowrap" >
                            <i class="fas fa-building mr-1.5 sm:mr-2 text-xs sm:text-sm" aria-hidden="true"></i>
                            <span>Entreprises</span>
                        </a>
                    </nav>
                </div>

                <!-- Search Bar & Profile -->
                <div class="flex items-center gap-4">
                    <!-- Global Search -->
                    <div class="hidden lg:block relative text-neutral-500 focus-within:text-primary-600" role="search">
                        <label for="global-search" class="sr-only">Rechercher dans l'application</label>
                        <div class="pointer-events-none absolute inset-y-0 left-0 pl-3 flex items-center">
                            <i class="fas fa-search" aria-hidden="true"></i>
                        </div>
                        <input id="global-search" class="block w-64 bg-blue-50 py-2.5 pl-10 pr-4 border border-blue-200 rounded-full leading-5 text-neutral-700 placeholder-neutral-400 focus:outline-none focus:bg-white focus:ring-2 focus:ring-primary-500 focus:border-primary-500 sm:text-sm transition duration-150 ease-in-out min-h-[44px]" placeholder="Rechercher..." type="search" aria-label="Rechercher">
                    </div>

                    <!-- Notifications -->
                    <button class="relative p-2.5 text-neutral-500 hover:text-primary-600 transition-colors rounded-lg hover:bg-blue-50 min-w-[44px] min-h-[44px] flex items-center justify-center" aria-label="Notifications" title="Notifications">
                        <i class="far fa-bell text-xl" aria-hidden="true"></i>
                        <span class="absolute top-2 right-2 block h-2.5 w-2.5 rounded-full bg-red-500 ring-2 ring-white" aria-hidden="true"></span>
                    </button>

                    <!-- Profile Dropdown -->
                    <div class="relative flex items-center gap-3">
                        <div class="h-10 w-10 rounded-full bg-primary-100 flex items-center justify-center text-primary-700 font-bold border-2 border-primary-200 shadow-sm" aria-label="Profil utilisateur">
                            <span id="user-initials">U</span>
                        </div>
                        <span id="user-name" class="hidden md:block text-sm font-semibold text-neutral-700 min-w-[120px]">Chargement...</span>
                        <button onclick="logout()" class="ml-1 text-xs text-red-600 hover:text-red-700 border border-red-200 rounded-lg px-3 py-2 hover:bg-red-50 transition min-h-[44px] flex items-center gap-1.5" aria-label="D√©connexion" title="D√©connexion">
                            <i class="fas fa-sign-out-alt" aria-hidden="true"></i>
                            <span class="hidden lg:inline">D√©connexion</span>
                        </button>
                    </div>
                    
                    <!-- Menu mobile -->
                    <div class="sm:hidden ml-2">
                        <button id="mobile-menu-button" onclick="toggleMobileMenu()" class="inline-flex items-center justify-center p-2.5 rounded-lg text-neutral-500 hover:text-primary-600 hover:bg-blue-50 focus:outline-none focus:ring-2 focus:ring-inset focus:ring-primary-500 min-w-[44px] min-h-[44px]" aria-expanded="false" aria-label="Menu principal" aria-controls="mobile-menu">
                            <i class="fas fa-bars text-xl"></i>
                        </button>
                    </div>
                </div>
            </div>
            <!-- Menu mobile d√©roulant -->
            <div id="mobile-menu" class="hidden sm:hidden border-t-2 border-blue-100 bg-white shadow-lg">
                <div class="px-4 pt-3 pb-4 space-y-1">
                    <a href="dashboard.html" class="border-transparent text-neutral-700 hover:bg-blue-50 hover:text-primary-700 hover:border-l-4 hover:border-primary-300 font-medium block px-4 py-3 rounded-lg text-base transition-all min-h-[44px] flex items-center gap-3">
                        <i class="fas fa-chart-line text-neutral-500" aria-hidden="true"></i>
                        <span>Dashboard</span>
                    </a>
                    <a href="rfq.html" class="border-transparent text-neutral-700 hover:bg-blue-50 hover:text-primary-700 hover:border-l-4 hover:border-primary-300 font-medium block px-4 py-3 rounded-lg text-base transition-all min-h-[44px] flex items-center gap-3">
                        <i class="fas fa-file-contract text-neutral-500" aria-hidden="true"></i>
                        <span>RFQ</span>
                    </a>
                    <a href="devis.html" class="bg-gradient-to-r from-blue-50 to-primary-50 border-l-4 border-primary-500 text-primary-700 font-semibold block px-4 py-3 rounded-lg text-base transition-all min-h-[44px] flex items-center gap-3">
                        <i class="fas fa-file-invoice-dollar text-primary-600" aria-hidden="true"></i>
                        <span>Devis</span>
                    </a>
                    <a href="commandes.html" class="border-transparent text-neutral-700 hover:bg-blue-50 hover:text-primary-700 hover:border-l-4 hover:border-primary-300 font-medium block px-4 py-3 rounded-lg text-base transition-all min-h-[44px] flex items-center gap-3">
                        <i class="fas fa-shopping-cart text-neutral-500" aria-hidden="true"></i>
                        <span>Commandes</span>
                    </a>
                    <a href="entreprises.html" class="border-transparent text-neutral-700 hover:bg-blue-50 hover:text-primary-700 hover:border-l-4 hover:border-primary-300 font-medium block px-4 py-3 rounded-lg text-base transition-all min-h-[44px] flex items-center gap-3">
                        <i class="fas fa-building text-neutral-500" aria-hidden="true"></i>
                        <span>Entreprises</span>
                    </a>
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="flex-1 max-w-7xl w-full mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <div class="container">
        <!-- Breadcrumb & Back -->
        <nav style="margin-bottom: 1.25rem;">
            <a href="devis.html" class="btn btn-secondary btn-sm" style="text-decoration: none; display: inline-flex; align-items: center;">
                <i class="fas fa-arrow-left" style="margin-right: 0.5rem;"></i> Retour √† la liste
            </a>
        </nav>

        <!-- Header Section -->
        <div id="devis-header-section" style="margin-bottom: 2rem;">
            <!-- Inject√© par JS -->
            <div class="loading-pulse" style="height: 2.5rem; background: var(--color-background-light); border-radius: 8px; width: 33%;"></div>
        </div>

        <!-- Content Grid -->
        <div id="devis-content-container" class="devis-detail-container">
            <!-- Loading State -->
            <div style="grid-column: span 1;">
                <div class="card loading-pulse" style="height: 16rem; margin-bottom: 2rem;"></div>
            </div>
            <div>
                <div class="card loading-pulse" style="height: 10rem;"></div>
            </div>
        </div>
    </div>

    <script src="js/auth.js"></script>
    <script src="js/app.js"></script>
    <script src="js/components.js?v=20260116"></script>
    <script src="js/forms.js"></script>
    <script src="js/fileUpload.js"></script>
        <script>window.DISABLE_SIDEBAR = true;</script>
    <script src="js/sidebar.js"></script>
    <script src="js/modern-menu.js"></script>
    <script>
        // Menu mobile
        function toggleMobileMenu() {
            const menu = document.getElementById('mobile-menu');
            const button = document.getElementById('mobile-menu-button');
            if (menu && button) {
                const isHidden = menu.classList.contains('hidden');
                menu.classList.toggle('hidden');
                button.setAttribute('aria-expanded', isHidden ? 'true' : 'false');
                const icon = button.querySelector('i');
                if (icon) {
                    if (isHidden) {
                        icon.classList.remove('fa-bars');
                        icon.classList.add('fa-times');
                    } else {
                        icon.classList.remove('fa-times');
                        icon.classList.add('fa-bars');
                    }
                }
            }
        }
        window.toggleMobileMenu = toggleMobileMenu;

        checkAuth();

        const user = JSON.parse(localStorage.getItem('user') || '{}');
        // Initialisation du nom d'utilisateur et des initiales
        const userNameEl = document.getElementById('user-name');
        const userInitialsEl = document.getElementById('user-initials');
        if (userNameEl) {
            userNameEl.textContent = `${user.prenom || ''} ${user.nom || ''}`.trim() || user.email;
        }
        if (userInitialsEl) {
            const initials = `${user.prenom?.[0] || ''}${user.nom?.[0] || ''}`.toUpperCase() || user.email?.[0]?.toUpperCase() || 'U';
            userInitialsEl.textContent = initials;
        }

        const urlParams = new URLSearchParams(window.location.search);
        const devisId = urlParams.get('id');
        
        console.log('üîç URL params:', window.location.search);
        console.log('üîç Devis ID extrait:', devisId);
        
        if (!devisId) {
            console.error('‚ùå Aucun ID de devis trouv√© dans l\'URL');
            Toast.error('ID de devis manquant dans l\'URL');
        }

        // Helpers de formatage - formatDate et formatCurrency sont d√©j√† d√©finis dans app.js
        // Pas besoin de les red√©clarer, utiliser directement les fonctions globales
        
        // Fonction helper pour formater les dates avec plus de d√©tails (utilise formatDate de app.js si disponible)
        const formatDateDetailed = (dateString) => {
            if (!dateString) return '-';
            const date = new Date(dateString);
            return date.toLocaleDateString('fr-FR', {
                year: 'numeric',
                month: 'short',
                day: 'numeric'
            });
        };

        // Fonction locale pour g√©rer les variantes de statut (envoye/envoy√©, etc.)
        // Note: getStatusBadge est d√©j√† d√©fini dans app.js, on utilise getStatusBadgeFunc pour √©viter les conflits
        const getStatusBadgeFunc = (status) => {
            const s = (status || '').toLowerCase().trim();
            const badges = {
                'brouillon': 'badge-info',
                'envoye': 'badge-warning',
                'envoy√©': 'badge-warning',
                'accepte': 'badge-success',
                'accept√©': 'badge-success',
                'refuse': 'badge-danger',
                'refus√©': 'badge-danger'
            };
            return badges[s] || 'badge-info';
        };

        // Fonction locale pour g√©rer les variantes de statut
        // Note: getStatusLabel est d√©j√† d√©fini dans app.js, on utilise getStatusLabelFunc pour √©viter les conflits
        const getStatusLabelFunc = (status) => {
            const s = (status || '').toLowerCase().trim();
            const labels = {
                'brouillon': 'Brouillon',
                'envoye': 'Envoy√©',
                'envoy√©': 'Envoy√©',
                'accepte': 'Accept√©',
                'accept√©': 'Accept√©',
                'refuse': 'Refus√©',
                'refus√©': 'Refus√©'
            };
            return labels[s] || status || 'Inconnu';
        };

        // D√©finir les fonctions AVANT de charger les d√©tails
        let isProcessingAccept = false; // Protection contre les doubles clics
        
        async function accepterDevis(id) {
            console.log('accepterDevis appel√© avec id:', id);
            
            // Protection contre les doubles clics
            if (isProcessingAccept) {
                console.log('‚ö†Ô∏è Traitement d√©j√† en cours, ignore le clic');
                return;
            }
            
            if (!confirm('Voulez-vous accepter ce devis et cr√©er une commande ?')) {
                return;
            }
            
            // D√©sactiver le bouton pendant le traitement
            const btnAccepter = document.getElementById(`btn-accepter-${id}`);
            if (btnAccepter) {
                btnAccepter.disabled = true;
                btnAccepter.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Traitement...';
            }
            
            isProcessingAccept = true;
            
            try {
                showLoading('Cr√©ation de la commande...');
                
                // R√©cup√©rer les d√©tails du devis
                const devisResponse = await apiCall(`/api/devis/${id}`);
                if (!devisResponse || !devisResponse.ok) {
                    hideLoading();
                    const errorData = await devisResponse.json().catch(() => ({ error: 'Erreur lors de la r√©cup√©ration du devis' }));
                    Toast.error(errorData.error || 'Erreur lors de la r√©cup√©ration du devis');
                    isProcessingAccept = false;
                    if (btnAccepter) {
                        btnAccepter.disabled = false;
                        btnAccepter.innerHTML = '<i class="fas fa-check"></i> Accepter';
                    }
                    return;
                }
                
                const devis = await devisResponse.json();
                console.log('Devis r√©cup√©r√©:', devis);
                
                // V√©rifier si le devis est d√©j√† accept√©
                if (devis.statut === 'accepte' || devis.statut === 'accept√©') {
                    hideLoading();
                    Toast.warning('Ce devis a d√©j√† √©t√© accept√©. Une commande a peut-√™tre d√©j√† √©t√© cr√©√©e.');
                    isProcessingAccept = false;
                    if (btnAccepter) {
                        btnAccepter.disabled = false;
                        btnAccepter.innerHTML = '<i class="fas fa-check"></i> Accepter';
                    }
                    setTimeout(() => {
                        window.location.reload();
                    }, 2000);
                    return;
                }
                
                // Cr√©er la commande depuis le devis
                const commandeData = {
                    numero: `BC-${new Date().getFullYear()}-${Date.now()}`,
                    type_commande: 'BC',
                    date_commande: new Date().toISOString().split('T')[0],
                    devis_id: id,
                    rfq_id: devis.rfq_id,
                    fournisseur_id: devis.fournisseur_id,
                    lignes: (devis.lignes || []).map(l => ({
                        produit_id: l.produit_id,
                        reference: l.reference,
                        description: l.description,
                        quantite: l.quantite,
                        unite: l.unite,
                        prix_unitaire_ht: l.prix_unitaire_ht,
                        remise: l.remise || 0,
                        tva_taux: l.tva_taux || 20
                    }))
                };
                
                console.log('Cr√©ation de la commande avec les donn√©es:', commandeData);
                
                const commandeResponse = await apiCall('/api/commandes', {
                    method: 'POST',
                    body: JSON.stringify(commandeData)
                });
                
                if (!commandeResponse) {
                    hideLoading();
                    Toast.error('Erreur de connexion');
                    return;
                }
                
                if (commandeResponse.ok) {
                    // Mettre √† jour le statut du devis √† "accepte"
                    console.log('üü¢ Commande cr√©√©e, mise √† jour du statut du devis...');
                    const statutResponse = await apiCall(`/api/devis/${id}/statut`, {
                        method: 'PATCH',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ statut: 'accepte' })
                    });
                    
                    console.log('üü¢ R√©ponse statut:', statutResponse);
                    
                    if (statutResponse && statutResponse.ok) {
                        const commandeData = await commandeResponse.json();
                        const statutData = await statutResponse.json();
                        console.log('‚úÖ Commande cr√©√©e:', commandeData);
                        console.log('‚úÖ Statut devis mis √† jour:', statutData);
                        Toast.success('Devis accept√© et commande cr√©√©e avec succ√®s');
                        isProcessingAccept = false;
                        setTimeout(() => {
                            window.location.reload();
                        }, 1500);
                    } else {
                        const errorStatut = await statutResponse.json().catch(() => ({ error: 'Erreur inconnue' }));
                        console.error('‚ùå Erreur mise √† jour statut:', errorStatut);
                        Toast.warning('Commande cr√©√©e mais erreur lors de la mise √† jour du statut du devis: ' + (errorStatut.error || 'Erreur inconnue'));
                        isProcessingAccept = false;
                        setTimeout(() => {
                            window.location.reload();
                        }, 2000);
                    }
                } else {
                    const errorData = await commandeResponse.json().catch(() => ({ error: 'Erreur inconnue' }));
                    console.error('Erreur cr√©ation commande:', errorData);
                    
                    // Si une commande existe d√©j√†, afficher un message sp√©cifique
                    if (commandeResponse.status === 409 && errorData.existing_commande) {
                        Toast.warning(`Une commande existe d√©j√† pour ce devis : ${errorData.existing_commande.numero}`);
                        setTimeout(() => {
                            window.location.href = `commandes-detail.html?id=${errorData.existing_commande.id}`;
                        }, 2000);
                    } else {
                        Toast.error(errorData.error || errorData.message || 'Erreur lors de la cr√©ation de la commande');
                    }
                    isProcessingAccept = false;
                    if (btnAccepter) {
                        btnAccepter.disabled = false;
                        btnAccepter.innerHTML = '<i class="fas fa-check"></i> Accepter';
                    }
                }
            } catch (error) {
                console.error('Erreur:', error);
                Toast.error('Erreur de connexion: ' + error.message);
                isProcessingAccept = false;
                if (btnAccepter) {
                    btnAccepter.disabled = false;
                    btnAccepter.innerHTML = '<i class="fas fa-check"></i> Accepter';
                }
            } finally {
                hideLoading();
            }
        }
        
        async function refuserDevis(id) {
            console.log('refuserDevis appel√© avec id:', id);
            if (!confirm('√ätes-vous s√ªr de vouloir refuser ce devis ?')) {
                return;
            }
            
            try {
                showLoading('Refus du devis...');
                console.log('üü° Envoi de la requ√™te PATCH pour refuser le devis...');
                const response = await apiCall(`/api/devis/${id}/statut`, {
                    method: 'PATCH',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ statut: 'refuse' })
                });
                
                console.log('üü° R√©ponse re√ßue:', response);
                
                if (!response) {
                    hideLoading();
                    Toast.error('Erreur de connexion');
                    return;
                }
                
                if (response.ok) {
                    const data = await response.json().catch(() => ({}));
                    console.log('Devis refus√©:', data);
                    Toast.success('Devis refus√©');
                    setTimeout(() => {
                        window.location.reload();
                    }, 1500);
                } else {
                    const errorData = await response.json().catch(() => ({ error: 'Erreur inconnue' }));
                    console.error('Erreur API:', errorData);
                    Toast.error(errorData.error || 'Erreur lors du refus');
                }
            } catch (error) {
                console.error('Erreur:', error);
                Toast.error('Erreur de connexion: ' + error.message);
            } finally {
                hideLoading();
            }
        }
        
        // Exposer les fonctions globalement
        window.accepterDevis = accepterDevis;
        window.refuserDevis = refuserDevis;

        async function loadDevisDetails() {
            if (!devisId) {
                console.error('‚ùå Devis ID manquant');
                Toast.error('Devis non sp√©cifi√©');
                window.location.href = 'devis.html';
                return;
            }

            try {
                showLoading('Chargement...');
                console.log('üü¶ Chargement devis ID:', devisId);
                console.log('üü¶ URL API:', `/api/devis/${devisId}`);
                
                const response = await apiCall(`/api/devis/${devisId}`);
                console.log('üü¶ R√©ponse API re√ßue:', response);
                console.log('üü¶ Status:', response ? response.status : 'Pas de r√©ponse');
                console.log('üü¶ OK:', response ? response.ok : 'Pas de r√©ponse');
                
                if (!response) {
                    hideLoading();
                    console.error('‚ùå Pas de r√©ponse de l\'API - v√©rifiez la connexion et l\'authentification');
                    Toast.error('Erreur de connexion. V√©rifiez votre connexion internet.');
                    return;
                }

                if (!response.ok) {
                    let errorData;
                    try {
                        errorData = await response.json();
                    } catch (e) {
                        errorData = { error: `Erreur HTTP ${response.status}: ${response.statusText}` };
                    }
                    hideLoading();
                    console.error('‚ùå Erreur API:', errorData);
                    console.error('‚ùå Status HTTP:', response.status);
                    Toast.error('Erreur: ' + (errorData.error || 'Devis non trouv√©'));
                    setTimeout(() => window.location.href = 'devis.html', 2000);
                    return;
                }

                const devis = await response.json();
                console.log('‚úÖ Devis charg√© avec succ√®s:', devis);
                console.log('‚úÖ ID:', devis.id);
                console.log('‚úÖ Num√©ro:', devis.numero);
                console.log('‚úÖ Statut:', devis.statut);
                console.log('‚úÖ Fournisseur:', devis.fournisseur_nom);
                console.log('‚úÖ Lignes:', devis.lignes ? devis.lignes.length : 0);
                console.log('‚úÖ Total HT:', devis.total_ht);
                console.log('‚úÖ Total TTC:', devis.total_ttc);
                
                if (!devis || !devis.id) {
                    hideLoading();
                    console.error('‚ùå Donn√©es invalides re√ßues:', devis);
                    Toast.error('Donn√©es invalides re√ßues du serveur');
                    return;
                }
                
                hideLoading();
                displayDevisDetails(devis);
            } catch (error) {
                hideLoading();
                console.error('‚ùå Erreur lors du chargement:', error);
                console.error('‚ùå Stack trace:', error.stack);
                Toast.error('Erreur lors du chargement: ' + (error.message || 'Erreur inconnue'));
            }
        }

        // Fonction pour t√©l√©charger le PDF d'un devis avec authentification
        async function downloadPDFDevis(devisId) {
            try {
                const token = localStorage.getItem('token');
                if (!token) {
                    Toast.error('Vous devez √™tre connect√© pour t√©l√©charger le PDF');
                    return;
                }
                
                showLoading('G√©n√©ration du PDF...');
                
                // D√©tecter l'URL de base
                let baseUrl = '';
                if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {
                    baseUrl = 'http://localhost:3000';
                } else {
                    baseUrl = window.location.origin;
                }
                
                const url = `${baseUrl}/api/pdf/devis/${devisId}`;
                
                const response = await fetch(url, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                hideLoading();
                
                if (!response.ok) {
                    if (response.status === 401) {
                        Toast.error('Session expir√©e. Veuillez vous reconnecter.');
                        window.location.href = 'index.html';
                        return;
                    }
                    const errorData = await response.json().catch(() => ({ error: 'Erreur inconnue' }));
                    Toast.error(errorData.error || 'Erreur lors du t√©l√©chargement du PDF');
                    return;
                }
                
                // R√©cup√©rer le blob
                const blob = await response.blob();
                
                // Cr√©er un lien de t√©l√©chargement
                const downloadUrl = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = downloadUrl;
                a.download = `Devis-${devisId}-${Date.now()}.pdf`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                window.URL.revokeObjectURL(downloadUrl);
                
                Toast.success('PDF t√©l√©charg√© avec succ√®s');
            } catch (error) {
                hideLoading();
                console.error('Erreur t√©l√©chargement PDF:', error);
                Toast.error('Erreur lors du t√©l√©chargement du PDF: ' + error.message);
            }
        }
        window.downloadPDFDevis = downloadPDFDevis;

        function renderHeader(devis) {
            const container = document.getElementById('devis-header-section');
            const statut = (devis.statut || '').toString().toLowerCase().trim();
            
            let actionsHTML = `
                <button id="btn-pdf-${devis.id}" data-devis-id="${devis.id}" class="btn btn-secondary btn-sm">
                    <i class="fas fa-file-pdf"></i> PDF
                </button>
            `;
            
            if (statut === 'brouillon') {
                actionsHTML += `
                    <button onclick="if(typeof editDevisForm==='function'){editDevisForm(${devis.id});}else{alert('Fonction non disponible');}" class="btn btn-primary btn-sm">
                        <i class="fas fa-edit"></i> Modifier
                    </button>
                `;
            } else if (statut === 'envoye' || statut === 'envoy√©') {
                actionsHTML = `
                    <button id="btn-pdf-${devis.id}" data-devis-id="${devis.id}" class="btn btn-secondary btn-sm">
                        <i class="fas fa-file-pdf"></i> PDF
                    </button>
                    <button id="btn-accepter-${devis.id}" data-devis-id="${devis.id}" class="btn btn-success btn-sm">
                        <i class="fas fa-check"></i> Accepter
                    </button>
                    <button id="btn-refuser-${devis.id}" data-devis-id="${devis.id}" class="btn btn-danger btn-sm">
                        <i class="fas fa-times"></i> Refuser
                    </button>
                `;
            } else if (statut === 'accepte' || statut === 'accept√©') {
                actionsHTML += `<span class="badge badge-success"><i class="fas fa-check-circle"></i> Devis accept√©</span>`;
            } else if (statut === 'refuse' || statut === 'refus√©') {
                actionsHTML += `<span class="badge badge-danger"><i class="fas fa-times-circle"></i> Devis refus√©</span>`;
            } else {
                const user = JSON.parse(localStorage.getItem('user') || '{}');
                if (user.role === 'admin' || user.role === 'superviseur') {
                    actionsHTML = `
                        <button id="btn-pdf-${devis.id}" data-devis-id="${devis.id}" class="btn btn-secondary btn-sm">
                            <i class="fas fa-file-pdf"></i> PDF
                        </button>
                        <button id="btn-accepter-${devis.id}" data-devis-id="${devis.id}" class="btn btn-success btn-sm">
                            <i class="fas fa-check"></i> Accepter
                        </button>
                        <button id="btn-refuser-${devis.id}" data-devis-id="${devis.id}" class="btn btn-danger btn-sm">
                            <i class="fas fa-times"></i> Refuser
                        </button>
                    `;
                }
            }
            
            container.innerHTML = `
                <div style="display: flex; flex-direction: column; gap: 1rem;">
                    <div class="header-title-row">
                        <h1 style="font-size: 1.875rem; font-weight: 700; color: var(--color-neutral-dark); margin: 0;">
                            ${devis.numero || 'Devis-' + devis.id}
                        </h1>
                        <span class="badge ${getStatusBadgeFunc(statut)}" style="text-transform: uppercase; letter-spacing: 0.05em; font-size: 0.75rem;">
                            ${getStatusLabelFunc(devis.statut)}
                        </span>
                    </div>
                    <p class="header-subtitle">
                        Fournisseur: <strong>${devis.fournisseur_nom || '-'}</strong>
                    </p>
                    <div id="devis-actions">
                        ${actionsHTML}
                    </div>
                </div>
            `;
            
            // Attacher les event listeners aux boutons
            attachButtonListeners(devis);
        }
        
        function attachButtonListeners(devis) {
            // Utiliser setTimeout pour s'assurer que le DOM est compl√®tement rendu
            setTimeout(() => {
                const btnPDF = document.getElementById(`btn-pdf-${devis.id}`);
                const btnAccepter = document.getElementById(`btn-accepter-${devis.id}`);
                const btnRefuser = document.getElementById(`btn-refuser-${devis.id}`);
                
                console.log('üîò Attachement des listeners pour devis:', devis.id);
                console.log('üîò Boutons trouv√©s:', { btnPDF: !!btnPDF, btnAccepter: !!btnAccepter, btnRefuser: !!btnRefuser });
                
                // Bouton PDF
                if (btnPDF) {
                    btnPDF.addEventListener('click', async function(e) {
                        e.preventDefault();
                        e.stopPropagation();
                        const id = parseInt(btnPDF.getAttribute('data-devis-id') || devis.id);
                        console.log('üîò Clic sur bouton PDF pour devis:', id);
                        try {
                            if (typeof downloadPDFDevis === 'function') {
                                await downloadPDFDevis(id);
                            } else {
                                console.error('‚ùå downloadPDFDevis n\'est pas d√©finie');
                                Toast.error('Fonction de t√©l√©chargement PDF non disponible');
                            }
                        } catch (error) {
                            console.error('‚ùå Erreur lors du t√©l√©chargement du PDF:', error);
                            Toast.error('Erreur lors du t√©l√©chargement du PDF: ' + (error.message || 'Erreur inconnue'));
                        }
                    });
                } else {
                    console.warn('‚ö†Ô∏è Bouton PDF non trouv√© pour devis:', devis.id);
                }
                
                // Bouton Accepter
                if (btnAccepter) {
                    btnAccepter.addEventListener('click', async function(e) {
                        e.preventDefault();
                        e.stopPropagation();
                        const id = parseInt(btnAccepter.getAttribute('data-devis-id') || devis.id);
                        console.log('üîò Clic sur bouton Accepter pour devis:', id);
                        try {
                            if (typeof accepterDevis === 'function') {
                                await accepterDevis(id);
                            } else {
                                console.error('‚ùå accepterDevis n\'est pas d√©finie');
                                Toast.error('Fonction d\'acceptation non disponible');
                            }
                        } catch (error) {
                            console.error('‚ùå Erreur lors de l\'acceptation du devis:', error);
                            Toast.error('Erreur lors de l\'acceptation du devis: ' + (error.message || 'Erreur inconnue'));
                        }
                    });
                } else {
                    console.warn('‚ö†Ô∏è Bouton Accepter non trouv√© pour devis:', devis.id);
                }
                
                // Bouton Refuser
                if (btnRefuser) {
                    btnRefuser.addEventListener('click', async function(e) {
                        e.preventDefault();
                        e.stopPropagation();
                        const id = parseInt(btnRefuser.getAttribute('data-devis-id') || devis.id);
                        console.log('üîò Clic sur bouton Refuser pour devis:', id);
                        try {
                            if (typeof refuserDevis === 'function') {
                                await refuserDevis(id);
                            } else {
                                console.error('‚ùå refuserDevis n\'est pas d√©finie');
                                Toast.error('Fonction de refus non disponible');
                            }
                        } catch (error) {
                            console.error('‚ùå Erreur lors du refus du devis:', error);
                            Toast.error('Erreur lors du refus du devis: ' + (error.message || 'Erreur inconnue'));
                        }
                    });
                } else {
                    console.warn('‚ö†Ô∏è Bouton Refuser non trouv√© pour devis:', devis.id);
                }
            }, 100);
        }
        
        function displayDevisDetails(devis) {
            console.log('üü® displayDevisDetails appel√© avec devis:', devis);
            
            if (!devis) {
                console.error('‚ùå displayDevisDetails: devis est null ou undefined');
                Toast.error('Aucune donn√©e √† afficher');
                return;
            }
            
            if (!devis.id) {
                console.error('‚ùå displayDevisDetails: devis.id manquant');
                Toast.error('Donn√©es invalides: ID manquant');
                return;
            }
            
            try {
                // Rendre le header
                renderHeader(devis);
                
                // Rendre le contenu principal
                renderMainContent(devis);
                
                console.log('‚úÖ Affichage termin√© avec succ√®s');
            } catch (error) {
                console.error('‚ùå Erreur dans displayDevisDetails:', error);
                Toast.error('Erreur lors de l\'affichage: ' + error.message);
            }
        }
        
        function renderMainContent(devis) {
            const container = document.getElementById('devis-content-container');
            
            if (!container) {
                console.error('‚ùå Container devis-content-container non trouv√© dans le DOM');
                Toast.error('Erreur: conteneur non trouv√©');
                return;
            }
            
            console.log('üü® renderMainContent appel√©, container trouv√©:', !!container);
            const statut = (devis.statut || '').toString().toLowerCase().trim();
            console.log('üü® Statut pour renderMainContent:', statut);
            
            console.log('üü® G√©n√©ration du HTML pour renderMainContent...');
            console.log('üü® Devis data:', {
                id: devis.id,
                numero: devis.numero,
                rfq_id: devis.rfq_id,
                rfq_numero: devis.rfq_numero,
                fournisseur_nom: devis.fournisseur_nom,
                lignes_count: devis.lignes ? devis.lignes.length : 0
            });
            
            container.innerHTML = `
                <!-- Colonne Gauche -->
                <div class="fade-in" style="grid-column: span 1;">
                    
                    <!-- Info G√©n√©rales -->
                    <div class="card" style="margin-bottom: 2rem;">
                        <div class="card-header">
                            <h2 class="card-title">Information du Devis</h2>
                        </div>
                        <div class="card-body">
                            <dl class="info-grid">
                                <div class="info-item">
                                    <dt>R√©f√©rence RFQ</dt>
                                    <dd style="color: var(--color-primary); font-weight: 500; cursor: pointer;" onclick="${devis.rfq_id ? `window.location.href='rfq-detail.html?id=${devis.rfq_id}'` : 'return false;'}">
                                        ${devis.rfq_numero || '-'}
                                    </dd>
                                </div>
                                <div class="info-item">
                                    <dt>Fournisseur</dt>
                                    <dd style="font-weight: 600; color: var(--color-primary);">${devis.fournisseur_nom || '-'}</dd>
                                </div>
                                <div class="info-item">
                                    <dt>Date d'√©mission</dt>
                                    <dd>${formatDateDetailed(devis.date_emission)}</dd>
                                </div>
                                <div class="info-item">
                                    <dt>Date de validit√©</dt>
                                    <dd>${formatDateDetailed(devis.date_validite) || 'Non sp√©cifi√©e'}</dd>
                                </div>
                                ${devis.notes ? `
                                <div class="info-item" style="grid-column: 1 / -1;">
                                    <dt>Notes / Description</dt>
                                    <dd>${devis.notes}</dd>
                                </div>
                                ` : ''}
                            </dl>
                        </div>
                    </div>

                    <!-- Items Table -->
                    <div class="card" style="margin-bottom: 2rem;">
                        <div class="card-header">
                            <h2 class="card-title">Articles</h2>
                        </div>
                        <div class="table-container">
                            <table class="table">
                                <thead>
                                    <tr>
                                        <th>Description</th>
                                        <th style="text-align: right;">Qt√©</th>
                                        <th style="text-align: right;">P.U. HT</th>
                                        <th style="text-align: right;">Remise</th>
                                        <th style="text-align: right;">TVA</th>
                                        <th style="text-align: right;">Total HT</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${devis.lignes && devis.lignes.length > 0 ? devis.lignes.map(ligne => {
                                        const prix = parseFloat(ligne.prix_unitaire_ht || 0);
                                        const qte = parseFloat(ligne.quantite || 0);
                                        const remise = parseFloat(ligne.remise || 0);
                                        const total = prix * qte * (1 - remise / 100);
                                        return `
                                            <tr>
                                                <td>
                                                    ${ligne.description || '-'}
                                                    ${remise > 0 ? `<span class="badge badge-success" style="margin-left: 0.5rem; font-size: 0.7rem;">-${remise}%</span>` : ''}
                                                </td>
                                                <td style="text-align: right;">${qte} ${ligne.unite || ''}</td>
                                                <td style="text-align: right;">${formatCurrency(prix)}</td>
                                                <td style="text-align: right;">${remise > 0 ? remise + '%' : '-'}</td>
                                                <td style="text-align: right;">${ligne.tva_taux || 20}%</td>
                                                <td style="text-align: right; font-weight: 600;">${formatCurrency(total)}</td>
                                            </tr>
                                        `;
                                    }).join('') : '<tr><td colspan="6" style="text-align: center; padding: 2rem; color: var(--color-neutral);">Aucun article</td></tr>'}
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Fichiers Joints -->
                    <div class="card">
                        <div class="card-header">
                            <h2 class="card-title">Fichiers joints</h2>
                        </div>
                        <div class="card-body" id="fichiers-joints-container" style="min-height: 100px;">
                            <!-- Rempli par initFileUpload -->
                        </div>
                    </div>

                </div>

                <!-- Colonne Droite -->
                <div class="fade-in">
                    
                    <!-- R√©sum√© Financier -->
                    <div class="card" style="margin-bottom: 1.5rem;">
                        <div class="card-header" style="background: var(--color-background-light);">
                            <h2 class="card-title">R√©sum√© Financier</h2>
                        </div>
                        <div class="card-body">
                            <div class="summary-row">
                                <span style="color: var(--color-neutral); font-size: 0.875rem;">Total HT</span>
                                <span style="font-weight: 500; font-size: 0.875rem;">${formatCurrency(devis.total_ht || 0)}</span>
                            </div>
                            <div class="summary-row">
                                <span style="color: var(--color-neutral); font-size: 0.875rem;">Total TVA</span>
                                <span style="font-weight: 500; font-size: 0.875rem;">${formatCurrency(devis.total_tva || 0)}</span>
                            </div>
                            ${devis.remise_globale ? `
                            <div class="summary-row" style="color: var(--color-success); font-size: 0.875rem;">
                                <span>Remise Globale</span>
                                <span style="font-weight: 500;">-${devis.remise_globale}%</span>
                            </div>` : ''}
                            <div class="summary-row">
                                <span style="font-weight: 700; color: var(--color-neutral-dark); font-size: 1rem;">Total TTC</span>
                                <span class="summary-total">${formatCurrency(devis.total_ttc || 0)}</span>
                            </div>
                        </div>
                    </div>

                    <!-- Dates & Validit√© -->
                    <div class="card" style="margin-bottom: 1.5rem;">
                        <div class="card-header" style="background: var(--color-background-light);">
                            <h3 style="font-size: 0.75rem; font-weight: 600; color: var(--color-neutral); text-transform: uppercase; letter-spacing: 0.05em; margin: 0;">Dates & Validit√©</h3>
                        </div>
                        <div class="card-body">
                            <div class="date-item">
                                <i class="far fa-calendar-alt"></i>
                                <div class="date-item-content">
                                    <p class="date-item-label">√âmission</p>
                                    <p class="date-item-value">${formatDateDetailed(devis.date_emission)}</p>
                                </div>
                            </div>
                            <div class="date-item">
                                <i class="far fa-clock"></i>
                                <div class="date-item-content">
                                    <p class="date-item-label">Validit√©</p>
                                    <p class="date-item-value">${formatDateDetailed(devis.date_validite) || 'Non sp√©cifi√©e'}</p>
                                </div>
                            </div>
                            <div class="date-item">
                                <i class="fas fa-truck"></i>
                                <div class="date-item-content">
                                    <p class="date-item-label">D√©lai Livraison</p>
                                    <p class="date-item-value">${devis.delai_livraison ? devis.delai_livraison + ' jours' : '-'}</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Conditions & Garanties -->
                    <div style="display: flex; flex-direction: column; gap: 1rem;">
                        ${devis.conditions_paiement ? `
                        <div class="card" style="background: var(--color-background-blue); border-left: 4px solid var(--color-primary);">
                            <div class="card-body">
                                <div style="display: flex; align-items: start;">
                                    <i class="fas fa-info-circle" style="color: var(--color-primary); margin-right: 0.75rem; margin-top: 0.25rem;"></i>
                                    <div>
                                        <h4 style="font-weight: 600; margin: 0 0 0.5rem 0; color: var(--color-primary-dark); font-size: 0.875rem;">Conditions de paiement</h4>
                                        <p style="color: var(--color-neutral-dark); margin: 0; font-size: 0.875rem;">${devis.conditions_paiement}</p>
                                    </div>
                                </div>
                            </div>
                        </div>` : ''}
                        
                        ${devis.garanties ? `
                        <div class="card" style="background: var(--color-background-light);">
                            <div class="card-body">
                                <h4 style="font-size: 0.75rem; font-weight: 600; color: var(--color-neutral); text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: 0.5rem;">Garanties</h4>
                                <p style="color: var(--color-neutral-dark); margin: 0; font-size: 0.875rem;">${devis.garanties}</p>
                            </div>
                        </div>` : ''}
                    </div>

                </div>
            `;
            
            // Forcer la visibilit√©
            container.style.display = 'grid';
            container.style.visibility = 'visible';
            container.style.opacity = '1';
            
            // Initialiser le gestionnaire de fichiers apr√®s le rendu
            if (devisId) {
                setTimeout(() => {
                    try {
                        const fichiersContainer = document.getElementById('fichiers-joints-container');
                        if (fichiersContainer && typeof initFileUpload === 'function') {
                            initFileUpload('devis', devisId, 'fichiers-joints-container');
                        }
                    } catch (error) {
                        console.error('Erreur initFileUpload:', error);
                    }
                }, 200);
            }
        }

        function editDevis(id) {
            if (typeof window.editDevisForm === 'function') {
                window.editDevisForm(id);
            } else {
                Toast.error('Fonction d\'√©dition non disponible');
            }
        }

        // Charger les d√©tails du devis au chargement de la page
        loadDevisDetails();
    </script>
</body>
</html>
