<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Produits - SilyProcure</title>
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="css/responsive.css">
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" integrity="sha512-iecdLmaskl7CVkqkXNQ/ZH/XLlvWZOJyj7Yy7tcenmpD1ypASozpmT/E0iPtmFIB46ZmdtAc9eNBvH0H/ZpiBw==" crossorigin="anonymous" referrerpolicy="no-referrer" /><link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="css/animations.css">
</head>
<body>
    <div class="header">
        <div class="logo">SilyProcure</div>
        <div class="user-info">
            <span id="user-name"></span>
            <button onclick="logout()">Déconnexion</button>
        </div>
    </div>

    <nav class="nav">
        <a href="dashboard.html"><i class="fas fa-chart-line"></i> Dashboard</a>
        <a href="demandes-devis.html"><i class="fas fa-inbox"></i> Demandes Devis</a>
        <a href="clients.html"><i class="fas fa-users"></i> Clients</a>
        <a href="rfq.html"><i class="fas fa-file-alt"></i> RFQ</a>
        <a href="devis.html"><i class="fas fa-briefcase"></i> Devis</a>
        <a href="commandes.html"><i class="fas fa-shopping-cart"></i> Commandes</a>
        <a href="factures.html"><i class="fas fa-file-invoice"></i> Factures</a>
        <a href="entreprises.html"><i class="fas fa-building"></i> Entreprises</a>
        <a href="produits.html" class="active"><i class="fas fa-box"></i> Produits</a>
        <a href="carte.html"><i class="fas fa-map"></i> Carte</a>
    </nav>

    <div class="container">
        <!-- Hero Section -->
        <div class="hero-section">
            <h1 class="hero-title"><i class="fas fa-box"></i> Catalogue de Produits</h1>
            <p class="hero-description">Gérez votre catalogue de produits et services avec leurs caractéristiques et prix.</p>
            <button class="btn btn-primary btn-lg" onclick="showCreateProduit()"><i class="fas fa-plus"></i> Nouveau produit</button>
        </div>

        <div class="card">
            <div class="card-header">
                <h2 class="card-title"><i class="fas fa-clipboard-list"></i> Liste des produits</h2>
                <button class="btn btn-primary" onclick="showCreateProduit()"><i class="fas fa-plus"></i> Nouveau produit</button>
            </div>
            
            <div class="search-bar">
                <div class="search-input">
                    <input type="text" id="prod-search" placeholder="Rechercher par référence, libellé..." 
                           onkeyup="filterProduits()">
                </div>
                <div class="filter-group">
                    <select class="filter-select" id="prod-filter-categorie" onchange="filterProduits()">
                        <option value="">Toutes les catégories</option>
                    </select>
                </div>
            </div>
            
            <div class="table-container">
                <table class="table">
                <thead>
                    <tr>
                        <th>Référence</th>
                        <th>Libellé</th>
                        <th>Catégorie</th>
                        <th>Fournisseur</th>
                        <th>Prix unitaire HT</th>
                        <th>Unité</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="produits-table-body">
                    <tr><td colspan="6" class="loading">Chargement...</td></tr>
                </tbody>
            </table>
        </div>
    </div>

    <script src="js/auth.js"></script>
    <script src="js/app.js"></script>
    <script src="js/components.js"></script>
    <script>window.DISABLE_SIDEBAR = true;</script>
    <script src="js/sidebar.js"></script>
    <script src="js/forms-products.js"></script>
    <script src="js/forms.js"></script>
    <script>
        // Vérifier l'authentification
        if (!checkAuth()) {
            // Redirection déjà effectuée par checkAuth()
            // Ne pas continuer l'exécution
        } else {

        const user = JSON.parse(localStorage.getItem('user') || '{}');
        document.getElementById('user-name').textContent = `${user.prenom || ''} ${user.nom || ''}`.trim() || user.email;

        let allProduits = [];

        async function loadProduits() {
            try {
                console.log('loadProduits appelé');
                showLoading('Chargement des produits...');
                
                const response = await apiCall('/api/produits');
                console.log('Réponse API produits:', response);
                
                if (!response) {
                    hideLoading();
                    Toast.error('Impossible de charger les produits');
                    return;
                }
                
                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({ error: 'Erreur inconnue' }));
                    hideLoading();
                    Toast.error('Erreur: ' + (errorData.error || 'Erreur lors du chargement'));
                    console.error('Erreur API:', errorData);
                    return;
                }
                
                const result = await response.json();
                // L'API retourne { data: [...], pagination: {...} } à cause de la pagination
                allProduits = Array.isArray(result) ? result : (result.data || []);
                console.log('Produits chargés:', allProduits.length);
                // Debug: afficher le premier produit pour vérifier les données
                if (allProduits.length > 0) {
                    console.log('Exemple produit:', allProduits[0]);
                    console.log('Fournisseur du premier produit:', {
                        id: allProduits[0].fournisseur_id,
                        nom: allProduits[0].fournisseur_nom
                    });
                }
                hideLoading();
                
                // Charger les catégories pour le filtre
                await loadCategoriesForFilter();
                
                displayProduits(allProduits);
            } catch (error) {
                hideLoading();
                Toast.error('Erreur lors du chargement: ' + error.message);
                console.error('Erreur loadProduits:', error);
            }
        }

        async function loadCategoriesForFilter() {
            try {
                const response = await apiCall('/api/produits/categories');
                if (response && response.ok) {
                    const categories = await response.json();
                    const select = document.getElementById('prod-filter-categorie');
                    if (select) {
                        categories.forEach(cat => {
                            const option = document.createElement('option');
                            option.value = cat.id;
                            option.textContent = cat.libelle;
                            select.appendChild(option);
                        });
                    }
                }
            } catch (error) {
                console.error('Erreur chargement catégories:', error);
            }
        }

        function displayProduits(produits) {
            try {
                const tbody = document.getElementById('produits-table-body');
                if (!tbody) {
                    console.error('Table body non trouvé');
                    return;
                }

                if (!produits || produits.length === 0) {
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="7">
                                <div class="empty-state">
                                    <div class="empty-state-icon"><i class="fas fa-box"></i></div>
                                    <div class="empty-state-title">Aucun produit</div>
                                    <div class="empty-state-text">Créez votre premier produit</div>
                                </div>
                            </td>
                        </tr>
                    `;
                    return;
                }

                tbody.innerHTML = produits.map(p => {
                    // Afficher le fournisseur avec un lien si disponible
                    let fournisseurHtml = '-';
                    // Vérifier si le produit a un fournisseur (par ID ou nom)
                    if (p.fournisseur_id || p.fournisseur_nom) {
                        const fournisseurId = p.fournisseur_id;
                        const fournisseurNom = p.fournisseur_nom || 'Fournisseur inconnu';
                        if (fournisseurId) {
                            fournisseurHtml = `<a href="entreprises-detail.html?id=${fournisseurId}" class="link-primary" title="Voir le fournisseur"><i class="fas fa-building"></i> ${fournisseurNom}</a>`;
                        } else {
                            fournisseurHtml = `<span><i class="fas fa-building"></i> ${fournisseurNom}</span>`;
                        }
                    }
                    
                    return `
                    <tr>
                        <td><strong>${p.reference || '-'}</strong></td>
                        <td>${p.libelle || '-'}</td>
                        <td>${p.categorie_libelle || '-'}</td>
                        <td>${fournisseurHtml}</td>
                        <td>${formatCurrency(p.prix_unitaire_ht || 0)}</td>
                        <td>${p.unite || '-'}</td>
                        <td>
                            <button class="btn btn-secondary btn-sm" onclick="viewProduit(${p.id})" title="Voir les détails"><i class="fas fa-eye"></i></button>
                            <button class="btn btn-primary btn-sm" onclick="editProduit(${p.id})" title="Modifier"><i class="fas fa-edit"></i></button>
                            <button class="btn btn-danger btn-sm" onclick="deleteProduit(${p.id})" title="Supprimer"><i class="fas fa-trash"></i></button>
                        </td>
                    </tr>
                `;
                }).join('');
            } catch (error) {
                console.error('Erreur dans displayProduits:', error);
                Toast.error('Erreur lors de l\'affichage des produits');
            }
        }

        function showCreateProduit() {
            console.log('showCreateProduit appelé');
            console.log('Modal disponible:', typeof Modal !== 'undefined');
            console.log('createProduitForm disponible:', typeof window.createProduitForm !== 'undefined');
            console.log('Toast disponible:', typeof Toast !== 'undefined');
            
            if (typeof Modal === 'undefined') {
                Toast.error('Erreur: Composants non chargés. Rechargez la page.');
                return;
            }
            
            try {
                if (typeof window.createProduitForm === 'function') {
                    window.createProduitForm();
                } else if (typeof createProduitForm === 'function') {
                    createProduitForm();
                } else {
                    console.error('createProduitForm n\'est pas définie');
                    console.log('Fonctions disponibles:', Object.keys(window).filter(k => k.includes('Produit') || k.includes('Modal')));
                    Toast.error('Erreur: fonction de création non disponible. Rechargez la page.');
                }
            } catch (error) {
                console.error('Erreur dans showCreateProduit:', error);
                Toast.error('Erreur: ' + error.message);
            }
        }
        
        // Exporter pour utilisation globale
        window.showCreateProduit = showCreateProduit;
        window.viewProduit = viewProduit;
        window.editProduit = editProduit;
        window.deleteProduit = deleteProduit;

        async function viewProduit(id) {
            try {
                showLoading('Chargement des détails...');
                const response = await apiCall(`/api/produits/${id}`);
                if (!response || !response.ok) {
                    hideLoading();
                    Toast.error('Erreur lors du chargement');
                    return;
                }

                const produit = await response.json();
                hideLoading();

                // Construire le HTML des détails
                let fournisseurHtml = '-';
                if (produit.fournisseur_id || produit.fournisseur_nom) {
                    const fournisseurId = produit.fournisseur_id;
                    const fournisseurNom = produit.fournisseur_nom || 'Fournisseur inconnu';
                    if (fournisseurId) {
                        fournisseurHtml = `<a href="entreprises-detail.html?id=${fournisseurId}" class="link-primary"><i class="fas fa-building"></i> ${fournisseurNom}</a>`;
                    } else {
                        fournisseurHtml = `<span><i class="fas fa-building"></i> ${fournisseurNom}</span>`;
                    }
                }

                const content = `
                    <div style="display: grid; gap: 1.5rem;">
                        <div>
                            <h3 style="margin-bottom: 1rem; color: var(--color-primary);">Informations générales</h3>
                            <div style="display: grid; gap: 0.75rem;">
                                <div><strong>Référence :</strong> ${produit.reference || '-'}</div>
                                <div><strong>Libellé :</strong> ${produit.libelle || '-'}</div>
                                <div><strong>Catégorie :</strong> ${produit.categorie_libelle || '-'}</div>
                                <div><strong>Fournisseur :</strong> ${fournisseurHtml}</div>
                            </div>
                        </div>
                        <div>
                            <h3 style="margin-bottom: 1rem; color: var(--color-primary);">Prix et stock</h3>
                            <div style="display: grid; gap: 0.75rem;">
                                <div><strong>Prix unitaire HT :</strong> ${formatCurrency(produit.prix_unitaire_ht || 0)}</div>
                                <div><strong>Unitaire :</strong> ${produit.unite || '-'}</div>
                                <div><strong>TVA :</strong> ${produit.tva_taux || 20}%</div>
                                ${produit.stock_disponible !== null && produit.stock_disponible !== undefined ? 
                                    `<div><strong>Stock disponible :</strong> ${produit.stock_disponible} ${produit.unite || 'unité(s)'}</div>` : 
                                    '<div><strong>Stock disponible :</strong> <span style="color: #666;">Non renseigné</span></div>'
                                }
                            </div>
                        </div>
                        ${produit.description ? `
                            <div>
                                <h3 style="margin-bottom: 1rem; color: var(--color-primary);">Description</h3>
                                <div style="background: var(--color-background-light); padding: 1rem; border-radius: 8px; white-space: pre-wrap;">${produit.description}</div>
                            </div>
                        ` : ''}
                        ${produit.caracteristiques_techniques ? `
                            <div>
                                <h3 style="margin-bottom: 1rem; color: var(--color-primary);">Caractéristiques techniques</h3>
                                <div style="background: var(--color-background-light); padding: 1rem; border-radius: 8px; white-space: pre-wrap;">${produit.caracteristiques_techniques}</div>
                            </div>
                        ` : ''}
                    </div>
                `;

                const footer = `
                    <button class="btn btn-secondary" onclick="Modal.hide('view-produit')">Fermer</button>
                    <button class="btn btn-primary" onclick="Modal.hide('view-produit'); editProduit(${id})">
                        <i class="fas fa-edit"></i> Modifier
                    </button>
                `;

                const modal = new Modal('view-produit', 'Détails du Produit', content, footer);
                modal.show();
            } catch (error) {
                hideLoading();
                Toast.error('Erreur lors du chargement: ' + error.message);
                console.error('Erreur viewProduit:', error);
            }
        }

        function editProduit(id) {
            console.log('editProduit appelé pour ID:', id);
            console.log('editProduitForm disponible:', typeof window.editProduitForm !== 'undefined');
            
            if (typeof window.editProduitForm === 'function') {
                window.editProduitForm(id);
            } else if (typeof editProduitForm === 'function') {
                editProduitForm(id);
            } else {
                Toast.error('Fonction d\'édition non disponible. Rechargez la page.');
                console.error('editProduitForm non disponible. Fonctions disponibles:', Object.keys(window).filter(k => k.includes('Produit')));
            }
        }

        async function deleteProduit(id) {
            confirmAction(
                'Êtes-vous sûr de vouloir supprimer ce produit ?',
                async () => {
                    try {
                        showLoading('Suppression...');
                        const response = await apiCall(`/api/produits/${id}`, { method: 'DELETE' });
                        if (response && response.ok) {
                            Toast.success('Produit supprimé');
                            loadProduits();
                        } else {
                            const error = await response.json();
                            Toast.error(error.error || 'Erreur lors de la suppression');
                        }
                    } catch (error) {
                        Toast.error('Erreur de connexion');
                    } finally {
                        hideLoading();
                    }
                }
            );
        }

        function filterProduits() {
            const search = document.getElementById('prod-search').value.toLowerCase();
            const categorie = document.getElementById('prod-filter-categorie').value;
            
            let filtered = allProduits.filter(p => {
                const matchSearch = !search || 
                    (p.reference && p.reference.toLowerCase().includes(search)) ||
                    (p.libelle && p.libelle.toLowerCase().includes(search));
                const matchCategorie = !categorie || p.categorie_id == categorie;
                return matchSearch && matchCategorie;
            });
            
            displayProduits(filtered);
        }

        // Fonction formatCurrency si elle n'est pas dans app.js
        if (typeof formatCurrency === 'undefined') {
            window.formatCurrency = function(amount) {
                if (!amount) return '0 GNF';
                return new Intl.NumberFormat('fr-FR', { 
                    minimumFractionDigits: 0,
                    maximumFractionDigits: 0
                }).format(amount) + ' GNF';
            };
        }

        // Vérifier que toutes les dépendances sont chargées
        document.addEventListener('DOMContentLoaded', () => {
            // Logs uniquement en mode développement
            if (window.location.hostname === 'localhost') {
                console.log('DOM chargé');
                console.log('apiCall disponible:', typeof apiCall !== 'undefined');
                console.log('Toast disponible:', typeof Toast !== 'undefined');
                console.log('Modal disponible:', typeof Modal !== 'undefined');
                console.log('showLoading disponible:', typeof showLoading !== 'undefined');
                console.log('createProduitForm disponible:', typeof window.createProduitForm !== 'undefined');
                console.log('editProduitForm disponible:', typeof window.editProduitForm !== 'undefined');
            }
            
            // Vérifier que toutes les fonctions nécessaires sont disponibles
            if (typeof Modal === 'undefined') {
                console.error('Modal non disponible');
                Toast.error('Erreur de chargement des composants. Rechargez la page.');
            }
            
            if (typeof window.createProduitForm === 'undefined') {
                console.error('createProduitForm non disponible');
                Toast.warning('Les fonctions de création ne sont pas disponibles. Rechargez la page.');
            }
            
            // Charger les produits après un court délai pour s'assurer que tout est prêt
            setTimeout(() => {
                loadProduits();
            }, 100);
        });
        
        // Si le DOM est déjà chargé, exécuter immédiatement
        if (document.readyState === 'loading') {
            // DOM pas encore chargé, attendre l'événement
        } else {
            // DOM déjà chargé, exécuter immédiatement
            setTimeout(() => {
                loadProduits();
            }, 100);
        }
        } // Fin du bloc if (checkAuth())
    </script>
</body>
</html>

