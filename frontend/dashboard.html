<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - SilyProcure</title>
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="css/animations.css">
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" integrity="sha512-iecdLmaskl7CVkqkXNQ/ZH/XLlvWZOJyj7Yy7tcenmpD1ypASozpmT/E0iPtmFIB46ZmdtAc9eNBvH0H/ZpiBw==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        /* --- VARIABLES & RESET --- */
        :root {
            --primary: #6366f1;
            --primary-dark: #4338ca;
            --secondary: #10b981;
            --accent: #f59e0b;
            --bg-color: #f3f4f6;
            --glass-bg: rgba(255, 255, 255, 0.7);
            --glass-border: rgba(255, 255, 255, 0.6);
            --text-main: #111827;
            --text-muted: #6b7280;
            --card-shadow: 0 10px 30px -5px rgba(0, 0, 0, 0.05);
        }

        body {
            font-family: 'Outfit', 'Inter', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-main);
            overflow-x: hidden;
            min-height: 100vh;
        }

        /* --- CANVAS BACKGROUND --- */
        #particleCanvas {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
            background: linear-gradient(120deg, #fdfbfb 0%, #ebedee 100%);
        }

        /* --- GLASSMORPHISM CARD --- */
        .glass {
            background: var(--glass-bg);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            border: 1px solid var(--glass-border);
            border-radius: 24px;
            box-shadow: var(--card-shadow);
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        .glass:hover {
            transform: translateY(-3px);
            box-shadow: 0 20px 40px -5px rgba(0, 0, 0, 0.1);
        }

        /* --- STATS GRID --- */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            padding: 1.5rem;
            position: relative;
            overflow: hidden;
            cursor: pointer;
            background: var(--glass-bg);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            border: 1px solid var(--glass-border);
            border-radius: 24px;
            box-shadow: var(--card-shadow);
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        .stat-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 20px 40px -5px rgba(0, 0, 0, 0.1);
        }

        .stat-icon {
            position: absolute;
            top: 1.5rem;
            right: 1.5rem;
            width: 48px;
            height: 48px;
            background: rgba(255,255,255,0.6);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            color: var(--primary);
        }

        .stat-label { 
            font-size: 0.9rem; 
            color: var(--text-muted); 
            font-weight: 500; 
            margin-bottom: 0.5rem; 
        }
        
        .stat-value { 
            font-size: 2.2rem; 
            font-weight: 700; 
            color: var(--text-main); 
            line-height: 1; 
            margin-bottom: 0.5rem; 
        }
        
        .stat-label-detail {
            font-size: 0.85rem;
            color: var(--text-muted);
        }

        .stat-change {
            font-size: 0.85rem;
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 4px 8px;
            border-radius: 20px;
        }
        
        .trend-up { 
            background: rgba(16, 185, 129, 0.1); 
            color: var(--secondary); 
        }
        
        .trend-down { 
            background: rgba(239, 68, 68, 0.1); 
            color: #ef4444; 
        }

        /* --- CHARTS AREA --- */
        .charts-section {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 1.5rem;
            margin-bottom: 2rem;
        }
        
        @media(max-width: 900px) { 
            .charts-section { 
                grid-template-columns: 1fr; 
            } 
        }

        .chart-card { 
            padding: 1.5rem; 
            height: 400px; 
            display: flex; 
            flex-direction: column; 
        }
        
        .card-header { 
            display: flex; 
            justify-content: space-between; 
            align-items: center;
            margin-bottom: 1.5rem; 
        }
        
        .card-title { 
            font-weight: 600; 
            font-size: 1.1rem; 
            color: var(--text-main);
        }
        
        .chart-container { 
            flex: 1; 
            position: relative; 
            width: 100%; 
            overflow: hidden; 
        }

        /* --- LISTS --- */
        .lists-section {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 1.5rem;
        }

        .list-item {
            display: flex;
            align-items: center;
            padding: 1rem;
            border-bottom: 1px solid rgba(0,0,0,0.03);
            transition: background 0.2s;
        }
        
        .list-item:hover { 
            background: rgba(255,255,255,0.3); 
        }
        
        .avatar {
            width: 40px; 
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(135deg, #a5b4fc, #6366f1);
            color: white;
            display: flex; 
            align-items: center; 
            justify-content: center;
            font-weight: bold;
            margin-right: 1rem;
        }
        
        .list-info h4 { 
            font-size: 0.95rem; 
            font-weight: 600; 
            margin: 0;
        }
        
        .list-info p { 
            font-size: 0.8rem; 
            color: var(--text-muted); 
            margin: 0.25rem 0 0 0;
        }
        
        .status-badge {
            margin-left: auto;
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
        }
        
        .bg-new { 
            background: var(--accent); 
            color: white; 
        }
        
        .bg-process { 
            background: #dbeafe; 
            color: var(--primary); 
        }

        /* --- OVERRIDE CONTAINER --- */
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 2rem;
            position: relative;
            z-index: 1;
        }

        /* --- PAGE HEADER --- */
        .page-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
        }

        .page-header h1 {
            font-size: 2rem;
            font-weight: 700;
            background: linear-gradient(45deg, var(--primary), #ec4899);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .btn {
            background: white;
            border: none;
            padding: 0.7rem 1.2rem;
            border-radius: 50px;
            cursor: pointer;
            font-family: inherit;
            font-weight: 600;
            color: var(--primary);
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.2s;
        }

        .btn:hover { 
            background: var(--primary); 
            color: white; 
        }

        /* --- LOADING SPINNER --- */
        .fa-spin { 
            animation: fa-spin 2s infinite linear; 
        }
        
        @keyframes fa-spin { 
            0% { transform: rotate(0deg); } 
            100% { transform: rotate(360deg); } 
        }

        /* --- EMPTY STATE --- */
        .empty-state {
            padding: 2rem;
            text-align: center;
            color: var(--text-muted);
        }

        .empty-state-text {
            font-size: 0.9rem;
        }
    </style>
</head>
<body>
    <!-- CANVAS D'ARRIÈRE-PLAN -->
    <canvas id="particleCanvas"></canvas>

    <script src="js/auth.js"></script>
    <script src="js/app.js"></script>
    <script src="js/components.js"></script>
    <script src="js/sidebar.js"></script>

    <div class="container">
        <div class="page-header">
            <h1><i class="fas fa-cubes"></i> Tableau de bord</h1>
            <button class="btn" onclick="refreshDashboard()" id="refreshBtn">
                <i class="fas fa-sync-alt" id="refreshIcon"></i> Actualiser
            </button>
        </div>

        <div class="stats-grid" id="stats-grid">
            <div class="loading">Chargement des statistiques...</div>
        </div>

        <div class="charts-section">
            <div class="glass chart-card">
                <div class="card-header">
                    <div class="card-title"><i class="fas fa-chart-line"></i> Évolution des commandes</div>
                    <select id="chartPeriod" style="border:none; background:transparent; font-family:'Outfit'; cursor:pointer; font-weight: 500; color: var(--primary);" onchange="updateChartPeriod()">
                        <option value="6">6 derniers mois</option>
                        <option value="12">Cette année</option>
                    </select>
                </div>
                <div class="chart-container">
                    <canvas id="chart-commandes"></canvas>
                </div>
            </div>

            <div class="glass chart-card">
                <div class="card-header">
                    <div class="card-title"><i class="fas fa-chart-pie"></i> Répartition des RFQ</div>
                </div>
                <div class="chart-container">
                    <canvas id="chart-rfq"></canvas>
                </div>
            </div>
        </div>

        <div class="lists-section">
            <div class="glass" style="padding: 1.5rem;">
                <div class="card-header">
                    <div class="card-title"><i class="fas fa-star"></i> Top 5 Fournisseurs</div>
                </div>
                <div id="top-fournisseurs">
                    <div class="loading">Chargement...</div>
                </div>
            </div>

            <div class="glass" style="padding: 1.5rem;">
                <div class="card-header">
                    <div class="card-title"><i class="fas fa-clock"></i> Activité récente</div>
                </div>
                <div id="recent-activity">
                    <div class="loading">Chargement...</div>
                </div>
            </div>
        </div>

        <div class="lists-section" style="margin-top: 1.5rem;">
            <div class="glass" style="padding: 1.5rem;">
                <div class="card-header">
                    <div class="card-title"><i class="fas fa-tachometer-alt"></i> Vue d'ensemble</div>
                </div>
                <div id="overview-stats">
                    <div class="loading">Chargement...</div>
                </div>
            </div>

            <div class="glass" style="padding: 1.5rem;">
                <div class="card-header">
                    <div class="card-title"><i class="fas fa-chart-bar"></i> Comparaison mensuelle</div>
                </div>
                <div id="comparison-stats">
                    <div class="loading">Chargement...</div>
                </div>
            </div>
        </div>

        <!-- Section Messages de Contact -->
        <div style="margin-top: 2rem;">
            <div class="glass" style="padding: 1.5rem;">
                <div class="card-header">
                    <div class="card-title"><i class="fas fa-envelope"></i> Messages de Contact</div>
                    <div style="display: flex; gap: 0.5rem;">
                        <button class="btn" onclick="loadContactMessages('non_lu')" title="Non lus" style="padding: 0.5rem 1rem; font-size: 0.9rem;">
                            <i class="fas fa-envelope"></i> Non lus
                        </button>
                        <button class="btn" onclick="loadContactMessages('tous')" title="Tous" style="padding: 0.5rem 1rem; font-size: 0.9rem;">
                            <i class="fas fa-list"></i> Tous
                        </button>
                    </div>
                </div>
                <div id="contact-messages-container">
                    <div class="loading">Chargement des messages...</div>
                </div>
            </div>
        </div>
    </div>

    <script src="js/auth.js"></script>
    <script src="js/app.js"></script>
    <script src="js/components.js"></script>
    <script src="js/notifications.js"></script>
    <script>
        // Vérifier l'authentification
        checkAuth();

        // Afficher le nom de l'utilisateur
        const user = JSON.parse(localStorage.getItem('user') || '{}');
        const userNameElement = document.getElementById('user-name');
        if (userNameElement) {
            userNameElement.textContent = `${user.prenom || ''} ${user.nom || ''}`.trim() || user.email;
        }

        let chartCommandes = null;
        let chartRFQ = null;

        // Charger les statistiques
        async function loadStats() {
            try {
                showLoading('Chargement des statistiques...');
                const response = await apiCall('/api/dashboard/stats');
                
                if (!response) {
                    hideLoading();
                    Toast.error('Impossible de charger les statistiques. Vérifiez votre connexion.');
                    document.getElementById('stats-grid').innerHTML = '<div class="alert alert-error">Erreur de connexion</div>';
                    return;
                }
                
                if (!response.ok) {
                    hideLoading();
                    const errorData = await response.json().catch(() => ({ error: 'Erreur inconnue' }));
                    Toast.error('Erreur: ' + (errorData.error || `Erreur ${response.status}`));
                    document.getElementById('stats-grid').innerHTML = `<div class="alert alert-error">${errorData.error || 'Erreur lors du chargement'}</div>`;
                    console.error('Erreur API stats:', errorData);
                    return;
                }
                
                const stats = await response.json();
                hideLoading();

                // Vérifier que stats est un objet valide
                if (!stats || typeof stats !== 'object') {
                    Toast.error('Format de données invalide');
                    document.getElementById('stats-grid').innerHTML = '<div class="alert alert-error">Format de données invalide</div>';
                    return;
                }

                // Afficher les cartes statistiques
                displayStatCards(stats);
                
                // Afficher les graphiques
                displayCharts(stats);
                
                // Afficher les autres sections
                displayTopFournisseurs(stats);
                displayOverview(stats);
                displayComparison(stats);
                
            } catch (error) {
                hideLoading();
                Toast.error('Erreur lors du chargement des statistiques: ' + (error.message || 'Erreur inconnue'));
                console.error('Erreur loadStats:', error);
                document.getElementById('stats-grid').innerHTML = `<div class="alert alert-error">Erreur: ${error.message || 'Erreur inconnue'}</div>`;
            }
        }

        function displayStatCards(stats) {
            const statsGrid = document.getElementById('stats-grid');
            
            // Vérifier que stats est valide
            if (!stats || typeof stats !== 'object') {
                statsGrid.innerHTML = '<div class="alert alert-error">Données invalides</div>';
                return;
            }
            
            // Calculer l'évolution avec gestion des valeurs nulles/undefined
            const montantMois = parseFloat(stats.montant_mois || 0);
            const montantMoisDernier = parseFloat(stats.montant_mois_dernier || 0);
            const evolutionMois = montantMoisDernier > 0 
                ? ((montantMois - montantMoisDernier) / montantMoisDernier * 100).toFixed(1)
                : (montantMois > 0 ? 100 : 0);
            const evolutionClass = evolutionMois >= 0 ? 'positive' : 'negative';
            const evolutionIcon = evolutionMois >= 0 ? '<i class="fas fa-arrow-up"></i>' : '<i class="fas fa-arrow-down"></i>';

            statsGrid.innerHTML = `
                <div class="stat-card glass" onclick="window.location.href='rfq.html'">
                    <div class="stat-icon"><i class="fas fa-file-invoice-dollar"></i></div>
                    <div class="stat-label">RFQ Total</div>
                    <div class="stat-value">${stats.rfq_total || 0}</div>
                    <div class="stat-label-detail">
                        ${stats.rfq_en_cours || 0} en cours • 
                        ${stats.rfq_brouillon || 0} brouillon • 
                        ${stats.rfq_cloture || 0} clôturées
                    </div>
                    <div class="stat-change trend-up"><i class="fas fa-file-alt"></i></div>
                </div>
                <div class="stat-card glass" onclick="window.location.href='devis.html'">
                    <div class="stat-icon"><i class="fas fa-briefcase"></i></div>
                    <div class="stat-label">Devis</div>
                    <div class="stat-value">${stats.devis_total || 0}</div>
                    <div class="stat-label-detail">
                        ${stats.devis_envoye || 0} envoyés • 
                        ${stats.devis_accepte || 0} acceptés
                    </div>
                    <div class="stat-change trend-up"><i class="fas fa-briefcase"></i></div>
                </div>
                <div class="stat-card glass" onclick="window.location.href='commandes.html'">
                    <div class="stat-icon"><i class="fas fa-box-open"></i></div>
                    <div class="stat-label">Commandes</div>
                    <div class="stat-value">${stats.commandes_total || 0}</div>
                    <div class="stat-label-detail">${stats.commandes_attente || 0} en attente</div>
                    <div class="stat-change trend-up"><i class="fas fa-shopping-cart"></i></div>
                </div>
                <div class="stat-card glass" onclick="window.location.href='factures.html'">
                    <div class="stat-icon"><i class="fas fa-exclamation-circle"></i></div>
                    <div class="stat-label">Factures en attente</div>
                    <div class="stat-value">${stats.factures_attente || 0}</div>
                    <div class="stat-label-detail">${formatCurrency(stats.montant_attente || 0)}</div>
                    <div class="stat-change ${stats.montant_attente > 0 ? 'trend-down' : 'trend-up'}"><i class="fas fa-money-bill-wave"></i></div>
                </div>
                <div class="stat-card glass" onclick="window.location.href='entreprises.html'">
                    <div class="stat-icon"><i class="fas fa-users"></i></div>
                    <div class="stat-label">Fournisseurs actifs</div>
                    <div class="stat-value">${stats.fournisseurs_actifs || 0}</div>
                    <div class="stat-label-detail">${stats.clients_actifs || 0} clients actifs</div>
                    <div class="stat-change trend-up"><i class="fas fa-building"></i></div>
                </div>
                <div class="stat-card glass" onclick="window.location.href='produits.html'">
                    <div class="stat-icon"><i class="fas fa-box"></i></div>
                    <div class="stat-label">Produits</div>
                    <div class="stat-value">${stats.produits_total || 0}</div>
                    <div class="stat-label-detail">Catalogue produits</div>
                    <div class="stat-change trend-up"><i class="fas fa-box"></i></div>
                </div>
                <div class="stat-card glass" onclick="window.location.href='demandes-devis.html'">
                    <div class="stat-icon"><i class="fas fa-inbox"></i></div>
                    <div class="stat-label">Demandes de devis</div>
                    <div class="stat-value">${stats.demandes_devis_total || 0}</div>
                    <div class="stat-label-detail">
                        ${stats.demandes_devis_nouvelles || 0} nouvelles • 
                        ${stats.demandes_devis_en_cours || 0} en cours
                    </div>
                    <div class="stat-change ${(stats.demandes_devis_nouvelles || 0) > 0 ? 'trend-down' : 'trend-up'}">
                        <i class="fas fa-inbox"></i>
                    </div>
                </div>
                <div class="stat-card glass">
                    <div class="stat-icon"><i class="fas fa-chart-line"></i></div>
                    <div class="stat-label">Commandes du mois</div>
                    <div class="stat-value">${stats.commandes_mois || 0}</div>
                    <div class="stat-label-detail">${formatCurrency(stats.montant_mois || 0)}</div>
                    <div class="stat-change ${evolutionClass}">
                        ${evolutionIcon} ${Math.abs(evolutionMois)}%
                    </div>
                </div>
            `;
        }

        // Configuration Globale Chart.js
        Chart.defaults.font.family = "'Outfit', sans-serif";
        Chart.defaults.color = '#6b7280';

        function displayCharts(stats) {
            // Vérifier que stats est valide
            if (!stats || typeof stats !== 'object') {
                return;
            }
            
            // Graphique évolution des commandes
            const ctxCommandes = document.getElementById('chart-commandes');
            if (ctxCommandes && stats.evolution_commandes && Array.isArray(stats.evolution_commandes)) {
                if (chartCommandes) {
                    chartCommandes.destroy();
                }
                
                const labels = stats.evolution_commandes.map(e => {
                    if (!e || !e.mois) return '';
                    const [year, month] = e.mois.split('-');
                    const monthNames = ['Jan', 'Fév', 'Mar', 'Avr', 'Mai', 'Jun', 'Jul', 'Aoû', 'Sep', 'Oct', 'Nov', 'Déc'];
                    return `${monthNames[parseInt(month) - 1] || month} ${year || ''}`;
                }).filter(l => l !== '');
                
                const data = stats.evolution_commandes.map(e => parseFloat(e.montant || 0));
                const counts = stats.evolution_commandes.map(e => parseInt(e.nombre || 0));

                // Créer un gradient pour le graphique
                const gradient = ctxCommandes.getContext('2d').createLinearGradient(0, 0, 0, 400);
                gradient.addColorStop(0, 'rgba(99, 102, 241, 0.5)');
                gradient.addColorStop(1, 'rgba(99, 102, 241, 0.0)');

                chartCommandes = new Chart(ctxCommandes, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Montant (GNF)',
                            data: data,
                            borderColor: '#6366f1',
                            backgroundColor: gradient,
                            borderWidth: 3,
                            pointBackgroundColor: '#fff',
                            pointBorderColor: '#6366f1',
                            pointRadius: 5,
                            fill: true,
                            tension: 0.4,
                            yAxisID: 'y'
                        }, {
                            label: 'Nombre de commandes',
                            data: counts,
                            borderColor: '#10b981',
                            backgroundColor: 'rgba(16, 185, 129, 0.1)',
                            borderWidth: 2,
                            tension: 0.4,
                            yAxisID: 'y1'
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'top',
                                display: false
                            },
                            title: {
                                display: false
                            }
                        },
                        scales: {
                            y: {
                                type: 'linear',
                                display: true,
                                position: 'left',
                                grid: {
                                    borderDash: [5, 5],
                                    color: 'rgba(0,0,0,0.05)'
                                },
                                border: {
                                    display: false
                                },
                                title: {
                                    display: true,
                                    text: 'Montant (GNF)'
                                }
                            },
                            y1: {
                                type: 'linear',
                                display: true,
                                position: 'right',
                                grid: {
                                    drawOnChartArea: false,
                                },
                                border: {
                                    display: false
                                },
                                title: {
                                    display: true,
                                    text: 'Nombre'
                                }
                            },
                            x: {
                                grid: {
                                    display: false
                                },
                                border: {
                                    display: false
                                }
                            }
                        }
                    }
                });
            }

            // Graphique répartition RFQ
            const ctxRFQ = document.getElementById('chart-rfq');
            if (ctxRFQ && stats.rfq_par_statut && Array.isArray(stats.rfq_par_statut)) {
                if (chartRFQ) {
                    chartRFQ.destroy();
                }

                const statutLabels = {
                    'brouillon': 'Brouillon',
                    'envoye': 'Envoyé',
                    'en_cours': 'En cours',
                    'cloture': 'Clôturé',
                    'annule': 'Annulé'
                };

                const labels = stats.rfq_par_statut.map(s => statutLabels[s.statut] || s.statut);
                const data = stats.rfq_par_statut.map(s => parseInt(s.nombre || 0));
                const colors = ['#6366f1', '#10b981', '#f59e0b', '#ef4444', '#e5e7eb'];

                chartRFQ = new Chart(ctxRFQ, {
                    type: 'doughnut',
                    data: {
                        labels: labels,
                        datasets: [{
                            data: data,
                            backgroundColor: colors.slice(0, data.length),
                            borderWidth: 0,
                            hoverOffset: 15
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        cutout: '70%',
                        plugins: {
                            legend: {
                                position: 'bottom',
                                labels: {
                                    usePointStyle: true,
                                    padding: 20
                                }
                            }
                        }
                    }
                });
            }
        }

        function updateChartPeriod() {
            // Fonction pour mettre à jour la période du graphique
            loadStats();
        }

        function displayTopFournisseurs(stats) {
            const container = document.getElementById('top-fournisseurs');
            if (!container) return;
            
            if (!stats || !stats.top_fournisseurs || !Array.isArray(stats.top_fournisseurs) || stats.top_fournisseurs.length === 0) {
                container.innerHTML = '<div class="empty-state"><div class="empty-state-text">Aucun fournisseur</div></div>';
                return;
            }

            const colors = ['#6366f1', '#10b981', '#f59e0b', '#ec4899', '#8b5cf6'];
            container.innerHTML = stats.top_fournisseurs.map((f, index) => {
                const initial = (f.nom || 'F').charAt(0).toUpperCase();
                const bgColor = colors[index % colors.length];
                return `
                    <div class="list-item">
                        <div class="avatar" style="background: ${bgColor}">${initial}</div>
                        <div class="list-info">
                            <h4>${index + 1}. ${f.nom}</h4>
                            <p>${f.nb_commandes || 0} commande(s) • ${formatCurrency(f.montant_total || 0)}</p>
                        </div>
                        <button class="btn" onclick="window.location.href='entreprises-detail.html?id=${f.id}'" style="padding: 0.5rem 1rem; font-size: 0.9rem;">
                            Voir
                        </button>
                    </div>
                `;
            }).join('');
        }

        function displayOverview(stats) {
            const container = document.getElementById('overview-stats');
            if (!container) return;
            
            if (!stats || typeof stats !== 'object') {
                container.innerHTML = '<div class="alert alert-error">Données invalides</div>';
                return;
            }
            
            container.innerHTML = `
                <div style="padding: 1rem;">
                    <div style="margin-bottom: 1rem; padding-bottom: 1rem; border-bottom: 1px solid #E0E7FF;">
                        <div style="font-size: 0.875rem; color: var(--color-neutral); margin-bottom: 0.25rem;">Demandes de devis</div>
                        <div style="font-size: 1.25rem; font-weight: bold; color: var(--color-primary);">
                            ${stats.demandes_devis_total || 0} total • ${stats.demandes_devis_nouvelles || 0} nouvelles
                        </div>
                    </div>
                    <div style="margin-bottom: 1rem; padding-bottom: 1rem; border-bottom: 1px solid #E0E7FF;">
                        <div style="font-size: 0.875rem; color: var(--color-neutral); margin-bottom: 0.25rem;">RFQ</div>
                        <div style="font-size: 1.25rem; font-weight: bold; color: var(--color-primary);">
                            ${stats.rfq_total || 0} total • ${stats.rfq_en_cours || 0} en cours
                        </div>
                    </div>
                    <div style="margin-bottom: 1rem; padding-bottom: 1rem; border-bottom: 1px solid #E0E7FF;">
                        <div style="font-size: 0.875rem; color: var(--color-neutral); margin-bottom: 0.25rem;">Devis</div>
                        <div style="font-size: 1.25rem; font-weight: bold; color: var(--color-primary);">
                            ${stats.devis_total || 0} total • ${stats.devis_accepte || 0} acceptés
                        </div>
                    </div>
                    <div>
                        <div style="font-size: 0.875rem; color: var(--color-neutral); margin-bottom: 0.25rem;">Entreprises</div>
                        <div style="font-size: 1.25rem; font-weight: bold; color: var(--color-primary);">
                            ${stats.fournisseurs_actifs || 0} fournisseurs • ${stats.clients_actifs || 0} clients
                        </div>
                    </div>
                </div>
            `;
        }

        function displayComparison(stats) {
            const container = document.getElementById('comparison-stats');
            if (!container) return;
            
            if (!stats || typeof stats !== 'object') {
                container.innerHTML = '<div class="alert alert-error">Données invalides</div>';
                return;
            }
            
            const montantMois = parseFloat(stats.montant_mois || 0);
            const montantMoisDernier = parseFloat(stats.montant_mois_dernier || 0);
            const evolution = montantMoisDernier > 0 
                ? ((montantMois - montantMoisDernier) / montantMoisDernier * 100).toFixed(1)
                : (montantMois > 0 ? 100 : 0);
            const evolutionClass = evolution >= 0 ? 'positive' : 'negative';
            const evolutionIcon = evolution >= 0 ? '<i class="fas fa-arrow-up"></i>' : '<i class="fas fa-arrow-down"></i>';

            container.innerHTML = `
                <div style="padding: 1rem;">
                    <div style="margin-bottom: 1.5rem;">
                        <div style="font-size: 0.875rem; color: var(--color-neutral); margin-bottom: 0.5rem;">Ce mois</div>
                        <div style="font-size: 1.5rem; font-weight: bold; color: var(--color-primary);">
                            ${stats.commandes_mois || 0} commandes
                        </div>
                        <div style="font-size: 1rem; color: var(--color-neutral); margin-top: 0.25rem;">
                            ${formatCurrency(stats.montant_mois || 0)}
                        </div>
                    </div>
                    <div style="margin-bottom: 1.5rem; padding-top: 1rem; border-top: 1px solid #E0E7FF;">
                        <div style="font-size: 0.875rem; color: var(--color-neutral); margin-bottom: 0.5rem;">Mois dernier</div>
                        <div style="font-size: 1.25rem; font-weight: bold; color: var(--color-neutral-dark);">
                            ${stats.commandes_mois_dernier || 0} commandes
                        </div>
                        <div style="font-size: 0.875rem; color: var(--color-neutral); margin-top: 0.25rem;">
                            ${formatCurrency(stats.montant_mois_dernier || 0)}
                        </div>
                    </div>
                    <div style="padding-top: 1rem; border-top: 2px solid #E0E7FF;">
                        <div style="font-size: 0.875rem; color: var(--color-neutral); margin-bottom: 0.25rem;">Évolution</div>
                        <div style="font-size: 1.5rem; font-weight: bold; color: ${evolution >= 0 ? 'var(--color-success)' : 'var(--color-danger)'};">
                            ${evolutionIcon} ${Math.abs(evolution)}%
                        </div>
                    </div>
                </div>
            `;
        }

        function refreshDashboard() {
            loadStats();
            loadRecentActivity();
            loadContactMessages('tous');
            Toast.success('Dashboard actualisé');
        }

        function formatCurrency(amount) {
            return new Intl.NumberFormat('fr-FR', { minimumFractionDigits: 0, maximumFractionDigits: 0 }).format(amount) + ' GNF';
        }

        async function loadRecentActivity() {
            try {
                const [rfqs, devis, commandes, demandesDevis] = await Promise.all([
                    apiCall('/api/rfq?statut=en_cours'),
                    apiCall('/api/devis?statut=envoye'),
                    apiCall('/api/commandes?statut=en_cours'),
                    apiCall('/api/contact/demandes?statut=nouvelle&limit=5')
                ]);

                const container = document.getElementById('recent-activity');
                let html = '';

                // Demandes de devis nouvelles (priorité)
                if (demandesDevis && demandesDevis.ok) {
                    const demandesData = await demandesDevis.json();
                    if (demandesData.data && demandesData.data.length > 0) {
                        html += '<h3 style="margin-bottom: 0.5rem; font-size: 0.875rem; color: var(--color-neutral); font-weight: 600;"><i class="fas fa-inbox" style="color: var(--color-accent);"></i> Nouvelles demandes de devis</h3>';
                        html += demandesData.data.slice(0, 3).map(d => `
                            <div style="padding: 0.75rem; border-bottom: 1px solid #E0E7FF; font-size: 0.875rem; cursor: pointer; background: ${d.statut === 'nouvelle' ? '#fef3c7' : 'white'};" 
                                 onclick="window.location.href='demandes-devis.html'">
                                <div style="font-weight: 600; color: var(--color-primary-dark); display: flex; align-items: center; gap: 0.5rem;">
                                    ${d.statut === 'nouvelle' ? '<span style="background: var(--color-accent); color: white; padding: 0.125rem 0.5rem; border-radius: 4px; font-size: 0.7rem;">NOUVEAU</span>' : ''}
                                    ${d.reference || 'DEM-' + d.id}
                                </div>
                                <div style="color: var(--color-neutral); font-size: 0.75rem; margin-top: 0.25rem;">${d.nom || '-'}${d.entreprise ? ` • ${d.entreprise}` : ''}</div>
                            </div>
                        `).join('');
                    }
                }

                if (rfqs && rfqs.ok) {
                    const rfqsData = await rfqs.json();
                    if (rfqsData.length > 0) {
                        html += '<h3 style="margin: 1rem 0 0.5rem 0; font-size: 0.875rem; color: var(--text-muted); font-weight: 600;"><i class="fas fa-file-alt"></i> RFQ en cours</h3>';
                        html += rfqsData.slice(0, 3).map(r => {
                            const initial = (r.destinataire_nom || 'R').charAt(0).toUpperCase();
                            return `
                                <div class="list-item" onclick="window.location.href='rfq-detail.html?id=${r.id}'" style="cursor: pointer;">
                                    <div class="avatar" style="background: #6366f1">${initial}</div>
                                    <div class="list-info">
                                        <h4>${r.numero || 'RFQ-' + r.id}</h4>
                                        <p>${r.destinataire_nom || '-'}</p>
                                    </div>
                                    <span class="status-badge bg-process">En cours</span>
                                </div>
                            `;
                        }).join('');
                    }
                }

                if (devis && devis.ok) {
                    const devisData = await devis.json();
                    if (devisData.length > 0) {
                        html += '<h3 style="margin: 1rem 0 0.5rem 0; font-size: 0.875rem; color: var(--text-muted); font-weight: 600;"><i class="fas fa-briefcase"></i> Devis en attente</h3>';
                        html += devisData.slice(0, 3).map(d => {
                            const initial = (d.numero || 'D').charAt(0).toUpperCase();
                            return `
                                <div class="list-item" onclick="window.location.href='devis.html'" style="cursor: pointer;">
                                    <div class="avatar" style="background: #10b981">${initial}</div>
                                    <div class="list-info">
                                        <h4>${d.numero || 'Devis-' + d.id}</h4>
                                        <p>${formatCurrency(d.total_ttc || 0)}</p>
                                    </div>
                                </div>
                            `;
                        }).join('');
                    }
                }

                if (commandes && commandes.ok) {
                    const commandesData = await commandes.json();
                    if (commandesData.length > 0) {
                        html += '<h3 style="margin: 1rem 0 0.5rem 0; font-size: 0.875rem; color: var(--text-muted); font-weight: 600;"><i class="fas fa-shopping-cart"></i> Commandes en cours</h3>';
                        html += commandesData.slice(0, 3).map(c => {
                            const initial = (c.numero || 'C').charAt(0).toUpperCase();
                            return `
                                <div class="list-item" onclick="window.location.href='commandes.html'" style="cursor: pointer;">
                                    <div class="avatar" style="background: #8b5cf6">${initial}</div>
                                    <div class="list-info">
                                        <h4>${c.numero || 'BC-' + c.id}</h4>
                                        <p>${formatCurrency(c.total_ttc || 0)}</p>
                                    </div>
                                </div>
                            `;
                        }).join('');
                    }
                }

                container.innerHTML = html || '<div class="empty-state"><div class="empty-state-text">Aucune activité récente</div></div>';
            } catch (error) {
                document.getElementById('recent-activity').innerHTML = '<div class="alert alert-error">Erreur de chargement</div>';
                console.error('Erreur:', error);
            }
        }

        window.refreshDashboard = refreshDashboard;

        async function loadContactMessages(filter = 'tous') {
            try {
                const container = document.getElementById('contact-messages-container');
                if (!container) return;
                
                container.innerHTML = '<div class="loading">Chargement...</div>';
                
                let url = '/api/contact/messages?limit=10';
                if (filter === 'non_lu') {
                    url += '&lu=false';
                }
                
                const response = await apiCall(url);
                if (!response || !response.ok) {
                    container.innerHTML = '<div class="alert alert-error">Erreur de chargement</div>';
                    return;
                }
                
                const data = await response.json();
                const messages = data.data || [];
                
                if (messages.length === 0) {
                    container.innerHTML = `
                        <div style="padding: 2rem; text-align: center; color: var(--color-neutral);">
                            <i class="fas fa-inbox" style="font-size: 3rem; opacity: 0.3; margin-bottom: 1rem;"></i>
                            <p>Aucun message de contact</p>
                        </div>
                    `;
                    return;
                }
                
                container.innerHTML = `
                    <div style="padding: 1rem;">
                        ${messages.map(msg => {
                            const date = new Date(msg.date_creation);
                            const dateStr = date.toLocaleDateString('fr-FR', { 
                                day: 'numeric', 
                                month: 'long', 
                                year: 'numeric',
                                hour: '2-digit', 
                                minute: '2-digit' 
                            });
                            
                            const unreadStyle = !msg.lu ? 'background: #f0f9ff; border-left: 4px solid #3B82F6;' : '';
                            const unreadBadge = !msg.lu ? '<span style="background: #3B82F6; color: white; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.75rem; margin-left: 0.5rem;">Nouveau</span>' : '';
                            
                            return `
                                <div style="padding: 1.5rem; margin-bottom: 1rem; border: 1px solid #e5e7eb; border-radius: 8px; ${unreadStyle}">
                                    <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 0.75rem;">
                                        <div style="flex: 1;">
                                            <h3 style="margin: 0; font-size: 1.1rem; font-weight: 600; color: var(--color-primary-dark); display: flex; align-items: center;">
                                                ${msg.sujet} ${unreadBadge}
                                            </h3>
                                            <div style="margin-top: 0.5rem; color: var(--color-neutral); font-size: 0.9rem;">
                                                <i class="fas fa-user"></i> ${msg.nom}
                                                ${msg.email ? ` • <i class="fas fa-envelope"></i> ${msg.email}` : ''}
                                                ${msg.telephone ? ` • <i class="fas fa-phone"></i> ${msg.telephone}` : ''}
                                            </div>
                                        </div>
                                        <div style="display: flex; gap: 0.5rem;">
                                            ${!msg.lu ? `<button class="btn btn-sm btn-secondary" onclick="markMessageAsRead(${msg.id})" title="Marquer comme lu">
                                                <i class="fas fa-check"></i>
                                            </button>` : ''}
                                            ${!msg.traite ? `<button class="btn btn-sm btn-primary" onclick="markMessageAsTreated(${msg.id})" title="Marquer comme traité">
                                                <i class="fas fa-check-double"></i>
                                            </button>` : '<span style="color: var(--color-success); font-size: 0.875rem;"><i class="fas fa-check-circle"></i> Traité</span>'}
                                        </div>
                                    </div>
                                    <div style="background: white; padding: 1rem; border-radius: 6px; margin-top: 0.75rem; border: 1px solid #e5e7eb;">
                                        <p style="margin: 0; color: var(--color-neutral-dark); line-height: 1.6; white-space: pre-wrap;">${escapeHtml(msg.message)}</p>
                                    </div>
                                    <div style="margin-top: 0.75rem; display: flex; justify-content: space-between; align-items: center;">
                                        <span style="color: #999; font-size: 0.85rem;"><i class="fas fa-clock"></i> ${dateStr}</span>
                                        ${msg.traite_par_nom ? `<span style="color: #999; font-size: 0.85rem;">Traité par: ${msg.traite_par_prenom || ''} ${msg.traite_par_nom || ''}</span>` : ''}
                                    </div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                `;
            } catch (error) {
                console.error('Erreur chargement messages:', error);
                const container = document.getElementById('contact-messages-container');
                if (container) {
                    container.innerHTML = '<div class="alert alert-error">Erreur de chargement</div>';
                }
            }
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        async function markMessageAsRead(messageId) {
            try {
                const response = await apiCall(`/api/contact/messages/${messageId}/lu`, {
                    method: 'PATCH',
                    body: JSON.stringify({ lu: true })
                });
                if (response && response.ok) {
                    Toast.success('Message marqué comme lu');
                    loadContactMessages('tous');
                } else {
                    Toast.error('Erreur lors de la mise à jour');
                }
            } catch (error) {
                console.error('Erreur:', error);
                Toast.error('Erreur de connexion');
            }
        }

        async function markMessageAsTreated(messageId) {
            try {
                const response = await apiCall(`/api/contact/messages/${messageId}/traite`, {
                    method: 'PATCH',
                    body: JSON.stringify({ traite: true })
                });
                if (response && response.ok) {
                    Toast.success('Message marqué comme traité');
                    loadContactMessages('tous');
                } else {
                    Toast.error('Erreur lors de la mise à jour');
                }
            } catch (error) {
                console.error('Erreur:', error);
                Toast.error('Erreur de connexion');
            }
        }

        // Charger toutes les données au démarrage
        loadStats();
        loadRecentActivity();
        loadContactMessages('tous');
        
        // Actualiser automatiquement toutes les 5 minutes
        setInterval(() => {
            loadStats();
            loadRecentActivity();
            loadContactMessages('tous');
        }, 300000); // 5 minutes
    </script>
</body>
</html>

