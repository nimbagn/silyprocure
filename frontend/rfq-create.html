<!DOCTYPE html>
<html lang="fr" class="h-full bg-gray-50">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cr√©er une RFQ - SilyProcure</title>
    
    <!-- CSS Charte Graphique Pro Confiance -->
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="css/responsive.css">
    <link rel="stylesheet" href="css/animations.css">
    <link rel="stylesheet" href="css/workflow.css">
    
        <!-- Tailwind CSS (optimis√© pour production) -->
    <link rel="stylesheet" href="css/tailwind.css">
    
    <!-- Font Awesome & Google Fonts -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Dashboard Theme CSS -->
    <link rel="stylesheet" href="css/dashboard-theme.css">
    <!-- Modern Theme (inspir√© de home.html) -->
    <link rel="stylesheet" href="css/modern-theme.css">

    
    <style>
        /* Stepper/Wizard Styles */
        .wizard-container {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        .wizard-steps {
            display: flex;
            justify-content: space-between;
            margin-bottom: 2rem;
            position: relative;
        }
        
        .wizard-step {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            position: relative;
        }
        
        .wizard-step::before {
            content: '';
            position: absolute;
            top: 20px;
            left: 50%;
            width: 100%;
            height: 2px;
            background: var(--color-neutral-light, #E5E7EB);
            z-index: 0;
        }
        
        .wizard-step:first-child::before {
            display: none;
        }
        
        .wizard-step.completed::before,
        .wizard-step.active::before {
            background: var(--color-primary);
        }
        
        .wizard-step-circle {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: white;
            border: 3px solid var(--color-neutral-light, #E5E7EB);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            color: var(--color-neutral);
            position: relative;
            z-index: 1;
            transition: all 0.3s ease;
        }
        
        .wizard-step.active .wizard-step-circle {
            background: var(--color-primary);
            border-color: var(--color-primary);
            color: white;
        }
        
        .wizard-step.completed .wizard-step-circle {
            background: var(--color-success);
            border-color: var(--color-success);
            color: white;
        }
        
        .wizard-step-label {
            margin-top: 0.5rem;
            font-size: 0.75rem;
            font-weight: 500;
            color: var(--color-neutral);
            text-align: center;
        }
        
        .wizard-step.active .wizard-step-label {
            color: var(--color-primary);
            font-weight: 600;
        }
        
        .wizard-step.completed .wizard-step-label {
            color: var(--color-success);
        }
        
        .wizard-content {
            min-height: 400px;
        }
        
        .wizard-section {
            display: none;
            animation: fadeIn 0.3s ease-out;
        }
        
        .wizard-section.active {
            display: block;
        }
        
        .form-section-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--color-primary);
            margin-bottom: 1.5rem;
            padding-bottom: 0.75rem;
            border-bottom: 2px solid var(--color-background-blue, #E0E7FF);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .fournisseur-card {
            cursor: pointer;
            transition: all 0.3s ease;
            border: 2px solid transparent;
        }
        
        .fournisseur-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }
        
        .fournisseur-card.selected {
            border-color: var(--color-primary);
            background: rgba(0, 56, 122, 0.05);
        }
        
        .ligne-article {
            background: var(--color-background-light);
            border: 1px solid var(--color-neutral-light, #E5E7EB);
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1rem;
            position: relative;
        }
        
        .recap-box {
            background: linear-gradient(135deg, #E0E7FF 0%, #C7D2FE 100%);
            border: 2px solid var(--color-primary);
            border-radius: 12px;
            padding: 1.5rem;
        }
    </style>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        /* Override pour utiliser le style moderne de home.html */
        body {
            font-family: "Plus Jakarta Sans", sans-serif !important;
            background: #f8fafc !important;
        }
        
        /* Utiliser brand-600 au lieu de primary-500 */
        .text-primary-600, .text-primary-500 { color: #2563eb !important; }
        .bg-primary-600, .bg-primary-500 { background-color: #2563eb !important; }
        .border-primary-500 { border-color: #2563eb !important; }
        
        /* Am√©liorer les cartes */
        .card, .stat-card, .facture-card, .filters-card, .kpi-card {
            border-radius: 1.5rem !important;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1) !important;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1) !important;
        }
        
        .card:hover, .facture-card:hover {
            transform: translateY(-4px) !important;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 8px 10px -6px rgba(0, 0, 0, 0.1) !important;
        }
    </style>
</head>
<body class="h-full flex flex-col">
    <script src="js/auth.js"></script>
    <script src="js/app.js"></script>
    <script src="js/components.js?v=20260116"></script>
    <script>window.DISABLE_SIDEBAR = true;</script>
    <script src="js/sidebar.js"></script>
    <script src="js/modern-menu.js"></script>

    <!-- Navbar Moderne selon charte Pro Confiance -->
    <nav class="bg-white border-b-2 border-blue-100 sticky top-0 z-50 shadow-sm" role="navigation" aria-label="Navigation principale">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-16">
                <!-- Logo & Nav Links -->
                <div class="flex items-center">
                    <div class="flex-shrink-0 flex items-center cursor-pointer" onclick="window.location.href='dashboard.html'">
                        <span class="text-2xl font-bold logo-primary">Sily<span class="text-gray-900">Procure</span></span>
                    </div>
                    <nav class="hidden sm:ml-6 sm:flex sm:space-x-1 md:ml-8" aria-label="Menu de navigation">
                        <a href="dashboard.html" class="border-transparent text-neutral-500 hover:border-primary-300 hover:text-primary-700 inline-flex items-center px-3 sm:px-4 py-2 border-b-2 text-sm font-medium transition-colors min-h-[44px] whitespace-nowrap">
                            <i class="fas fa-chart-line mr-1.5 sm:mr-2 text-xs sm:text-sm" aria-hidden="true"></i>
                            <span>Dashboard</span>
                        </a>
                        <a href="rfq.html" class="border-primary-500 text-primary-900 inline-flex items-center px-3 sm:px-4 py-2 border-b-2 text-sm font-semibold min-h-[44px] transition-colors whitespace-nowrap" aria-current="page">
                            <i class="fas fa-file-contract mr-1.5 sm:mr-2 text-xs sm:text-sm" aria-hidden="true"></i>
                            <span>RFQ</span>
                        </a>
                        <a href="devis.html" class="border-transparent text-neutral-500 hover:border-primary-300 hover:text-primary-700 inline-flex items-center px-3 sm:px-4 py-2 border-b-2 text-sm font-medium transition-colors min-h-[44px] whitespace-nowrap">
                            <i class="fas fa-file-invoice-dollar mr-1.5 sm:mr-2 text-xs sm:text-sm" aria-hidden="true"></i>
                            <span>Devis</span>
                        </a>
                        <a href="commandes.html" class="border-transparent text-neutral-500 hover:border-primary-300 hover:text-primary-700 inline-flex items-center px-3 sm:px-4 py-2 border-b-2 text-sm font-medium transition-colors min-h-[44px] whitespace-nowrap">
                            <i class="fas fa-shopping-cart mr-1.5 sm:mr-2 text-xs sm:text-sm" aria-hidden="true"></i>
                            <span>Commandes</span>
                        </a>
                        <a href="entreprises.html" class="border-transparent text-neutral-500 hover:border-primary-300 hover:text-primary-700 inline-flex items-center px-3 sm:px-4 py-2 border-b-2 text-sm font-medium transition-colors min-h-[44px] whitespace-nowrap">
                            <i class="fas fa-building mr-1.5 sm:mr-2 text-xs sm:text-sm" aria-hidden="true"></i>
                            <span>Entreprises</span>
                        </a>
                    </nav>
                </div>

                <!-- Search Bar & Profile -->
                <div class="flex items-center gap-4">
                    <!-- Global Search -->
                    <div class="hidden lg:block relative text-neutral-500 focus-within:text-primary-600" role="search">
                        <label for="global-search" class="sr-only">Rechercher dans l'application</label>
                        <div class="pointer-events-none absolute inset-y-0 left-0 pl-3 flex items-center">
                            <i class="fas fa-search" aria-hidden="true"></i>
                        </div>
                        <input id="global-search" class="block w-64 bg-blue-50 py-2.5 pl-10 pr-4 border border-blue-200 rounded-full leading-5 text-neutral-700 placeholder-neutral-400 focus:outline-none focus:bg-white focus:ring-2 focus:ring-primary-500 focus:border-primary-500 sm:text-sm transition duration-150 ease-in-out min-h-[44px]" placeholder="Rechercher..." type="search" aria-label="Rechercher">
                    </div>

                    <!-- Notifications -->
                    <button class="relative p-2.5 text-neutral-500 hover:text-primary-600 transition-colors rounded-lg hover:bg-blue-50 min-w-[44px] min-h-[44px] flex items-center justify-center" aria-label="Notifications" title="Notifications">
                        <i class="far fa-bell text-xl" aria-hidden="true"></i>
                        <span class="absolute top-2 right-2 block h-2.5 w-2.5 rounded-full bg-red-500 ring-2 ring-white" aria-hidden="true"></span>
                    </button>

                    <!-- Profile Dropdown -->
                    <div class="relative flex items-center gap-3">
                        <div class="h-10 w-10 rounded-full bg-primary-100 flex items-center justify-center text-primary-700 font-bold border-2 border-primary-200 shadow-sm" aria-label="Profil utilisateur">
                            <span id="user-initials">U</span>
                        </div>
                        <span id="user-name" class="hidden md:block text-sm font-semibold text-neutral-700 min-w-[120px]">Chargement...</span>
                        <button onclick="logout()" class="ml-1 text-xs text-red-600 hover:text-red-700 border border-red-200 rounded-lg px-3 py-2 hover:bg-red-50 transition min-h-[44px] flex items-center gap-1.5" aria-label="D√©connexion" title="D√©connexion">
                            <i class="fas fa-sign-out-alt" aria-hidden="true"></i>
                            <span class="hidden lg:inline">D√©connexion</span>
                        </button>
                    </div>
                    
                    <!-- Menu mobile -->
                    <div class="sm:hidden ml-2">
                        <button id="mobile-menu-button" onclick="toggleMobileMenu()" class="inline-flex items-center justify-center p-2.5 rounded-lg text-neutral-500 hover:text-primary-600 hover:bg-blue-50 focus:outline-none focus:ring-2 focus:ring-inset focus:ring-primary-500 min-w-[44px] min-h-[44px]" aria-expanded="false" aria-label="Menu principal" aria-controls="mobile-menu">
                            <i class="fas fa-bars text-xl"></i>
                        </button>
                    </div>
                </div>
            </div>
            <!-- Menu mobile d√©roulant -->
            <div id="mobile-menu" class="hidden sm:hidden border-t-2 border-blue-100 bg-white shadow-lg">
                <div class="px-4 pt-3 pb-4 space-y-1">
                    <a href="dashboard.html" class="border-transparent text-neutral-700 hover:bg-blue-50 hover:text-primary-700 hover:border-l-4 hover:border-primary-300 block px-4 py-3 rounded-lg text-base font-medium transition-all min-h-[44px] flex items-center gap-3">
                        <i class="fas fa-chart-line text-neutral-500" aria-hidden="true"></i>
                        <span>Dashboard</span>
                    </a>
                    <a href="rfq.html" class="bg-gradient-to-r from-blue-50 to-primary-50 border-l-4 border-primary-500 text-primary-700 block px-4 py-3 rounded-lg text-base font-semibold min-h-[44px] flex items-center gap-3 transition-all">
                        <i class="fas fa-file-contract text-primary-600" aria-hidden="true"></i>
                        <span>RFQ</span>
                    </a>
                    <a href="devis.html" class="border-transparent text-neutral-700 hover:bg-blue-50 hover:text-primary-700 hover:border-l-4 hover:border-primary-300 block px-4 py-3 rounded-lg text-base font-medium transition-all min-h-[44px] flex items-center gap-3">
                        <i class="fas fa-file-invoice-dollar text-neutral-500" aria-hidden="true"></i>
                        <span>Devis</span>
                    </a>
                    <a href="commandes.html" class="border-transparent text-neutral-700 hover:bg-blue-50 hover:text-primary-700 hover:border-l-4 hover:border-primary-300 block px-4 py-3 rounded-lg text-base font-medium transition-all min-h-[44px] flex items-center gap-3">
                        <i class="fas fa-shopping-cart text-neutral-500" aria-hidden="true"></i>
                        <span>Commandes</span>
                    </a>
                    <a href="entreprises.html" class="border-transparent text-neutral-700 hover:bg-blue-50 hover:text-primary-700 hover:border-l-4 hover:border-primary-300 block px-4 py-3 rounded-lg text-base font-medium transition-all min-h-[44px] flex items-center gap-3">
                        <i class="fas fa-building text-neutral-500" aria-hidden="true"></i>
                        <span>Entreprises</span>
                    </a>
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="flex-1 max-w-7xl w-full mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <div class="container">
        <!-- Hero Section -->
        <div class="hero-section" style="text-align: left; padding: 2rem;">
            <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 1rem;">
                <div>
                    <button class="btn btn-secondary" onclick="window.location.href='rfq.html'" style="margin-bottom: 1rem;">
                        <i class="fas fa-arrow-left"></i> Retour
                    </button>
                    <h1 class="hero-title" style="font-size: 2rem; margin: 0;"><i class="fas fa-clipboard-list"></i> Nouvelle demande de devis (RFQ)</h1>
                    <p class="hero-description" style="text-align: left; margin: 0.5rem 0 0 0; max-width: 100%;">
                        Cr√©ez une nouvelle demande de devis en suivant les √©tapes ci-dessous
                    </p>
                </div>
            </div>
        </div>

        <!-- Wizard Stepper -->
        <div class="card" style="margin-bottom: 2rem;">
            <div class="wizard-steps">
                <div class="wizard-step active" id="wizard-step-1">
                    <div class="wizard-step-circle">1</div>
                    <div class="wizard-step-label">Informations</div>
                </div>
                <div class="wizard-step" id="wizard-step-2">
                    <div class="wizard-step-circle">2</div>
                    <div class="wizard-step-label">Fournisseurs</div>
                </div>
                <div class="wizard-step" id="wizard-step-3">
                    <div class="wizard-step-circle">3</div>
                    <div class="wizard-step-label">Articles</div>
                </div>
                <div class="wizard-step" id="wizard-step-4">
                    <div class="wizard-step-circle">4</div>
                    <div class="wizard-step-label">Conditions</div>
                </div>
            </div>
        </div>

        <div class="card">
            <form id="rfq-form" onsubmit="handleCreateRFQ(event)">
                <!-- √âtape 1 : Informations g√©n√©rales -->
                <div class="wizard-content">
                    <div class="wizard-section active" id="step-1">
                        <h3 class="form-section-title">
                            <i class="fas fa-clipboard-list"></i> √âtape 1 : Informations g√©n√©rales
                        </h3>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="rfq-numero">Num√©ro RFQ</label>
                            <input type="text" id="rfq-numero" name="numero" readonly 
                                   style="background: #f0f0f0; cursor: not-allowed;"
                                   placeholder="G√©n√©ration automatique...">
                            <small style="color: var(--color-neutral); font-size: 0.75rem;">G√©n√©r√© automatiquement</small>
                        </div>
                        <div class="form-group">
                            <label for="rfq-date">Date d'√©mission *</label>
                            <input type="date" id="rfq-date" name="date_emission" required>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="rfq-date-limite">Date limite de r√©ponse *</label>
                            <input type="date" id="rfq-date-limite" name="date_limite_reponse" required>
                        </div>
                        <div class="form-group">
                            <label for="rfq-categorie">Cat√©gorie</label>
                            <select id="rfq-categorie" name="categorie_id">
                                <option value="">S√©lectionner une cat√©gorie</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="rfq-description">Description de la demande *</label>
                        <textarea id="rfq-description" name="description" required rows="4" 
                                  placeholder="D√©crivez en d√©tail vos besoins..."></textarea>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="rfq-projet">Projet (optionnel)</label>
                            <select id="rfq-projet" name="projet_id">
                                <option value="">Aucun projet</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="rfq-centre-cout">Centre de co√ªt (optionnel)</label>
                            <select id="rfq-centre-cout" name="centre_cout_id">
                                <option value="">Aucun centre de co√ªt</option>
                            </select>
                        </div>
                    </div>

                    </div>

                <!-- √âtape 2 : Recherche et s√©lection de fournisseurs -->
                <div class="wizard-section" id="step-2">
                    <h3 class="form-section-title">
                        <i class="fas fa-search"></i> √âtape 2 : Recherche de fournisseurs
                    </h3>

                    <div class="search-bar">
                        <div class="search-input">
                            <input type="text" id="search-fournisseur" placeholder="Rechercher un fournisseur par nom, secteur..." 
                                   onkeyup="searchFournisseurs()">
                        </div>
                        <button type="button" class="btn btn-secondary" onclick="searchFournisseurs()"><i class="fas fa-search"></i> Rechercher</button>
                    </div>

                    <div id="fournisseurs-suggestions" style="margin-top: 1.5rem;">
                        <div class="loading">Recherche de fournisseurs...</div>
                    </div>
                </div>

                <!-- √âtape 3 : D√©tails produits/services -->
                <div class="wizard-section" id="step-3">
                    <h3 class="form-section-title">
                        <i class="fas fa-box"></i> √âtape 3 : Produits/Services demand√©s
                    </h3>

                    <div id="lignes-rfq">
                        <div class="ligne-article">
                            <div class="form-row">
                                <div class="form-group" style="flex: 2;">
                                    <label>Description *</label>
                                    <input type="text" name="ligne-description[]" required placeholder="Description du produit/service">
                                </div>
                                <div class="form-group">
                                    <label>Quantit√© *</label>
                                    <input type="number" name="ligne-quantite[]" required min="0.01" step="0.01" placeholder="1">
                                </div>
                                <div class="form-group">
                                    <label>Unit√©</label>
                                    <input type="text" name="ligne-unite[]" placeholder="unit√©" value="unit√©">
                                </div>
                                <div class="form-group" style="flex: 1;">
                                    <label>Produit (optionnel)</label>
                                    <select name="ligne-produit[]" class="produit-select">
                                        <option value="">S√©lectionner un produit</option>
                                    </select>
                                    <small style="color: var(--color-neutral); font-size: 0.75rem; display: block; margin-top: 0.25rem;">
                                        <i class="fas fa-info-circle"></i> Les produits disponibles d√©pendent des fournisseurs s√©lectionn√©s
                                    </small>
                                </div>
                            </div>
                            <div class="form-group">
                                <label>Sp√©cifications techniques</label>
                                <textarea name="ligne-specifications[]" rows="2" placeholder="Sp√©cifications d√©taill√©es..."></textarea>
                            </div>
                        </div>
                    </div>

                    <button type="button" class="btn btn-secondary" onclick="addLigneRFQ()" style="margin-bottom: 1rem;">
                        <i class="fas fa-plus"></i> Ajouter une ligne
                    </button>
                </div>

                <!-- √âtape 4 : Conditions de livraison -->
                <div class="wizard-section" id="step-4">
                    <h3 class="form-section-title">
                        <i class="fas fa-truck"></i> √âtape 4 : Conditions de livraison et paiement
                    </h3>

                    <!-- Adresse de livraison -->
                    <div class="card" style="background: var(--color-background-light); margin-bottom: 1.5rem;">
                        <h4 style="margin-bottom: 1rem; color: var(--color-primary-dark); display: flex; align-items: center; gap: 0.5rem;">
                            <i class="fas fa-map-marker-alt"></i> Adresse de livraison
                        </h4>
                        <div class="form-row">
                            <div class="form-group" style="flex: 1;">
                                <label for="rfq-adresse-livraison">S√©lectionner une adresse existante</label>
                                <select id="rfq-adresse-livraison" name="lieu_livraison_id" onchange="updateAdresseLivraison()">
                                    <option value="">Chargement des adresses...</option>
                                </select>
                                <small style="color: var(--color-neutral); font-size: 0.75rem;">
                                    üí° S√©lectionnez une adresse enregistr√©e. Si aucune adresse n'est disponible :<br>
                                    1. Allez sur la page <a href="entreprises.html" style="color: var(--color-primary); text-decoration: underline;">Entreprises</a><br>
                                    2. Cliquez sur une entreprise pour voir ses d√©tails<br>
                                    3. Cliquez sur "<i class="fas fa-plus"></i> Ajouter une adresse" et cr√©ez une adresse de type "Livraison"
                                </small>
                            </div>
                            <div class="form-group" style="flex: 0 0 auto; display: flex; align-items: flex-end; gap: 0.5rem;">
                                <button type="button" class="btn btn-secondary" onclick="showCreateAdresseModal()" style="white-space: nowrap;">
                                    <i class="fas fa-plus"></i> Nouvelle adresse
                                </button>
                                <a href="entreprises.html" class="btn btn-secondary" style="white-space: nowrap; text-decoration: none;">
                                    <i class="fas fa-building"></i> G√©rer entreprises
                                </a>
                            </div>
                        </div>
                        <div id="adresse-livraison-preview" style="margin-top: 1rem; padding: 1rem; background: white; border-radius: 8px; border: 2px dashed #E0E7FF; display: none;">
                            <div style="font-weight: 600; margin-bottom: 0.5rem; color: var(--color-primary-dark);"><i class="fas fa-map-marker-alt"></i> Adresse s√©lectionn√©e :</div>
                            <div id="adresse-livraison-details" style="color: var(--color-neutral-dark); line-height: 1.6;"></div>
                        </div>
                    </div>

                    <!-- Dates et d√©lais -->
                    <div class="card" style="background: var(--color-background-light); margin-bottom: 1.5rem;">
                        <h4 style="margin-bottom: 1rem; color: var(--color-primary-dark); display: flex; align-items: center; gap: 0.5rem;">
                            üìÖ Dates et d√©lais
                        </h4>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="rfq-date-livraison">üìÜ Date de livraison souhait√©e *</label>
                                <input type="date" id="rfq-date-livraison" name="date_livraison_souhaitee" required>
                                <small style="color: var(--color-neutral); font-size: 0.75rem;">
                                    Date √† laquelle vous souhaitez recevoir la commande
                                </small>
                            </div>
                            <div class="form-group">
                                <label for="rfq-delai-livraison">‚è±Ô∏è D√©lai de livraison (jours)</label>
                                <input type="number" id="rfq-delai-livraison" name="delai_livraison" min="1" 
                                       placeholder="Ex: 30" style="width: 100%;">
                                <small style="color: var(--color-neutral); font-size: 0.75rem;">
                                    Nombre de jours pour la livraison
                                </small>
                            </div>
                        </div>
                    </div>

                    <!-- Conditions commerciales -->
                    <div class="card" style="background: var(--color-background-light); margin-bottom: 1.5rem;">
                        <h4 style="margin-bottom: 1rem; color: var(--color-primary-dark); display: flex; align-items: center; gap: 0.5rem;">
                            <i class="fas fa-briefcase"></i> Conditions commerciales
                        </h4>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="rfq-incoterms">üåç Incoterms</label>
                                <select id="rfq-incoterms" name="incoterms">
                                    <option value="">S√©lectionner un Incoterm</option>
                                    <option value="EXW">EXW - Ex Works (√Ä l'usine)</option>
                                    <option value="FCA">FCA - Free Carrier (Franco transporteur)</option>
                                    <option value="CPT">CPT - Carriage Paid To (Port pay√© jusqu'√†)</option>
                                    <option value="CIP">CIP - Carriage and Insurance Paid (Port pay√©, assurance comprise)</option>
                                    <option value="DAP">DAP - Delivered At Place (Rendu au lieu de destination)</option>
                                    <option value="DPU">DPU - Delivered at Place Unloaded (Rendu au lieu de destination d√©charg√©)</option>
                                    <option value="DDP">DDP - Delivered Duty Paid (Rendu droits acquitt√©s)</option>
                                    <option value="FAS">FAS - Free Alongside Ship (Franco le long du navire)</option>
                                    <option value="FOB">FOB - Free On Board (Franco √† bord)</option>
                                    <option value="CFR">CFR - Cost and Freight (Co√ªt et fret)</option>
                                    <option value="CIF">CIF - Cost, Insurance and Freight (Co√ªt, assurance et fret)</option>
                                </select>
                                <small style="color: var(--color-neutral); font-size: 0.75rem;">
                                    Termes de livraison internationaux
                                </small>
                            </div>
                            <div class="form-group">
                                <label for="rfq-conditions-paiement"><i class="fas fa-credit-card"></i> Conditions de paiement *</label>
                                <select id="rfq-conditions-paiement" name="conditions_paiement" required>
                                    <option value="">S√©lectionner</option>
                                    <option value="comptant">Comptant</option>
                                    <option value="30_jours_net">30 jours net</option>
                                    <option value="60_jours_net">60 jours net</option>
                                    <option value="90_jours_net">90 jours net</option>
                                    <option value="acompte_30">Acompte 30% + solde 30 jours</option>
                                    <option value="acompte_50">Acompte 50% + solde 30 jours</option>
                                    <option value="autre">Autre (√† pr√©ciser)</option>
                                </select>
                                <small style="color: var(--color-neutral); font-size: 0.75rem;">
                                    Modalit√©s de paiement accept√©es
                                </small>
                            </div>
                        </div>
                        <div class="form-group" id="conditions-paiement-autre" style="display: none; margin-top: 1rem;">
                            <label for="rfq-conditions-paiement-detail">Pr√©cisez les conditions de paiement</label>
                            <input type="text" id="rfq-conditions-paiement-detail" name="conditions_paiement_detail" 
                                   placeholder="Ex: 30% √† la commande, 70% √† la livraison">
                        </div>
                    </div>

                    <!-- Informations compl√©mentaires -->
                    <div class="card" style="background: var(--color-background-light); margin-bottom: 1.5rem;">
                        <h4 style="margin-bottom: 1rem; color: var(--color-primary-dark); display: flex; align-items: center; gap: 0.5rem;">
                            <i class="fas fa-edit"></i> Informations compl√©mentaires
                        </h4>
                        <div class="form-group">
                            <label for="rfq-notes-livraison">Notes de livraison</label>
                            <textarea id="rfq-notes-livraison" name="notes_livraison" rows="3" 
                                      placeholder="Instructions sp√©ciales pour la livraison, horaires de r√©ception, contact sur place, etc."></textarea>
                        </div>
                        <div class="form-group">
                            <label for="rfq-garanties">Garanties demand√©es</label>
                            <textarea id="rfq-garanties" name="garanties" rows="2" 
                                      placeholder="Garanties de qualit√©, de conformit√©, de performance, etc."></textarea>
                        </div>
                    </div>

                    <!-- R√©capitulatif -->
                    <div class="recap-box">
                        <h4 style="margin-bottom: 1rem; color: var(--color-primary-dark); display: flex; align-items: center; gap: 0.5rem;">
                            <i class="fas fa-check"></i> R√©capitulatif
                        </h4>
                        <div id="recap-summary" style="color: var(--color-neutral-dark); line-height: 1.8;">
                            <div><i class="fas fa-clipboard-list"></i> <strong>Lignes de commande:</strong> <span id="recap-lignes">-</span></div>
                            <div><i class="fas fa-building"></i> <strong>Fournisseurs s√©lectionn√©s:</strong> <span id="recap-fournisseurs">-</span></div>
                            <div><i class="far fa-calendar-alt"></i> <strong>Date limite de r√©ponse:</strong> <span id="recap-date-limite">-</span></div>
                        </div>
                    </div>
                </div>
                </div>

                <!-- Navigation Buttons -->
                <div class="card-footer" style="display: flex; justify-content: space-between; padding: 1.5rem; border-top: 1px solid var(--color-neutral-light, #E5E7EB);">
                    <button type="button" id="btn-prev" class="btn btn-secondary" onclick="previousStep()" style="display: none;">
                        <i class="fas fa-arrow-left"></i> Pr√©c√©dent
                    </button>
                    <div style="margin-left: auto; display: flex; gap: 1rem;">
                        <button type="button" id="btn-next" class="btn btn-primary" onclick="nextStep()">
                            Suivant <i class="fas fa-arrow-right"></i>
                        </button>
                        <button type="submit" id="btn-submit" class="btn btn-success" style="display: none; padding: 0.75rem 2rem; font-size: 1.1rem; font-weight: 600;">
                            <i class="fas fa-check"></i> Cr√©er la RFQ
                        </button>
                    </div>
                </div>
            </form>
        </div>
    </div>
    </main>

<script src="js/forms.js"></script>
    <script>
        checkAuth();

        const user = JSON.parse(localStorage.getItem('user') || '{}');
        // Initialisation du nom d'utilisateur et des initiales
        const userNameEl = document.getElementById('user-name');
        const userInitialsEl = document.getElementById('user-initials');
        if (userNameEl) {
            userNameEl.textContent = `${user.prenom || ''} ${user.nom || ''}`.trim() || user.email || 'Utilisateur';
        }
        if (userInitialsEl && user.prenom) {
            userInitialsEl.textContent = (user.prenom.charAt(0) + (user.nom ? user.nom.charAt(0) : '')).toUpperCase();
        }
        document.getElementById('user-name').textContent = `${user.prenom || ''} ${user.nom || ''}`.trim() || user.email;

        let selectedFournisseurs = [];

        // Initialiser les dates (avec v√©rification de s√©curit√©)
        const rfqDateEl = document.getElementById('rfq-date');
        if (rfqDateEl) {
            rfqDateEl.valueAsDate = new Date();
        }
        const dateLimite = new Date();
        dateLimite.setDate(dateLimite.getDate() + 14);
        const rfqDateLimiteEl = document.getElementById('rfq-date-limite');
        if (rfqDateLimiteEl) {
            rfqDateLimiteEl.valueAsDate = dateLimite;
        }

        // G√©n√©rer le num√©ro RFQ automatiquement
        async function generateRFQNumber() {
            try {
                const response = await apiCall('/api/rfq/generate-number');
                if (response && response.ok) {
                    const data = await response.json();
                    document.getElementById('rfq-numero').value = data.numero;
                } else {
                    // Fallback : g√©n√©rer c√¥t√© client
                    const year = new Date().getFullYear();
                    const timestamp = Date.now().toString().slice(-6);
                    document.getElementById('rfq-numero').value = `RFQ-${year}-${timestamp}`;
                }
            } catch (error) {
                // Fallback : g√©n√©rer c√¥t√© client
                const year = new Date().getFullYear();
                const timestamp = Date.now().toString().slice(-6);
                document.getElementById('rfq-numero').value = `RFQ-${year}-${timestamp}`;
            }
        }
        
        generateRFQNumber();

        // Charger les cat√©gories, projets, centres de co√ªt (avec v√©rifications de s√©curit√©)
        if (typeof loadCategories === 'function') {
            loadCategories('rfq-categorie');
        } else {
            console.warn('loadCategories n\'est pas d√©finie');
        }
        loadProjets();
        loadCentresCout();
        // Ne pas charger tous les produits au d√©but - ils seront charg√©s apr√®s s√©lection des fournisseurs
        searchFournisseurs();
        
        // Charger les adresses de livraison (attendre que le DOM soit pr√™t)
        setTimeout(() => {
            loadAdressesLivraison();
        }, 500);
        
        // Initialiser la date de livraison (30 jours apr√®s aujourd'hui)
        const dateLivraison = new Date();
        dateLivraison.setDate(dateLivraison.getDate() + 30);
        const rfqDateLivraisonEl = document.getElementById('rfq-date-livraison');
        if (rfqDateLivraisonEl) {
            rfqDateLivraisonEl.valueAsDate = dateLivraison;
        }
        
        // G√©rer l'affichage conditionnel des conditions de paiement
        const rfqConditionsPaiementEl = document.getElementById('rfq-conditions-paiement');
        if (rfqConditionsPaiementEl) {
            rfqConditionsPaiementEl.addEventListener('change', function() {
                const autreDiv = document.getElementById('conditions-paiement-autre');
                if (autreDiv) {
                    if (this.value === 'autre') {
                        autreDiv.style.display = 'block';
                    } else {
                        autreDiv.style.display = 'none';
                    }
                }
            });
        }
        
        // Variables du wizard - DOIT √™tre d√©clar√© AVANT updateWizardUI()
        let currentWizardStep = 1;
        const totalWizardSteps = 4;
        
        // Initialiser le wizard au chargement
        updateWizardUI();

        async function loadProjets() {
            try {
                const response = await apiCall('/api/projets');
                if (response && response.ok) {
                    const projets = await response.json();
                    const select = document.getElementById('rfq-projet');
                    projets.forEach(proj => {
                        const option = document.createElement('option');
                        option.value = proj.id;
                        option.textContent = `${proj.code || ''} - ${proj.libelle}`.trim();
                        select.appendChild(option);
                    });
                }
            } catch (error) {
                console.error('Erreur chargement projets:', error);
            }
        }

        async function loadCentresCout() {
            try {
                const response = await apiCall('/api/projets/centres-cout');
                if (response && response.ok) {
                    const centres = await response.json();
                    const select = document.getElementById('rfq-centre-cout');
                    centres.forEach(centre => {
                        const option = document.createElement('option');
                        option.value = centre.id;
                        option.textContent = `${centre.code} - ${centre.libelle}`;
                        select.appendChild(option);
                    });
                }
            } catch (error) {
                console.error('Erreur chargement centres de co√ªt:', error);
            }
        }

        // Variable pour stocker tous les produits disponibles (tous fournisseurs confondus)
        let allAvailableProduits = [];

        async function loadProduits() {
            // Si aucun fournisseur n'est s√©lectionn√©, vider les selects
            if (selectedFournisseurs.length === 0) {
                document.querySelectorAll('.produit-select').forEach(select => {
                    select.innerHTML = '<option value="">S√©lectionner</option>';
                });
                allAvailableProduits = [];
                return;
            }

            try {
                // Charger les produits de tous les fournisseurs s√©lectionn√©s
                const allProduits = [];
                const produitsMap = new Map(); // Pour √©viter les doublons

                for (const fournisseurId of selectedFournisseurs) {
                    try {
                        const response = await apiCall(`/api/produits/fournisseur/${fournisseurId}?limit=1000`);
                        if (response && response.ok) {
                            const result = await response.json();
                            const produits = Array.isArray(result) ? result : (result.data || []);
                            
                            // Ajouter uniquement les produits disponibles et non dupliqu√©s
                            produits.forEach(prod => {
                                if (prod.disponible !== 0 && !produitsMap.has(prod.id)) {
                                    produitsMap.set(prod.id, prod);
                                    allProduits.push(prod);
                                }
                            });
                        }
                    } catch (error) {
                        console.error(`Erreur chargement produits pour fournisseur ${fournisseurId}:`, error);
                    }
                }

                allAvailableProduits = allProduits;

                // Mettre √† jour tous les selects
                document.querySelectorAll('.produit-select').forEach(select => {
                    // Sauvegarder la valeur s√©lectionn√©e
                    const currentValue = select.value;
                    
                    // Vider et r√©initialiser
                    select.innerHTML = '<option value="">S√©lectionner</option>';
                    
                    // Ajouter les produits
                    allProduits.forEach(prod => {
                        const option = document.createElement('option');
                        option.value = prod.id;
                        option.textContent = `${prod.reference} - ${prod.libelle}${prod.prix_fournisseur ? ` (${formatCurrency(prod.prix_fournisseur)})` : ''}`;
                        select.appendChild(option);
                    });

                    // Restaurer la s√©lection si elle existe toujours
                    if (currentValue && allProduits.find(p => p.id == currentValue)) {
                        select.value = currentValue;
                    }
                });

                if (allProduits.length === 0) {
                    Toast.info('Aucun produit disponible pour les fournisseurs s√©lectionn√©s', 3000);
                }
            } catch (error) {
                console.error('Erreur chargement produits:', error);
                Toast.error('Erreur lors du chargement des produits');
            }
        }

        function formatCurrency(amount) {
            if (!amount) return '';
            return new Intl.NumberFormat('fr-GN', { 
                style: 'currency', 
                currency: 'GNF',
                minimumFractionDigits: 0,
                maximumFractionDigits: 0
            }).format(amount);
        }

        async function searchFournisseurs() {
            const search = document.getElementById('search-fournisseur').value;
            const container = document.getElementById('fournisseurs-suggestions');
            
            try {
                container.innerHTML = '<div class="loading"><div class="loading-spinner"></div> Recherche...</div>';
                
                const response = await apiCall(`/api/entreprises?type=fournisseur${search ? '&search=' + encodeURIComponent(search) : ''}`);
                if (!response) {
                    container.innerHTML = '<div class="empty-state">Erreur de chargement</div>';
                    return;
                }

                const fournisseurs = await response.json();
                
                if (fournisseurs.length === 0) {
                    container.innerHTML = '<div class="empty-state"><div class="empty-state-icon">üè≠</div><div class="empty-state-title">Aucun fournisseur trouv√©</div></div>';
                    return;
                }

                container.innerHTML = `
                    <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 1rem;">
                        ${fournisseurs.map(f => `
                            <div class="card" style="cursor: pointer; transition: var(--transition); ${selectedFournisseurs.includes(f.id) ? 'border: 2px solid var(--color-primary);' : ''}" 
                                 onclick="toggleFournisseur(${f.id}, '${f.nom.replace(/'/g, "\\'")}')">
                                <div style="display: flex; justify-content: space-between; align-items: start;">
                                    <div>
                                        <h4 style="margin: 0 0 0.5rem 0;">${f.nom}</h4>
                                        ${f.rccm ? `<div style="font-size: 0.75rem; color: var(--color-neutral);">RCCM: ${f.rccm}</div>` : ''}
                                        ${f.secteur_activite ? `<div style="font-size: 0.75rem; color: var(--color-neutral); margin-top: 0.25rem;">${f.secteur_activite}</div>` : ''}
                                        ${f.email ? `<div style="font-size: 0.75rem; color: var(--color-neutral); margin-top: 0.25rem;"><i class="fas fa-envelope"></i> ${f.email}</div>` : ''}
                                    </div>
                                    <div style="font-size: 1.5rem;">
                                        ${selectedFournisseurs.includes(f.id) ? '<i class="fas fa-check"></i>' : '‚òê'}
                                    </div>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                    <div style="margin-top: 1rem; padding: 1rem; background: var(--color-background-blue); border-radius: 8px;">
                        <strong>Fournisseurs s√©lectionn√©s :</strong> <span id="selected-count">${selectedFournisseurs.length}</span>
                    </div>
                `;
            } catch (error) {
                container.innerHTML = '<div class="alert alert-error">Erreur lors de la recherche</div>';
                console.error('Erreur:', error);
            }
        }

        function toggleFournisseur(id, nom) {
            const index = selectedFournisseurs.indexOf(id);
            if (index > -1) {
                selectedFournisseurs.splice(index, 1);
            } else {
                selectedFournisseurs.push(id);
            }
            searchFournisseurs();
            // Recharger les produits apr√®s changement de s√©lection
            loadProduits();
        }

        function addLigneRFQ() {
            const container = document.getElementById('lignes-rfq');
            const ligne = document.createElement('div');
            ligne.className = 'ligne-article';
            ligne.innerHTML = `
                <div class="form-row">
                    <div class="form-group" style="flex: 2;">
                        <label>Description *</label>
                        <input type="text" name="ligne-description[]" required placeholder="Description du produit/service">
                    </div>
                    <div class="form-group">
                        <label>Quantit√© *</label>
                        <input type="number" name="ligne-quantite[]" required min="0.01" step="0.01" placeholder="1">
                    </div>
                    <div class="form-group">
                        <label>Unit√©</label>
                        <input type="text" name="ligne-unite[]" placeholder="unit√©" value="unit√©">
                    </div>
                    <div class="form-group" style="flex: 1;">
                        <label>Produit (optionnel)</label>
                        <select name="ligne-produit[]" class="produit-select">
                            <option value="">S√©lectionner</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <button type="button" class="btn btn-danger btn-sm" onclick="this.closest('.card').remove()" style="margin-top: 1.75rem;"><i class="fas fa-trash"></i></button>
                    </div>
                </div>
                <div class="form-group">
                    <label>Sp√©cifications techniques</label>
                    <textarea name="ligne-specifications[]" rows="2" placeholder="Sp√©cifications d√©taill√©es..."></textarea>
                </div>
            `;
            container.appendChild(ligne);
            // Charger les produits pour le nouveau select (utilise les produits d√©j√† charg√©s)
            const newSelect = ligne.querySelector('.produit-select');
            if (newSelect && allAvailableProduits.length > 0) {
                newSelect.innerHTML = '<option value="">S√©lectionner</option>';
                allAvailableProduits.forEach(prod => {
                    const option = document.createElement('option');
                    option.value = prod.id;
                    option.textContent = `${prod.reference} - ${prod.libelle}${prod.prix_fournisseur ? ` (${formatCurrency(prod.prix_fournisseur)})` : ''}`;
                    newSelect.appendChild(option);
                });
            } else {
                // Si aucun produit n'est encore charg√©, charger maintenant
                loadProduits();
            }
        }

        function updateWizardUI() {
            // Mettre √† jour les √©tapes du wizard
            for (let i = 1; i <= totalWizardSteps; i++) {
                const stepEl = document.getElementById(`wizard-step-${i}`);
                const sectionEl = document.getElementById(`step-${i}`);
                
                // Reset classes (avec v√©rification de s√©curit√©)
                if (stepEl) {
                    stepEl.classList.remove('active', 'completed');
                }
                if (sectionEl) {
                    sectionEl.classList.remove('active');
                }
                
                if (stepEl) {
                    if (i < currentWizardStep) {
                        stepEl.classList.add('completed');
                    } else if (i === currentWizardStep) {
                        stepEl.classList.add('active');
                        if (sectionEl) sectionEl.classList.add('active');
                    }
                }
            }
            
            // Mettre √† jour les boutons
            const btnPrev = document.getElementById('btn-prev');
            const btnNext = document.getElementById('btn-next');
            const btnSubmit = document.getElementById('btn-submit');
            
            if (btnPrev) {
                if (currentWizardStep === 1) {
                    btnPrev.style.display = 'none';
                } else {
                    btnPrev.style.display = 'inline-flex';
                }
            }
            
            if (btnNext && btnSubmit) {
                if (currentWizardStep === totalWizardSteps) {
                    btnNext.style.display = 'none';
                    btnSubmit.style.display = 'inline-flex';
                } else {
                    btnNext.style.display = 'inline-flex';
                    btnSubmit.style.display = 'none';
                }
            }
        }

        function nextStep() {
            // Valider l'√©tape actuelle
            const currentSection = document.getElementById(`step-${currentWizardStep}`);
            if (!currentSection) return;
            
            const inputs = currentSection.querySelectorAll('input[required], select[required], textarea[required]');
            let valid = true;

            inputs.forEach(input => {
                if (!input.value.trim()) {
                    valid = false;
                    input.style.borderColor = 'var(--color-danger)';
                    setTimeout(() => {
                        input.style.borderColor = '';
                    }, 2000);
                } else {
                    input.style.borderColor = '';
                }
            });

            if (!valid) {
                Toast.error('Veuillez remplir tous les champs obligatoires');
                return;
            }

            // V√©rifications sp√©cifiques
            if (currentWizardStep === 2 && selectedFournisseurs.length === 0) {
                Toast.error('Veuillez s√©lectionner au moins un fournisseur');
                return;
            }
            
            if (currentWizardStep === 3) {
                const lignes = document.querySelectorAll('#lignes-rfq > .ligne-article, #lignes-rfq > .card');
                if (lignes.length === 0) {
                    Toast.error('Veuillez ajouter au moins une ligne de produit/service');
                    return;
                }
            }

            // Passer √† l'√©tape suivante
            if (currentWizardStep < totalWizardSteps) {
                currentWizardStep++;
                updateWizardUI();
                
                // Charger les produits si on arrive √† l'√©tape 3
                if (currentWizardStep === 3) {
                    loadProduits();
                }

                // Mettre √† jour le r√©capitulatif si on arrive √† l'√©tape 4
                if (currentWizardStep === 4) {
                    updateRecap();
                    // Recharger les adresses si n√©cessaire
                    setTimeout(() => {
                        const select = document.getElementById('rfq-adresse-livraison');
                        if (select && (select.options.length <= 1 || select.innerHTML.includes('Chargement'))) {
                            loadAdressesLivraison();
                        }
                    }, 300);
                }
            }
        }

        function previousStep() {
            if (currentWizardStep > 1) {
                currentWizardStep--;
                updateWizardUI();
            }
        }

        async function loadAdressesLivraison() {
            try {
                const select = document.getElementById('rfq-adresse-livraison');
                
                if (!select) {
                    console.warn('Select rfq-adresse-livraison non trouv√©');
                    return;
                }

                // Afficher un message de chargement
                select.innerHTML = '<option value="">Chargement des adresses...</option>';

                // Charger toutes les adresses (pas seulement livraison, pour plus de flexibilit√©)
                const response = await apiCall('/api/adresses');
                
                if (!response) {
                    select.innerHTML = '<option value="">Erreur d\'authentification</option>';
                    Toast.error('Erreur d\'authentification. Veuillez vous reconnecter.');
                    return;
                }
                
                if (response.ok) {
                    const adresses = await response.json();
                    select.innerHTML = '<option value="">S√©lectionner une adresse</option>';
                    
                    if (!adresses || adresses.length === 0) {
                        select.innerHTML = '<option value="">Aucune adresse disponible</option>';
                        // Afficher un message informatif avec instructions claires
                        Toast.info('Aucune adresse trouv√©e. Vous avez des entreprises mais sans adresses. Allez sur la page Entreprises, cliquez sur une entreprise, puis ajoutez une adresse de livraison.', 8000);
                    } else {
                        // Filtrer les adresses de livraison en priorit√©, puis toutes les autres
                        const adressesLivraison = adresses.filter(a => a.type_adresse === 'livraison');
                        const autresAdresses = adresses.filter(a => a.type_adresse !== 'livraison');
                        
                        const adressesTriees = [...adressesLivraison, ...autresAdresses];
                        
                        adressesTriees.forEach(addr => {
                            const option = document.createElement('option');
                            option.value = addr.id;
                            const typeLabel = addr.type_adresse === 'livraison' ? '<i class="fas fa-box"></i> Livraison' : 
                                            addr.type_adresse === 'facturation' ? '<i class="fas fa-file-invoice"></i> Facturation' :
                                            addr.type_adresse === 'siege' ? '<i class="fas fa-building"></i> Si√®ge' : '<i class="fas fa-map-marker-alt"></i> Autre';
                            const ville = addr.ville || 'Ville non sp√©cifi√©e';
                            const libelle = addr.libelle || addr.type_adresse || 'Adresse';
                            option.textContent = `${typeLabel} - ${libelle} - ${ville}`;
                            option.dataset.adresse = JSON.stringify(addr);
                            select.appendChild(option);
                        });
                    }
                } else {
                    // G√©rer les erreurs HTTP
                    let errorMessage = 'Erreur de chargement';
                    try {
                        const errorData = await response.json();
                        errorMessage = errorData.error || errorMessage;
                        console.error('Erreur API adresses:', errorData);
                    } catch (e) {
                        console.error('Erreur parsing r√©ponse:', e);
                    }
                    
                    select.innerHTML = `<option value="">${errorMessage}</option>`;
                    
                    if (response.status === 401) {
                        Toast.error('Session expir√©e. Veuillez vous reconnecter.');
                    } else if (response.status === 403) {
                        Toast.error('Acc√®s refus√©. V√©rifiez vos permissions.');
                    } else {
                        Toast.error(`Erreur lors du chargement des adresses: ${errorMessage}`);
                    }
                }
            } catch (error) {
                console.error('Erreur chargement adresses:', error);
                const select = document.getElementById('rfq-adresse-livraison');
                if (select) {
                    select.innerHTML = '<option value="">Erreur de connexion au serveur</option>';
                }
                Toast.error('Impossible de charger les adresses. V√©rifiez votre connexion.');
            }
        }

        function updateAdresseLivraison() {
            try {
                const select = document.getElementById('rfq-adresse-livraison');
                const preview = document.getElementById('adresse-livraison-preview');
                const details = document.getElementById('adresse-livraison-details');
                
                if (!select || !preview || !details) {
                    console.warn('√âl√©ments DOM non trouv√©s pour updateAdresseLivraison');
                    return;
                }
                
                if (select.value) {
                    const option = select.options[select.selectedIndex];
                    if (!option || !option.dataset.adresse) {
                        preview.style.display = 'none';
                        return;
                    }
                    
                    const adresse = JSON.parse(option.dataset.adresse);
                    
                    details.innerHTML = `
                        <div><strong>${adresse.libelle || adresse.type_adresse}</strong></div>
                        <div>${adresse.adresse_ligne1 || ''}</div>
                        ${adresse.adresse_ligne2 ? `<div>${adresse.adresse_ligne2}</div>` : ''}
                        <div>${adresse.code_postal || ''} ${adresse.ville || ''}</div>
                        <div>${adresse.pays || 'Guin√©e'}</div>
                        ${adresse.latitude && adresse.longitude ? `
                            <div style="margin-top: 0.5rem; font-size: 0.75rem; color: var(--color-primary);">
                                <i class="fas fa-map-marker-alt"></i> ${parseFloat(adresse.latitude).toFixed(6)}, ${parseFloat(adresse.longitude).toFixed(6)}
                            </div>
                        ` : ''}
                    `;
                    preview.style.display = 'block';
                } else {
                    preview.style.display = 'none';
                }
            } catch (error) {
                console.error('Erreur updateAdresseLivraison:', error);
            }
        }

        function showCreateAdresseModal() {
            const message = 'Pour cr√©er une adresse de livraison :\n\n1. Allez sur la page Entreprises\n2. Cliquez sur une entreprise pour voir ses d√©tails\n3. Cliquez sur "<i class="fas fa-plus"></i> Ajouter une adresse"\n4. S√©lectionnez le type "Livraison" et remplissez les informations';
            Toast.info(message, 8000);
            
            // Proposer de rediriger
            setTimeout(() => {
                if (confirm('Souhaitez-vous √™tre redirig√© vers la page Entreprises pour ajouter une adresse ?')) {
                    window.location.href = 'entreprises.html';
                }
            }, 2000);
        }

        function updateRecap() {
            try {
                // Mettre √† jour le r√©capitulatif
                const lignesCount = document.querySelectorAll('[name="ligne-description[]"]').length;
                const recapLignes = document.getElementById('recap-lignes');
                const recapFournisseurs = document.getElementById('recap-fournisseurs');
                const recapDateLimite = document.getElementById('recap-date-limite');
                
                if (recapLignes) recapLignes.textContent = lignesCount;
                if (recapFournisseurs) recapFournisseurs.textContent = selectedFournisseurs.length;
                
                const dateLimite = document.getElementById('rfq-date-limite');
                if (dateLimite && recapDateLimite) {
                    if (dateLimite.value) {
                        const date = new Date(dateLimite.value);
                        recapDateLimite.textContent = date.toLocaleDateString('fr-FR');
                    } else {
                        recapDateLimite.textContent = 'Non d√©finie';
                    }
                }
            } catch (error) {
                console.error('Erreur updateRecap:', error);
            }
        }

        async function handleCreateRFQ(event) {
            event.preventDefault();
            
            if (selectedFournisseurs.length === 0) {
                Toast.error('Veuillez s√©lectionner au moins un fournisseur');
                return;
            }

            // V√©rifier qu'au moins une ligne est pr√©sente
            const descriptionInputs = event.target.querySelectorAll('input[name="ligne-description[]"]');
            if (descriptionInputs.length === 0 || Array.from(descriptionInputs).every(d => !d.value.trim())) {
                Toast.error('Veuillez ajouter au moins une ligne de produit/service');
                return;
            }

            const formData = new FormData(event.target);
            const data = {
                numero: formData.get('numero') || null, // null = g√©n√©ration automatique c√¥t√© serveur
                date_emission: formData.get('date_emission'),
                date_limite_reponse: formData.get('date_limite_reponse'),
                categorie_id: formData.get('categorie_id') || null,
                description: formData.get('description'),
                projet_id: formData.get('projet_id') || null,
                centre_cout_id: formData.get('centre_cout_id') || null,
                lieu_livraison_id: formData.get('lieu_livraison_id') || null,
                date_livraison_souhaitee: formData.get('date_livraison_souhaitee') || null,
                incoterms: formData.get('incoterms') || null,
                conditions_paiement: formData.get('conditions_paiement') || null,
                lignes: []
            };

            // R√©cup√©rer les lignes
            const descriptions = formData.getAll('ligne-description[]');
            const quantites = formData.getAll('ligne-quantite[]');
            const unites = formData.getAll('ligne-unite[]');
            const produits = formData.getAll('ligne-produit[]');
            const specifications = formData.getAll('ligne-specifications[]');
            const references = formData.getAll('ligne-reference[]');

            for (let i = 0; i < descriptions.length; i++) {
                // R√©cup√©rer la r√©f√©rence du produit si un produit est s√©lectionn√©
                let reference = references[i] || null;
                if (!reference && produits[i]) {
                    // Trouver le select correspondant √† cette ligne
                    const ligneCards = document.querySelectorAll('#lignes-rfq > .card');
                    if (ligneCards[i]) {
                        const produitSelect = ligneCards[i].querySelector('select[name="ligne-produit[]"]');
                        if (produitSelect && produitSelect.value) {
                            const option = produitSelect.options[produitSelect.selectedIndex];
                            if (option && option.textContent) {
                                reference = option.textContent.split(' - ')[0] || null;
                            }
                        }
                    }
                }

                data.lignes.push({
                    description: descriptions[i],
                    quantite: parseFloat(quantites[i]),
                    unite: unites[i] || 'unit√©',
                    produit_id: produits[i] || null,
                    reference: reference || null,
                    specifications: specifications[i] || null,
                    ordre: i
                });
            }

            showLoading('Cr√©ation de la RFQ...');

            try {
                // Cr√©er la RFQ pour chaque fournisseur s√©lectionn√©
                const rfqIds = [];
                const errors = [];
                
                for (const fournisseurId of selectedFournisseurs) {
                    const rfqData = { ...data, destinataire_id: fournisseurId };
                    const response = await apiCall('/api/rfq', {
                        method: 'POST',
                        body: JSON.stringify(rfqData)
                    });

                    if (response && response.ok) {
                        const result = await response.json();
                        rfqIds.push(result.id);
                    } else {
                        // R√©cup√©rer le message d'erreur
                        let errorMsg = 'Erreur inconnue';
                        try {
                            const errorData = await response.json();
                            errorMsg = errorData.error || errorMsg;
                        } catch (e) {
                            errorMsg = `Erreur ${response.status}: ${response.statusText}`;
                        }
                        errors.push(`Fournisseur ID ${fournisseurId}: ${errorMsg}`);
                        console.error('Erreur cr√©ation RFQ pour fournisseur', fournisseurId, ':', errorMsg);
                    }
                }

                hideLoading();
                
                if (rfqIds.length > 0) {
                    if (errors.length > 0) {
                        Toast.warning(`${rfqIds.length} RFQ cr√©√©e(s), ${errors.length} erreur(s)`);
                        console.error('Erreurs:', errors);
                    } else {
                        Toast.success(`${rfqIds.length} RFQ cr√©√©e(s) avec succ√®s`);
                    }
                    setTimeout(() => {
                        window.location.href = 'rfq.html';
                    }, 1500);
                } else {
                    Toast.error('Aucune RFQ n\'a pu √™tre cr√©√©e. ' + (errors.length > 0 ? errors[0] : 'V√©rifiez les donn√©es saisies.'));
                    console.error('Toutes les cr√©ations ont √©chou√©:', errors);
                }
            } catch (error) {
                hideLoading();
                Toast.error('Erreur lors de la cr√©ation: ' + error.message);
                console.error('Erreur:', error);
            }
        }
        
        // Menu mobile
        function toggleMobileMenu() {
            const menu = document.getElementById('mobile-menu');
            const button = document.getElementById('mobile-menu-button');
            if (menu && button) {
                const isHidden = menu.classList.contains('hidden');
                menu.classList.toggle('hidden');
                button.setAttribute('aria-expanded', isHidden ? 'true' : 'false');
                const icon = button.querySelector('i');
                if (icon) {
                    if (isHidden) {
                        icon.classList.remove('fa-bars');
                        icon.classList.add('fa-times');
                    } else {
                        icon.classList.remove('fa-times');
                        icon.classList.add('fa-bars');
                    }
                }
            }
        }
        window.toggleMobileMenu = toggleMobileMenu;
        
        // Exposer les fonctions globalement pour les attributs onclick
        window.nextStep = nextStep;
        window.previousStep = previousStep;
        window.addLigneRFQ = addLigneRFQ;
        window.updateAdresseLivraison = updateAdresseLivraison;
        window.handleCreateRFQ = handleCreateRFQ;
    </script>
</body>
</html>

